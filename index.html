<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Luma Store OS ‚Äî Brand Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#f3f4f6;
      --panel:#ffffff;
      --panel-soft:#f9fafb;
      --border:#e5e7eb;
      --ink:#111827;
      --muted:#6b7280;
      --accent:#2563eb;
      --accent-soft:#dbeafe;
      --accent-strong:#1d4ed8;
      --radius:18px;
      --shadow:0 20px 45px rgba(15,23,42,.12);
      --status-live:#22c55e;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{
      height:100%;
      font-family:"Montserrat",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--ink);
    }
    body{
      display:flex;
      min-height:100vh;
    }
    .sidebar{
      width:240px;
      background:#ffffff;
      border-right:1px solid var(--border);
      padding:18px 16px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .brand-mark{
      display:flex;align-items:center;gap:8px;
    }
    .luma-logo-chip{
      width:30px;height:30px;border-radius:999px;
      background:linear-gradient(135deg,#2563eb,#a855f7);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:700;font-size:16px;
    }
    .brand-logo-img{
      max-height:26px;
      max-width:120px;
      object-fit:contain;
    }
    .nav-title{
      margin-top:8px;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--muted);
    }
    .nav-list{
      list-style:none;
      margin:0;padding:0;
    }
    .nav-item{
      border-radius:999px;
      padding:7px 10px;
      display:flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      color:var(--muted);
      cursor:pointer;
      margin-bottom:4px;
      transition:background .15s ease,color .15s ease;
    }
    .nav-item span.icon{
      width:18px;text-align:center;
    }
    .nav-item.active{
      background:var(--accent-soft);
      color:var(--accent-strong);
      font-weight:600;
    }
    .nav-item:hover:not(.active){
      background:#eef2ff;
      color:var(--accent-strong);
    }
    .sidebar-footer{
      margin-top:auto;
      font-size:11px;
      color:var(--muted);
      border-top:1px solid var(--border);
      padding-top:10px;
    }

    .main{
      flex:1;
      padding:18px 20px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .topbar-left{
      display:flex;
      flex-direction:column;
      gap:3px;
    }
    .brand-name{
      font-size:18px;font-weight:700;
    }
    .brand-subtitle{
      font-size:11px;color:var(--muted);
    }
    .user-chip{
      display:flex;
      align-items:center;
      gap:8px;
      background:var(--panel);
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
    }
    .user-initials{
      width:26px;height:26px;border-radius:999px;
      background:var(--accent-soft);
      display:flex;align-items:center;justify-content:center;
      font-size:12px;font-weight:600;color:var(--accent-strong);
    }
    .user-text{
      display:flex;flex-direction:column;
    }
    .user-name{
      font-size:12px;font-weight:600;
    }
    .user-role{
      font-size:10px;color:var(--muted);
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      border:none;
      border-radius:999px;
      padding:7px 12px;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      background:var(--accent);
      color:#fff;
      box-shadow:0 10px 25px rgba(37,99,235,.25);
    }
    .btn:hover{
      background:var(--accent-strong);
    }
    .btn-ghost{
      background:transparent;
      color:var(--accent-strong);
      border:1px solid var(--accent-soft);
      box-shadow:none;
    }
    .btn-ghost:hover{
      background:var(--accent-soft);
    }

    .grid{
      display:grid;
      grid-template-columns:2fr 1.5fr;
      gap:12px;
    }
    @media(max-width:900px){
      .sidebar{display:none;}
      .grid{grid-template-columns:1fr;}
      .main{padding:14px 12px;}
      .topbar{flex-direction:column;align-items:flex-start;}
    }

    .card{
      background:var(--panel);
      border-radius:var(--radius);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      padding:12px 12px 10px;
    }
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:8px;
    }
    .card-title{
      font-size:14px;font-weight:600;
    }
    .card-subtitle{
      font-size:11px;color:var(--muted);
    }
    .kpi-row{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(130px,1fr));
      gap:8px;
      margin-top:4px;
    }
    .kpi-tile{
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--panel-soft);
      padding:8px 9px;
    }
    .kpi-label{
      font-size:11px;color:var(--muted);
    }
    .kpi-value{
      margin-top:3px;font-size:16px;font-weight:700;
    }
    .kpi-sub{
      margin-top:3px;font-size:10px;color:var(--muted);
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    th,td{
      text-align:left;
      padding:6px 8px;
      border-bottom:1px solid var(--border);
    }
    thead{
      background:#f3f4f6;
    }
    th{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--muted);
    }
    tbody tr:hover{
      background:#f9fafb;
    }
    .status-dot{
      display:inline-flex;align-items:center;gap:4px;font-size:11px;
    }
    .status-dot span.dot{
      width:7px;height:7px;border-radius:999px;background:var(--status-live);
    }
    .small-muted{
      font-size:10px;color:var(--muted);
    }
    .pill{
      font-size:10px;
      padding:2px 6px;
      border-radius:999px;
      background:#eef2ff;
      color:#4f46e5;
    }
  </style>
</head>
<body>
<aside class="sidebar">
  <div class="brand-mark">
    <div class="luma-logo-chip">L</div>
    <img id="brand-logo-img" class="brand-logo-img" alt="Brand logo" style="display:none;"/>
  </div>

  <div class="nav-title">Dashboard</div>
  <ul class="nav-list">
    <li class="nav-item active" data-view="overview">
      <span class="icon">üìä</span><span>Overview</span>
    </li>
    <li class="nav-item" data-view="branches">
      <span class="icon">üè™</span><span>Branches</span>
    </li>
    <li class="nav-item" data-view="settings">
      <span class="icon">‚öôÔ∏è</span><span>Brand settings</span>
    </li>
  </ul>

  <div class="sidebar-footer">
    <div id="global-note" class="small-muted">Loading platform note‚Ä¶</div>
  </div>
</aside>

<main class="main">
  <header class="topbar">
    <div class="topbar-left">
      <div class="brand-name" id="brand-name">Brand</div>
      <div class="brand-subtitle" id="brand-subtitle">Loading brand info‚Ä¶</div>
    </div>
    <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
      <button id="btn-open-pos" class="btn-ghost">Open POS</button>
      <div class="user-chip">
        <div class="user-initials" id="user-initials">BO</div>
        <div class="user-text">
          <div class="user-name" id="user-name">Brand Owner</div>
          <div class="user-role" id="user-role">Brand Owner</div>
        </div>
      </div>
      <button id="btn-logout" class="btn-ghost">Logout</button>
    </div>
  </header>

  <!-- OVERVIEW -->
  <section id="view-overview">
    <div class="grid">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Today‚Äôs performance</div>
            <div class="card-subtitle">Key metrics for your brand.</div>
          </div>
        </div>
        <div class="kpi-row">
          <div class="kpi-tile">
            <div class="kpi-label">Sales (today)</div>
            <div class="kpi-value" id="bd-sales-today">‚Äî</div>
            <div class="kpi-sub">Sum of completed orders.</div>
          </div>
          <div class="kpi-tile">
            <div class="kpi-label">Orders (today)</div>
            <div class="kpi-value" id="bd-orders-today">‚Äî</div>
            <div class="kpi-sub">Completed orders only.</div>
          </div>
          <div class="kpi-tile">
            <div class="kpi-label">Average basket</div>
            <div class="kpi-value" id="bd-avg-basket">‚Äî</div>
            <div class="kpi-sub">Sales √∑ orders.</div>
          </div>
          <div class="kpi-tile">
            <div class="kpi-label">Active branches</div>
            <div class="kpi-value" id="bd-active-branches">‚Äî</div>
            <div class="kpi-sub">Branches marked active.</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Live status</div>
            <div class="card-subtitle">Branches & POS activity.</div>
          </div>
        </div>
        <div style="font-size:12px;">
          <div class="status-dot" id="bd-live-status">
            <span class="dot"></span><span>Monitoring POS sessions coming soon.</span>
          </div>
          <div class="small-muted" style="margin-top:4px;">
            In the next step you can add live POS session tracking per branch.
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- BRANCHES -->
  <section id="view-branches" style="display:none;">
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Branches</div>
          <div class="card-subtitle">All branches under this brand.</div>
        </div>
      </div>
      <div class="table-wrapper" style="border-radius:14px;border:1px solid var(--border);overflow:hidden;background:var(--panel-soft);">
        <table>
          <thead>
          <tr>
            <th>Name</th>
            <th>Code</th>
            <th>Status</th>
            <th>Created</th>
          </tr>
          </thead>
          <tbody id="branches-tbody">
          <tr><td colspan="4"><div style="text-align:center;padding:14px;font-size:12px;color:var(--muted);">Loading branches‚Ä¶</div></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- BRAND SETTINGS -->
  <section id="view-settings" style="display:none;">
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Brand configuration</div>
          <div class="card-subtitle">Defaults for tax, service and receipts.</div>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;">
        <div>
          <div class="card-subtitle" style="margin-bottom:4px;">Tax & service</div>
          <div style="font-size:12px;margin-bottom:4px;">
            Tax: <span id="cfg-tax">‚Äî</span>%
          </div>
          <div style="font-size:12px;margin-bottom:4px;">
            Service: <span id="cfg-service">‚Äî</span>%
          </div>
          <div class="small-muted">These values are used by POS when calculating totals.</div>
        </div>

        <div>
          <div class="card-subtitle" style="margin-bottom:4px;">Receipts</div>
          <div style="font-size:12px;margin-bottom:4px;">
            Email receipts: <span id="cfg-email">‚Äî</span>
          </div>
          <div style="font-size:12px;margin-bottom:4px;">
            WhatsApp receipts: <span id="cfg-whatsapp">‚Äî</span>
          </div>
          <div class="small-muted">Defaults can be overridden per branch later.</div>
        </div>
      </div>

      <div style="margin-top:10px;">
        <span class="small-muted">Brand configs are stored in <code>brandConfigs/{brandId}</code>. Super Admin can edit them from the control tower.</span>
      </div>
    </div>
  </section>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getFirestore,
    doc,
    getDoc,
    collection,
    getDocs
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import {
    getAuth,
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA80bAAGPuyscnTVS-zwrxE9Jp3tPiS1gM",
    authDomain: "events-339ce.firebaseapp.com",
    projectId: "events-339ce",
    storageBucket: "events-339ce.firebasestorage.app",
    messagingSenderId: "175601544315",
    appId: "1:175601544315:web:00c94b4affa972b3a286de"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const navItems = Array.from(document.querySelectorAll(".nav-item"));
  const viewOverview = document.getElementById("view-overview");
  const viewBranches = document.getElementById("view-branches");
  const viewSettings = document.getElementById("view-settings");

  const brandNameEl = document.getElementById("brand-name");
  const brandSubtitleEl = document.getElementById("brand-subtitle");
  const globalNoteEl = document.getElementById("global-note");
  const brandLogoImg = document.getElementById("brand-logo-img");
  const branchesTbody = document.getElementById("branches-tbody");

  const bdSalesTodayEl = document.getElementById("bd-sales-today");
  const bdOrdersTodayEl = document.getElementById("bd-orders-today");
  const bdAvgBasketEl = document.getElementById("bd-avg-basket");
  const bdActiveBranchesEl = document.getElementById("bd-active-branches");

  const cfgTaxEl = document.getElementById("cfg-tax");
  const cfgServiceEl = document.getElementById("cfg-service");
  const cfgEmailEl = document.getElementById("cfg-email");
  const cfgWhatsappEl = document.getElementById("cfg-whatsapp");

  const userInitialsEl = document.getElementById("user-initials");
  const userNameEl = document.getElementById("user-name");
  const userRoleEl = document.getElementById("user-role");
  const btnLogout = document.getElementById("btn-logout");
  const btnOpenPos = document.getElementById("btn-open-pos");

  function setView(view){
    navItems.forEach(item=>{
      const v = item.getAttribute("data-view");
      if(v === view) item.classList.add("active");
      else item.classList.remove("active");
    });
    viewOverview.style.display = view === "overview" ? "block" : "none";
    viewBranches.style.display = view === "branches" ? "block" : "none";
    viewSettings.style.display = view === "settings" ? "block" : "none";
  }

  navItems.forEach(item=>{
    item.addEventListener("click",()=>{
      const view = item.getAttribute("data-view");
      setView(view);
    });
  });

  function initialsFromNameOrEmail(name,email){
    if(name){
      const parts = name.split(" ").filter(Boolean);
      if(parts.length >= 2) return (parts[0][0]+parts[1][0]).toUpperCase();
      return name.slice(0,2).toUpperCase();
    }
    if(email){
      const part = email.split("@")[0] || "";
      return part.slice(0,2).toUpperCase();
    }
    return "BO";
  }

  function getQueryBrandId(){
    const params = new URLSearchParams(window.location.search);
    return params.get("brand") || null;
  }

  async function loadPlatformNoteAndLogo(){
    const settingsRef = doc(db,"platformSettings","globalConfig");
    const snap = await getDoc(settingsRef);
    if(snap.exists()){
      const data = snap.data() || {};
      globalNoteEl.textContent = data.globalNote || "No platform note at the moment.";
    }else{
      globalNoteEl.textContent = "No platform note at the moment.";
    }
  }

  async function loadBrand(brandId){
    const ref = doc(db,"brands",brandId);
    const snap = await getDoc(ref);
    if(!snap.exists()){
      brandNameEl.textContent = "Unknown brand";
      brandSubtitleEl.textContent = "This brand does not exist.";
      return;
    }
    const data = snap.data() || {};
    brandNameEl.textContent = data.name || "Unnamed brand";
    const country = data.country || "No country";
    const status = data.status || "pending_setup";
    brandSubtitleEl.textContent = `${country} ‚Ä¢ Status: ${status}`;
    if(data.logoUrl){
      brandLogoImg.src = data.logoUrl;
      brandLogoImg.style.display = "block";
    }
  }

  async function loadBrandStats(brandId){
    try{
      const ref = doc(db,"brandStats",brandId);
      const snap = await getDoc(ref);
      if(!snap.exists()){
        bdSalesTodayEl.textContent = "0";
        bdOrdersTodayEl.textContent = "0";
        bdAvgBasketEl.textContent = "0";
        return;
      }
      const data = snap.data() || {};
      const salesToday = data.salesToday ?? 0;
      const ordersToday = data.ordersToday ?? 0;
      bdSalesTodayEl.textContent = salesToday.toLocaleString(undefined,{maximumFractionDigits:0});
      bdOrdersTodayEl.textContent = ordersToday.toString();
      bdAvgBasketEl.textContent = ordersToday > 0 ? Math.round(salesToday/ordersToday).toString() : "0";
    }catch(e){
      console.error("Error loading brand stats", e);
      bdSalesTodayEl.textContent = "‚Äî";
      bdOrdersTodayEl.textContent = "‚Äî";
      bdAvgBasketEl.textContent = "‚Äî";
    }
  }

  async function loadBranches(brandId){
    try{
      const coll = collection(db,"brands",brandId,"branches");
      const snap = await getDocs(coll);
      const rows = [];
      let activeCount = 0;
      snap.forEach(docSnap=>{
        const data = docSnap.data() || {};
        const createdDate = data.createdAt ? new Date(data.createdAt.seconds*1000) : null;
        const createdStr = createdDate
          ? createdDate.toLocaleDateString(undefined,{day:"2-digit",month:"short",year:"numeric"})
          : "‚Äî";
        const isActive = data.isActive !== false;
        if(isActive) activeCount++;
        rows.push(`
          <tr>
            <td>${data.name || "Unnamed branch"}</td>
            <td>${data.code || "<span class='small-muted'>‚Äî</span>"}</td>
            <td><span class="pill">${isActive ? "Active" : "Inactive"}</span></td>
            <td><span class="small-muted">${createdStr}</span></td>
          </tr>
        `);
      });
      branchesTbody.innerHTML = rows.length ? rows.join("") :
        `<tr><td colspan="4"><div style="text-align:center;padding:14px;font-size:12px;color:var(--muted);">No branches yet.</div></td></tr>`;
      bdActiveBranchesEl.textContent = activeCount.toString();
    }catch(e){
      console.error("Error loading branches", e);
      branchesTbody.innerHTML = `<tr><td colspan="4"><div style="text-align:center;padding:14px;font-size:12px;color:var(--muted);">Error loading branches.</div></td></tr>`;
    }
  }

  async function loadBrandConfig(brandId){
    try{
      const ref = doc(db,"brandConfigs",brandId);
      const snap = await getDoc(ref);
      if(!snap.exists()){
        cfgTaxEl.textContent = "0";
        cfgServiceEl.textContent = "0";
        cfgEmailEl.textContent = "Default";
        cfgWhatsappEl.textContent = "Default";
        return;
      }
      const data = snap.data() || {};
      cfgTaxEl.textContent = (data.taxPercent ?? 0).toString();
      cfgServiceEl.textContent = (data.servicePercent ?? 0).toString();
      cfgEmailEl.textContent = (data.emailReceiptsEnabled ?? true) ? "Enabled" : "Disabled";
      cfgWhatsappEl.textContent = (data.whatsappReceiptsEnabled ?? true) ? "Enabled" : "Disabled";
    }catch(e){
      console.error("Error loading brand config", e);
    }
  }

  btnLogout.addEventListener("click",async()=>{
    try{
      await signOut(auth);
    }catch(e){
      console.error(e);
    }finally{
      window.location.href = "login.html";
    }
  });

  btnOpenPos.addEventListener("click",()=>{
    window.location.href = "pos.html";
  });

  onAuthStateChanged(auth, async (user)=>{
    if(!user){
      window.location.href = "login.html";
      return;
    }
    const platformUserRef = doc(db,"platformUsers",user.uid);
    const snap = await getDoc(platformUserRef);
    if(!snap.exists()){
      alert("Your platform user record is missing.");
      window.location.href = "login.html";
      return;
    }
    const data = snap.data() || {};
    const role = data.role || "brand_owner";
    const brandIdFromUser = data.brandId || data.brand || null;
    const brandIdFromQuery = getQueryBrandId();
    const brandId = brandIdFromQuery || brandIdFromUser;

    if(!brandId){
      alert("No brand is linked to your account.");
      window.location.href = "login.html";
      return;
    }

    if(role !== "brand_owner" && role !== "branch_manager" && role !== "super_admin"){
      alert("You do not have permission to access the brand dashboard.");
      window.location.href = "login.html";
      return;
    }

    userNameEl.textContent = data.name || user.email || "Brand user";
    userRoleEl.textContent = role.replace("_"," ");
    userInitialsEl.textContent = initialsFromNameOrEmail(data.name,user.email);

    await loadPlatformNoteAndLogo();
    await Promise.all([
      loadBrand(brandId),
      loadBrandStats(brandId),
      loadBranches(brandId),
      loadBrandConfig(brandId)
    ]);
    setView("overview");
  });
</script>
</body>
</html>
