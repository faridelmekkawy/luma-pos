<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Luma Store OS — Brand Portal</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#020617;
      --panel:#020617;
      --panel-soft:#020617;
      --ink:#e5e7eb;
      --ink-strong:#f9fafb;
      --line:rgba(148,163,184,.32);
      --muted:#9ca3af;
      --accent:#38bdf8;
      --accent-strong:#0ea5e9;
      --danger:#ef4444;
      --ok:#22c55e;
      --radius:18px;
      --shadow:0 22px 55px rgba(0,0,0,.65);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{
      height:100%;
      font-family:"Montserrat",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#020617,#000 70%);
      color:var(--ink);
    }
    body{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:16px;}

    .shell{
      width:100%;
      max-width:1100px;
      min-height:520px;
      background:radial-gradient(circle at top,#020617,#020617 55%,#000 100%);
      border-radius:26px;
      border:1px solid rgba(148,163,184,.4);
      box-shadow:var(--shadow);
      display:grid;
      grid-template-columns:minmax(0,1.2fr) minmax(0,1.6fr);
      overflow:hidden;
    }
    .side{
      padding:24px 22px;
      border-right:1px solid rgba(148,163,184,.28);
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      background:radial-gradient(circle at top,#020617,#020617 60%,#020617 100%);
    }
    .side-top{
      display:flex;
      flex-direction:column;
      gap:18px;
    }
    .brand-mark{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brand-logo{
      width:34px;height:34px;border-radius:999px;
      background:conic-gradient(from 220deg,#38bdf8,#0ea5e9,#6366f1,#38bdf8);
      display:flex;align-items:center;justify-content:center;
      font-weight:700;font-size:16px;color:#0b1220;
      box-shadow:0 0 0 1px rgba(15,23,42,.8);
    }
    .brand-text-title{
      font-size:16px;font-weight:700;color:var(--ink-strong);
    }
    .brand-text-sub{
      font-size:11px;color:var(--muted);
    }

    .side-heading{
      font-size:20px;
      font-weight:700;
      color:var(--ink-strong);
    }
    .side-desc{
      font-size:12px;
      color:var(--muted);
      max-width:270px;
      line-height:1.5;
    }
    .side-tags{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:4px;
    }
    .tag{
      font-size:10px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.45);
      background:rgba(15,23,42,.6);
    }
    .side-footer{
      font-size:10px;
      color:var(--muted);
      opacity:.9;
    }

    .main{
      padding:20px 20px 18px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .pill-tab-row{
      display:flex;
      gap:6px;
      background:rgba(15,23,42,.7);
      padding:3px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.4);
      width:max-content;
    }
    .pill-tab{
      font-size:11px;
      padding:5px 10px;
      border-radius:999px;
      cursor:pointer;
      color:var(--muted);
    }
    .pill-tab.active{
      background:#020617;
      color:var(--ink-strong);
      font-weight:600;
      box-shadow:0 0 0 1px rgba(56,189,248,.4);
    }

    .view{
      display:none;
    }
    .view.active{
      display:block;
    }

    .section-title{
      font-size:16px;
      font-weight:600;
      margin-bottom:4px;
    }
    .section-sub{
      font-size:11px;
      color:var(--muted);
      margin-bottom:12px;
    }

    .field{
      margin-bottom:10px;
    }
    .field-label{
      font-size:11px;
      margin-bottom:3px;
      color:var(--muted);
    }
    .field-input, .field-select{
      width:100%;
      padding:8px 10px;
      border-radius:11px;
      border:1px solid rgba(148,163,184,.5);
      background:rgba(15,23,42,.7);
      color:var(--ink-strong);
      font-size:12px;
    }
    .field-input::placeholder{
      color:#64748b;
    }
    .field-input:focus, .field-select:focus{
      outline:none;
      border-color:#38bdf8;
      box-shadow:0 0 0 1px rgba(56,189,248,.35);
    }
    .field-hint{
      font-size:10px;
      color:var(--muted);
      margin-top:2px;
    }

    .btn{
      border:none;
      border-radius:999px;
      padding:8px 12px;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      white-space:nowrap;
      transition:background .15s ease,transform .05s ease,box-shadow .15s ease,opacity .1s ease;
    }
    .btn-primary{
      background:linear-gradient(135deg,#38bdf8,#0ea5e9);
      color:#0b1220;
      box-shadow:0 15px 40px rgba(8,47,73,.55);
    }
    .btn-primary:hover{transform:translateY(-1px);}
    .btn-ghost{
      background:transparent;
      color:#e5e7eb;
      border:1px solid rgba(148,163,184,.4);
    }
    .btn-ghost:hover{background:rgba(15,23,42,.8);}
    .btn-danger{
      background:#b91c1c;
      color:#fee2e2;
      border:none;
    }
    .btn-danger:hover{filter:brightness(.97);}

    .alert{
      font-size:11px;
      padding:7px 9px;
      border-radius:10px;
      margin-bottom:8px;
    }
    .alert-info{
      background:rgba(37,99,235,.15);
      border:1px solid rgba(59,130,246,.6);
      color:#bfdbfe;
    }
    .alert-error{
      background:rgba(239,68,68,.12);
      border:1px solid rgba(248,113,113,.75);
      color:#fecaca;
    }
    .alert-success{
      background:rgba(22,163,74,.14);
      border:1px solid rgba(34,197,94,.7);
      color:#bbf7d0;
    }

    .login-footer{
      font-size:10px;
      color:var(--muted);
      margin-top:8px;
    }

    .dash-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }
    .dash-title-block{
      display:flex;
      flex-direction:column;
      gap:3px;
    }
    .dash-brand-name{
      font-size:16px;
      font-weight:600;
      color:var(--ink-strong);
    }
    .dash-brand-sub{
      font-size:11px;
      color:var(--muted);
    }
    .dash-chip-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:4px;
    }
    .chip{
      font-size:10px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.4);
      background:rgba(15,23,42,.8);
    }
    .chip-ok{
      border-color:rgba(34,197,94,.7);
      color:#bbf7d0;
    }
    .chip-warn{
      border-color:rgba(234,179,8,.7);
      color:#fef9c3;
    }

    .dash-card-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      gap:8px;
    }
    .kpi-card{
      border-radius:14px;
      border:1px solid rgba(148,163,184,.4);
      background:radial-gradient(circle at top left,#020617,#020617 60%,#020617 100%);
      padding:8px 10px;
    }
    .kpi-label{
      font-size:11px;
      color:var(--muted);
    }
    .kpi-value{
      font-size:17px;
      font-weight:700;
      margin-top:4px;
      color:var(--ink-strong);
    }
    .kpi-sub{
      font-size:10px;
      color:var(--muted);
      margin-top:2px;
    }

    .divider{
      margin:10px 0;
      border-top:1px dashed rgba(148,163,184,.45);
    }

    .row-between{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .small-note{
      font-size:10px;
      color:var(--muted);
    }

    @media(max-width:900px){
      body{padding:10px;}
      .shell{
        grid-template-columns:1fr;
        min-height:auto;
      }
      .side{
        border-right:none;
        border-bottom:1px solid rgba(148,163,184,.28);
      }
    }
  </style>
</head>
<body>
<div class="shell">

  <!-- LEFT SIDE -->
  <div class="side">
    <div class="side-top">
      <div class="brand-mark">
        <div class="brand-logo">L</div>
        <div>
          <div class="brand-text-title">Luma Store OS</div>
          <div class="brand-text-sub">Brand portal</div>
        </div>
      </div>
      <div>
        <div class="side-heading" id="side-heading">
          Welcome to your brand cockpit
        </div>
        <div class="side-desc" id="side-desc">
          Create your brand once, add branches and POS users, and manage stock, orders, and receipts from one clean dashboard.
        </div>
        <div class="side-tags">
          <span class="tag">Multi-branch</span>
          <span class="tag">POS users</span>
          <span class="tag">Stock & orders</span>
          <span class="tag">Email / WhatsApp receipts</span>
        </div>
      </div>
    </div>
    <div class="side-footer">
      Tip: Super Admin can also pre-create a brand shell and send you a secure signup link.  
      This page works for both **login** and **brand creation**.
    </div>
  </div>

  <!-- RIGHT SIDE -->
  <div class="main">

    <!-- Tabs (only on auth screens) -->
    <div id="auth-tabs" class="pill-tab-row" style="display:none;">
      <div class="pill-tab active" data-auth-view="login">Login</div>
      <div class="pill-tab" data-auth-view="create">Create a brand</div>
    </div>

    <!-- LOGIN / CREATE / SIGNUP VIEWS -->

    <!-- Login existing brand user -->
    <div id="view-login" class="view active">
      <div class="section-title">Login</div>
      <div class="section-sub">
        Sign in with your brand owner or branch manager email.
      </div>

      <div id="login-alert" class="alert alert-error" style="display:none;"></div>

      <div class="field">
        <div class="field-label">Email</div>
        <input id="login-email" type="email" class="field-input" placeholder="you@brand.com"/>
      </div>

      <div class="field">
        <div class="field-label">Password</div>
        <input id="login-password" type="password" class="field-input" placeholder="••••••••"/>
      </div>

      <button id="btn-login" class="btn btn-primary" style="margin-top:4px;">Login</button>

      <div class="login-footer">
        Need a brand? Click <strong>Create a brand</strong> above.  
        Got a signup link from Luma Super Admin? Open it directly — it will show a dedicated signup form.
      </div>
    </div>

    <!-- Create brand directly (self-serve) -->
    <div id="view-create" class="view">
      <div class="section-title">Create a new brand</div>
      <div class="section-sub">
        This will create a brand, a default branch, and a brand-owner user in one step.
      </div>

      <div id="create-alert" class="alert" style="display:none;"></div>

      <div class="field">
        <div class="field-label">Brand name</div>
        <input id="create-brand-name" class="field-input" placeholder="Example: Oudies"/>
      </div>

      <div class="field">
        <div class="field-label">Country</div>
        <input id="create-country" class="field-input" placeholder="Example: Egypt"/>
      </div>

      <div class="field">
        <div class="field-label">Default branch name</div>
        <input id="create-branch-name" class="field-input" placeholder="Example: District 5" />
        <div class="field-hint">You can add more branches later.</div>
      </div>

      <div class="field">
        <div class="field-label">Owner full name</div>
        <input id="create-owner-name" class="field-input" placeholder="Example: Farid Elmekkawy"/>
      </div>

      <div class="field">
        <div class="field-label">Owner email</div>
        <input id="create-owner-email" type="email" class="field-input" placeholder="owner@brand.com"/>
      </div>

      <div class="field">
        <div class="field-label">Owner password</div>
        <input id="create-owner-password" type="password" class="field-input" placeholder="Min 6 characters"/>
      </div>

      <button id="btn-create-brand" class="btn btn-primary" style="margin-top:4px;">Create brand</button>
    </div>

    <!-- Signup from Super Admin link -->
    <div id="view-signup-link" class="view">
      <div class="section-title">Complete your brand signup</div>
      <div class="section-sub" id="signup-brand-sub">
        We found your brand shell. Create your brand-owner login to continue.
      </div>

      <div id="signup-alert" class="alert" style="display:none;"></div>

      <div class="field">
        <div class="field-label">Brand</div>
        <input id="signup-brand-name" class="field-input" disabled/>
      </div>

      <div class="field">
        <div class="field-label">Your full name</div>
        <input id="signup-owner-name" class="field-input" placeholder="Example: Farid Elmekkawy"/>
      </div>

      <div class="field">
        <div class="field-label">Email</div>
        <input id="signup-owner-email" type="email" class="field-input" placeholder="owner@brand.com"/>
      </div>

      <div class="field">
        <div class="field-label">Password</div>
        <input id="signup-owner-password" type="password" class="field-input" placeholder="Min 6 characters"/>
      </div>

      <button id="btn-complete-signup" class="btn btn-primary" style="margin-top:4px;">Create account</button>

      <div class="login-footer" style="margin-top:10px;">
        This link was generated by Luma Super Admin and is tied to this specific brand.
      </div>
    </div>

    <!-- DASHBOARD (visible after auth) -->
    <div id="view-dashboard" class="view">
      <div class="dash-header">
        <div class="dash-title-block">
          <div class="dash-brand-name" id="dash-brand-name">Brand name</div>
          <div class="dash-brand-sub" id="dash-brand-sub">—</div>
          <div class="dash-chip-row">
            <div class="chip" id="chip-owner"></div>
            <div class="chip chip-ok" id="chip-status">Status: active</div>
          </div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
          <div class="row-between" style="gap:6px;">
            <button id="btn-open-pos" class="btn btn-primary">Open POS</button>
            <button id="btn-logout" class="btn btn-ghost">Logout</button>
          </div>
          <button id="btn-delete-brand" class="btn btn-danger" style="margin-top:2px;font-size:11px;padding:5px 10px;">
            Delete brand (soft delete)
          </button>
          <div class="small-note">
            Deleting marks the brand as deleted / inactive. Live POS will stop working for this brand.
          </div>
        </div>
      </div>

      <div class="dash-card-grid" style="margin-bottom:10px;">
        <div class="kpi-card">
          <div class="kpi-label">Today's sales</div>
          <div class="kpi-value" id="kpi-sales-today">0</div>
          <div class="kpi-sub">From all branches</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Today's orders</div>
          <div class="kpi-value" id="kpi-orders-today">0</div>
          <div class="kpi-sub">Completed only</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Active branches</div>
          <div class="kpi-value" id="kpi-branches">0</div>
          <div class="kpi-sub">Used in POS</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Active POS users</div>
          <div class="kpi-value" id="kpi-pos-users">0</div>
          <div class="kpi-sub">Cashiers with access</div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="row-between">
        <div>
          <div class="section-title" style="font-size:14px;">Brand quick info</div>
          <div class="small-note" id="brand-info-text"></div>
        </div>
      </div>

      <div style="margin-top:8px;">
        <div class="small-note">
          Full branches, POS users, and stock management screens can be added here later.  
          For now, this dashboard makes sure:
          <ul style="margin-top:4px;margin-left:16px;line-height:1.5;">
            <li>Brand ↔ user mapping is correct in <code>brands</code> and <code>users</code> collections.</li>
            <li>Super Admin can see this brand owner in the Platform Users table.</li>
            <li>Soft delete is possible from both Brand and Super Admin sides.</li>
          </ul>
        </div>
      </div>
    </div>

  </div> <!-- /main -->

</div> <!-- /shell -->

<!-- Firebase + Logic -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getFirestore,
    collection,
    doc,
    getDoc,
    getDocs,
    setDoc,
    updateDoc,
    serverTimestamp,
    query,
    where
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import {
    getAuth,
    onAuthStateChanged,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA80bAAGPuyscnTVS-zwrxE9Jp3tPiS1gM",
    authDomain: "events-339ce.firebaseapp.com",
    projectId: "events-339ce",
    storageBucket: "events-339ce.firebasestorage.app",
    messagingSenderId: "175601544315",
    appId: "1:175601544315:web:00c94b4affa972b3a286de"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const qs = (s)=>document.querySelector(s);
  const qsa = (s)=>Array.from(document.querySelectorAll(s));

  const authTabs = qs("#auth-tabs");
  const viewLogin = qs("#view-login");
  const viewCreate = qs("#view-create");
  const viewSignup = qs("#view-signup-link");
  const viewDashboard = qs("#view-dashboard");

  const sideHeading = qs("#side-heading");
  const sideDesc = qs("#side-desc");

  const loginAlert = qs("#login-alert");
  const loginEmail = qs("#login-email");
  const loginPassword = qs("#login-password");
  const btnLogin = qs("#btn-login");

  const createAlert = qs("#create-alert");
  const createBrandName = qs("#create-brand-name");
  const createCountry = qs("#create-country");
  const createBranchName = qs("#create-branch-name");
  const createOwnerName = qs("#create-owner-name");
  const createOwnerEmail = qs("#create-owner-email");
  const createOwnerPassword = qs("#create-owner-password");
  const btnCreateBrand = qs("#btn-create-brand");

  const signupAlert = qs("#signup-alert");
  const signupBrandName = qs("#signup-brand-name");
  const signupBrandSub = qs("#signup-brand-sub");
  const signupOwnerName = qs("#signup-owner-name");
  const signupOwnerEmail = qs("#signup-owner-email");
  const signupOwnerPassword = qs("#signup-owner-password");
  const btnCompleteSignup = qs("#btn-complete-signup");

  const dashBrandName = qs("#dash-brand-name");
  const dashBrandSub = qs("#dash-brand-sub");
  const chipOwner = qs("#chip-owner");
  const chipStatus = qs("#chip-status");
  const btnLogout = qs("#btn-logout");
  const btnOpenPos = qs("#btn-open-pos");
  const btnDeleteBrand = qs("#btn-delete-brand");

  const kpiSalesTodayEl = qs("#kpi-sales-today");
  const kpiOrdersTodayEl = qs("#kpi-orders-today");
  const kpiBranchesEl = qs("#kpi-branches");
  const kpiPosUsersEl = qs("#kpi-pos-users");
  const brandInfoText = qs("#brand-info-text");

  let currentUser = null;
  let currentBrandId = null;
  let currentBrandData = null;
  let signupBrandIdFromUrl = null;
  let signupTokenFromUrl = null;

  function setAuthView(mode){
    // hide dash
    viewDashboard.classList.remove("active");

    if(mode === "login"){
      viewLogin.classList.add("active");
      viewCreate.classList.remove("active");
      viewSignup.classList.remove("active");
      authTabs.style.display = "inline-flex";
      qsa(".pill-tab").forEach(tab=>{
        tab.classList.toggle("active",tab.dataset.authView==="login");
      });
      sideHeading.textContent = "Welcome back";
      sideDesc.textContent = "Sign in to manage your brand, branches, POS users, and stock.";
    }else if(mode === "create"){
      viewLogin.classList.remove("active");
      viewCreate.classList.add("active");
      viewSignup.classList.remove("active");
      authTabs.style.display = "inline-flex";
      qsa(".pill-tab").forEach(tab=>{
        tab.classList.toggle("active",tab.dataset.authView==="create");
      });
      sideHeading.textContent = "Create your brand";
      sideDesc.textContent = "We will create the brand doc, default branch, and a brand-owner login in one step.";
    }else if(mode === "signup-link"){
      viewLogin.classList.remove("active");
      viewCreate.classList.remove("active");
      viewSignup.classList.add("active");
      authTabs.style.display = "none";
      sideHeading.textContent = "Complete your signup";
      sideDesc.textContent = "This secure link was generated by Luma Super Admin for your brand.";
    }
  }

  qsa(".pill-tab").forEach(tab=>{
    tab.addEventListener("click",()=>{
      const v = tab.dataset.authView;
      setAuthView(v);
    });
  });

  function showAlert(el, msg, type="error"){
    if(!el) return;
    el.style.display = "block";
    el.textContent = msg;
    el.classList.remove("alert-error","alert-info","alert-success");
    if(type==="success") el.classList.add("alert-success");
    else if(type==="info") el.classList.add("alert-info");
    else el.classList.add("alert-error");
  }
  function hideAlert(el){
    if(!el) return;
    el.style.display = "none";
    el.textContent = "";
  }

  function parseQuery(){
    const p = new URLSearchParams(window.location.search);
    signupBrandIdFromUrl = p.get("brand") || null;
    signupTokenFromUrl = p.get("token") || null;
  }

  async function loadBrandById(brandId){
    if(!brandId) return null;
    const ref = doc(db,"brands",brandId);
    const snap = await getDoc(ref);
    return snap.exists() ? { id: snap.id, ...snap.data() } : null;
  }

  async function loadKpisForBrand(brandId){
    // Simple counts: branches, POS users
    try{
      const branchesRef = collection(db,"brands",brandId,"branches");
      const branchesSnap = await getDocs(branchesRef);
      let branchCount = 0;
      branchesSnap.forEach(()=>branchCount++);

      const usersRef = collection(db,"users");
      const qUsers = query(usersRef, where("brandId","==",brandId), where("role","==","cashier"));
      const usersSnap = await getDocs(qUsers);
      let posCount = 0;
      usersSnap.forEach(()=>posCount++);

      kpiBranchesEl.textContent = branchCount.toString();
      kpiPosUsersEl.textContent = posCount.toString();
    }catch(e){
      console.error("Error loading KPIs",e);
      kpiBranchesEl.textContent = "—";
      kpiPosUsersEl.textContent = "—";
    }

    // For now, we’ll leave today’s sales/orders as 0 unless you hook them to stats
    kpiSalesTodayEl.textContent = "0";
    kpiOrdersTodayEl.textContent = "0";
  }

  function showDashboard(user, brand){
    currentUser = user;
    currentBrandId = brand?.id || null;
    currentBrandData = brand || null;

    viewLogin.classList.remove("active");
    viewCreate.classList.remove("active");
    viewSignup.classList.remove("active");
    viewDashboard.classList.add("active");
    authTabs.style.display = "none";

    dashBrandName.textContent = brand?.name || "Unnamed brand";
    const country = brand?.country || "";
    const code = (brand?.defaultBranchCode || "") || "";
    dashBrandSub.textContent = country ? `${country}${code ? " • "+code : ""}` : (code || "—");

    const ownerName = brand?.ownerName || currentUser?.displayName || "Brand owner";
    const ownerEmail = brand?.ownerEmail || currentUser?.email || "";
    chipOwner.textContent = `Owner: ${ownerName}${ownerEmail ? " • "+ownerEmail : ""}`;

    const status = brand?.status || "pending_setup";
    if(status==="active"){
      chipStatus.textContent = "Status: active";
      chipStatus.classList.remove("chip-warn");
      chipStatus.classList.add("chip-ok");
    }else if(status==="deleted"){
      chipStatus.textContent = "Status: deleted";
      chipStatus.classList.remove("chip-ok");
      chipStatus.classList.add("chip-warn");
    }else{
      chipStatus.textContent = "Status: pending setup";
      chipStatus.classList.remove("chip-ok");
      chipStatus.classList.add("chip-warn");
    }

    const createdAt = brand?.createdAt?.toDate ? brand.createdAt.toDate() : null;
    const createdStr = createdAt ? createdAt.toLocaleString() : "—";
    brandInfoText.innerHTML =
      `Created: <strong>${createdStr}</strong><br/>
       Country: <strong>${brand?.country || "—"}</strong><br/>
       Owner: <strong>${ownerName}</strong>`;

    loadKpisForBrand(brand.id).catch(()=>{});
  }

  async function ensureUserDocForBrandOwner(user, brand){
    if(!user || !brand) return;
    const userRef = doc(db,"users",user.uid);
    const snap = await getDoc(userRef);
    if(!snap.exists()){
      await setDoc(userRef,{
        name: brand.ownerName || user.displayName || "",
        email: user.email || null,
        role: "brand_owner",
        brandId: brand.id,
        brandName: brand.name || "",
        status: "active",
        createdAt: serverTimestamp()
      },{merge:true});
    }else{
      const data = snap.data() || {};
      if(!data.brandId){
        await updateDoc(userRef,{
          brandId: brand.id,
          brandName: brand.name || "",
          role: data.role || "brand_owner"
        });
      }
    }

    // also map in userBrands (optional but useful)
    const ubRef = doc(db,"userBrands", user.uid + "_" + brand.id);
    await setDoc(ubRef,{
      userId: user.uid,
      brandId: brand.id,
      brandName: brand.name || "",
      role: "brand_owner",
      createdAt: serverTimestamp()
    },{merge:true});
  }

  // LOGIN FLOW
  btnLogin.addEventListener("click", async ()=>{
    hideAlert(loginAlert);
    const email = loginEmail.value.trim();
    const pass = loginPassword.value;
    if(!email || !pass){
      showAlert(loginAlert,"Enter email and password.");
      return;
    }
    try{
      btnLogin.disabled = true;
      btnLogin.textContent = "Logging in…";
      const cred = await signInWithEmailAndPassword(auth,email,pass);
      // onAuthStateChanged will handle the rest
    }catch(e){
      console.error("Login error",e);
      showAlert(loginAlert,"Invalid email or password.","error");
    }finally{
      btnLogin.disabled = false;
      btnLogin.textContent = "Login";
    }
  });

  // CREATE BRAND SELF-SERVE
  btnCreateBrand.addEventListener("click", async ()=>{
    hideAlert(createAlert);
    const bName = createBrandName.value.trim();
    const country = createCountry.value.trim() || null;
    const branchName = createBranchName.value.trim() || "Main Branch";
    const ownerName = createOwnerName.value.trim();
    const ownerEmail = createOwnerEmail.value.trim();
    const ownerPassword = createOwnerPassword.value;

    if(!bName || !ownerName || !ownerEmail || !ownerPassword){
      showAlert(createAlert,"Please fill brand name, owner name, email and password.","error");
      return;
    }
    if(ownerPassword.length < 6){
      showAlert(createAlert,"Password must be at least 6 characters.","error");
      return;
    }

    try{
      btnCreateBrand.disabled = true;
      btnCreateBrand.textContent = "Creating…";

      const ownerCred = await createUserWithEmailAndPassword(auth,ownerEmail,ownerPassword);

      const brandRef = doc(collection(db,"brands"));
      const brandId = brandRef.id;

      await setDoc(brandRef,{
        name: bName,
        country,
        status:"active",
        isActive:true,
        createdAt: serverTimestamp(),
        ownerUserId: ownerCred.user.uid,
        ownerEmail: ownerEmail,
        ownerName: ownerName,
        sendEmail:true,
        sendWhatsApp:false
      });

      // default branch
      const branchRef = doc(collection(brandRef,"branches"));
      await setDoc(branchRef,{
        name: branchName,
        code:"MAIN",
        isActive:true,
        createdAt: serverTimestamp()
      });

      // users/{uid}
      const userRef = doc(db,"users",ownerCred.user.uid);
      await setDoc(userRef,{
        name: ownerName,
        email: ownerEmail,
        role: "brand_owner",
        brandId: brandId,
        brandName: bName,
        status:"active",
        createdAt: serverTimestamp()
      },{merge:true});

      const ubRef = doc(db,"userBrands", ownerCred.user.uid + "_" + brandId);
      await setDoc(ubRef,{
        userId: ownerCred.user.uid,
        brandId,
        brandName: bName,
        role: "brand_owner",
        createdAt: serverTimestamp()
      },{merge:true});

      showAlert(createAlert,"Brand created successfully. Loading dashboard…","success");
      // onAuthStateChanged will fire and load dashboard
    }catch(e){
      console.error("Create brand error",e);
      showAlert(createAlert,"Failed to create brand. Check console for details.","error");
    }finally{
      btnCreateBrand.disabled = false;
      btnCreateBrand.textContent = "Create brand";
    }
  });

  // SIGNUP FROM SUPER ADMIN LINK
  btnCompleteSignup.addEventListener("click", async ()=>{
    hideAlert(signupAlert);
    const ownerName = signupOwnerName.value.trim();
    const ownerEmail = signupOwnerEmail.value.trim();
    const ownerPassword = signupOwnerPassword.value;

    if(!ownerName || !ownerEmail || !ownerPassword){
      showAlert(signupAlert,"Fill your name, email, and password.","error");
      return;
    }
    if(ownerPassword.length < 6){
      showAlert(signupAlert,"Password must be at least 6 characters.","error");
      return;
    }
    if(!signupBrandIdFromUrl || !signupTokenFromUrl){
      showAlert(signupAlert,"Missing brand or token in URL.","error");
      return;
    }

    try{
      btnCompleteSignup.disabled = true;
      btnCompleteSignup.textContent = "Creating account…";

      const brand = await loadBrandById(signupBrandIdFromUrl);
      if(!brand){
        showAlert(signupAlert,"Brand not found. Ask Super Admin to resend the link.","error");
        return;
      }
      if(brand.signupToken && brand.signupToken !== signupTokenFromUrl){
        showAlert(signupAlert,"This signup link is invalid or has already been used.","error");
        return;
      }
      if(brand.ownerUserId){
        showAlert(signupAlert,"This brand already has an owner. Please login instead.","error");
        return;
      }

      const cred = await createUserWithEmailAndPassword(auth,ownerEmail,ownerPassword);

      const brandRef = doc(db,"brands",brand.id);
      await updateDoc(brandRef,{
        ownerUserId: cred.user.uid,
        ownerEmail: ownerEmail,
        ownerName: ownerName,
        status:"active",
        isActive:true,
        signupToken: signupTokenFromUrl,
        signupCompletedAt: serverTimestamp()
      });

      const userRef = doc(db,"users",cred.user.uid);
      await setDoc(userRef,{
        name: ownerName,
        email: ownerEmail,
        role: "brand_owner",
        brandId: brand.id,
        brandName: brand.name || "",
        status:"active",
        createdAt: serverTimestamp()
      },{merge:true});

      const ubRef = doc(db,"userBrands", cred.user.uid + "_" + brand.id);
      await setDoc(ubRef,{
        userId: cred.user.uid,
        brandId: brand.id,
        brandName: brand.name || "",
        role: "brand_owner",
        createdAt: serverTimestamp()
      },{merge:true});

      showAlert(signupAlert,"Account created. Loading dashboard…","success");
      // onAuthStateChanged will catch and show dashboard
    }catch(e){
      console.error("Signup link error",e);
      showAlert(signupAlert,"Failed to create account. Check console for details.","error");
    }finally{
      btnCompleteSignup.disabled = false;
      btnCompleteSignup.textContent = "Create account";
    }
  });

  // LOGOUT
  if(btnLogout){
    btnLogout.addEventListener("click", async ()=>{
      try{
        await signOut(auth);
      }catch(e){
        console.error("Logout error",e);
      }
    });
  }

  // OPEN POS (you can adapt the URL)
  if(btnOpenPos){
    btnOpenPos.addEventListener("click", ()=>{
      if(!currentBrandId) return;
      // Example POS URL, adapt to your deployment:
      window.location.href = "/pos.html?brand="+encodeURIComponent(currentBrandId);
    });
  }

  // SOFT DELETE BRAND
  if(btnDeleteBrand){
    btnDeleteBrand.addEventListener("click", async ()=>{
      if(!currentBrandId) return;
      const sure = confirm("Are you sure you want to delete (soft delete) this brand? POS will stop working.");
      if(!sure) return;
      try{
        btnDeleteBrand.disabled = true;
        const brandRef = doc(db,"brands",currentBrandId);
        await updateDoc(brandRef,{
          status:"deleted",
          isActive:false,
          deletedAt: serverTimestamp()
        });
        chipStatus.textContent = "Status: deleted";
        chipStatus.classList.remove("chip-ok");
        chipStatus.classList.add("chip-warn");
        alert("Brand marked as deleted. Super Admin will also see this.");
      }catch(e){
        console.error("Delete brand error",e);
        alert("Failed to delete brand. Check console.");
      }finally{
        btnDeleteBrand.disabled = false;
      }
    });
  }

  // AUTH STATE
  onAuthStateChanged(auth, async (user)=>{
    parseQuery();

    if(signupBrandIdFromUrl && signupTokenFromUrl && !user){
      // Coming from Super Admin signup link
      try{
        const brand = await loadBrandById(signupBrandIdFromUrl);
        if(!brand){
          showAlert(signupAlert,"Brand not found. Ask Super Admin to resend the link.","error");
        }else{
          signupBrandName.value = brand.name || "(no name)";
          signupBrandSub.textContent = `Brand: ${brand.name || "Unnamed"} • Country: ${brand.country || "—"}`;
        }
      }catch(e){
        console.error("Error loading brand for signup",e);
      }
      setAuthView("signup-link");
      return;
    }

    if(!user){
      currentUser = null;
      currentBrandId = null;
      currentBrandData = null;

      // Default: show login/create toggle
      setAuthView("login");
      return;
    }

    // User is logged in => find their brand
    currentUser = user;

    try{
      const userRef = doc(db,"users",user.uid);
      const userSnap = await getDoc(userRef);

      let brandId = null;
      let role = null;

      if(userSnap.exists()){
        const data = userSnap.data() || {};
        brandId = data.brandId || null;
        role = data.role || null;
      }

      // If we logged in immediately after completing signup with URL brand,
      // we may need to use that brand if user doc not yet populated.
      if(!brandId && signupBrandIdFromUrl){
        brandId = signupBrandIdFromUrl;
      }

      // If still no brandId, we try to find one via userBrands
      if(!brandId){
        const ubRef = collection(db,"userBrands");
        const qUb = query(ubRef, where("userId","==",user.uid));
        const ubSnap = await getDocs(qUb);
        ubSnap.forEach(docSnap=>{
          if(!brandId){
            const d = docSnap.data() || {};
            brandId = d.brandId || null;
          }
        });
      }

      if(!brandId){
        // fallback: send user back to create brand
        setAuthView("create");
        showAlert(createAlert,"We couldn't find a brand linked to this account. Create a brand now.","info");
        return;
      }

      const brand = await loadBrandById(brandId);
      if(!brand){
        setAuthView("create");
        showAlert(createAlert,"Brand doc not found. Create a new brand or contact Luma.","error");
        return;
      }

      await ensureUserDocForBrandOwner(user,brand);
      showDashboard(user,brand);
    }catch(e){
      console.error("Error in auth state handling",e);
      setAuthView("login");
      showAlert(loginAlert,"Error loading your brand. Try again.","error");
    }
  });
</script>
</body>
</html>
