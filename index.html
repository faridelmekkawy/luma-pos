<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport"content="width=device-width,initial-scale=1"/>
  <title>Luma Store OS ‚Äî Brand Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap"rel="stylesheet"/>

  <style>
    :root{
      --bg:#f3f4f6;
      --panel:#ffffff;
      --panel-soft:#f9fafb;
      --ink:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --accent:#2563eb;
      --accent-soft:#dbeafe;
      --accent-strong:#1d4ed8;
      --radius:16px;
      --shadow:0 18px 40px rgba(15,23,42,.1);
      --danger:#ef4444;
      --ok:#16a34a;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{
      height:100%;
      font-family:"Montserrat",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--ink);
    }

    /* AUTH SCREENS */
    .auth-wrapper{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .auth-card{
      width:100%;
      max-width:380px;
      background:var(--panel);
      border-radius:20px;
      border:1px solid var(--border);
      box-shadow:0 18px 40px rgba(15,23,42,.12);
      padding:20px 18px 16px;
    }
    .auth-header{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .auth-logo{
      width:32px;height:32px;border-radius:999px;
      background:linear-gradient(135deg,#2563eb,#a855f7);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:700;font-size:16px;
    }
    .auth-title-block{
      display:flex;flex-direction:column;gap:2px;
    }
    .auth-title{font-size:16px;font-weight:700;}
    .auth-subtitle{font-size:11px;color:var(--muted);}
    .auth-label{
      font-size:11px;margin-bottom:4px;color:#4b5563;
    }
    .auth-input{
      width:100%;padding:8px 10px;border-radius:10px;
      border:1px solid var(--border);background:var(--panel-soft);
      font-size:12px;margin-bottom:8px;
    }
    .auth-input:focus{
      outline:none;border-color:var(--accent);
      box-shadow:0 0 0 1px var(--accent-soft);
    }
    .auth-btn{
      width:100%;border:none;border-radius:999px;
      padding:8px 10px;background:var(--accent);color:#fff;
      font-size:13px;font-weight:600;cursor:pointer;
      display:flex;align-items:center;justify-content:center;gap:6px;
      margin-top:4px;
      box-shadow:0 10px 25px rgba(37,99,235,.25);
      transition:background .15s,transform .05s,box-shadow .15s;
    }
    .auth-btn:hover{
      background:var(--accent-strong);
      transform:translateY(-1px);
      box-shadow:0 14px 30px rgba(37,99,235,.25);
    }
    .auth-helper{margin-top:10px;font-size:11px;color:var(--muted);}
    .auth-error{
      font-size:11px;margin-top:6px;padding:6px 8px;border-radius:9px;
      background:#fef2f2;color:#b91c1c;border:1px solid:#fecaca;display:none;
    }

    /* APP LAYOUT */
    #app-shell{min-height:100vh;display:none;}
    .sidebar{
      width:250px;background:#ffffff;border-right:1px solid var(--border);
      display:flex;flex-direction:column;padding:18px 16px;
    }
    .brand-mark{
      display:flex;align-items:center;gap:10px;margin-bottom:18px;
    }
    .brand-mark-logo{
      width:32px;height:32px;border-radius:999px;
      background:#eef2ff;
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;
    }
    .brand-mark-logo img{max-width:32px;max-height:32px;object-fit:contain;}
    .brand-mark-logo span{font-size:15px;font-weight:700;color:#4f46e5;}
    .brand-mark-text-title{font-size:15px;font-weight:700;}
    .brand-mark-text-sub{font-size:11px;color:var(--muted);}
    .nav-section-title{
      font-size:11px;text-transform:uppercase;letter-spacing:.12em;
      color:var(--muted);margin:6px 0 4px;
    }
    .nav-list{list-style:none;margin:0;padding:0;}
    .nav-item{
      border-radius:999px;padding:8px 11px;display:flex;align-items:center;
      gap:7px;font-size:13px;color:var(--muted);cursor:pointer;
      margin-bottom:4px;transition:background .15s,color .15s;
    }
    .nav-item span.icon{width:18px;text-align:center;font-size:14px;}
    .nav-item.active{
      background:var(--accent-soft);color:var(--accent-strong);font-weight:600;
    }
    .nav-item:hover:not(.active){
      background:#f3f4ff;color:var(--accent-strong);
    }
    .sidebar-footer{
      margin-top:auto;font-size:11px;color:var(--muted);
      border-top:1px solid var(--border);padding-top:8px;
    }

    .main{
      flex:1;display:flex;flex-direction:column;padding:18px 20px;gap:12px;
    }
    .topbar{
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;flex-wrap:wrap;
    }
    .page-title{font-size:18px;font-weight:700;}
    .page-subtitle{font-size:12px;color:var(--muted);margin-top:2px;}
    .user-chip{
      display:flex;align-items:center;gap:7px;background:var(--panel);
      border-radius:999px;padding:6px 9px;border:1px solid var(--border);
    }
    .user-chip-avatar{
      width:26px;height:26px;border-radius:999px;
      background:var(--accent-soft);display:flex;align-items:center;
      justify-content:center;font-size:12px;font-weight:600;
      color:var(--accent-strong);
    }
    .user-chip-text{display:flex;flex-direction:column;}
    .user-chip-name{font-size:12px;font-weight:600;}
    .user-chip-role{font-size:10px;color:var(--muted);}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:6px;
      border-radius:999px;border:none;padding:6px 10px;
      font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap;
      transition:background .15s,box-shadow .15s,transform .05s;
    }
    .btn-primary{
      background:var(--accent);color:#fff;
      box-shadow:0 10px 25px rgba(37,99,235,.25);
    }
    .btn-primary:hover{
      background:var(--accent-strong);transform:translateY(-1px);
      box-shadow:0 14px 30px rgba(37,99,235,.25);
    }
    .btn-ghost{
      background:transparent;color:var(--accent-strong);
      border:1px solid var(--accent-soft);
    }
    .btn-ghost:hover{background:var(--accent-soft);}
    .btn-icon{
      padding:4px 7px;border-radius:999px;border:1px solid var(--border);
      background:var(--panel);cursor:pointer;font-size:13px;
    }
    .btn-icon:hover{background:var(--panel-soft);}
    .btn-danger{
      background:var(--danger);color:#fff;border:none;
    }
    .btn-danger:hover{filter:brightness(.95);}
    .btn-mini{
      font-size:11px;padding:3px 7px;border-radius:999px;
      border:1px solid var(--border);background:var(--panel-soft);
      cursor:pointer;
    }
    .btn-mini:hover{background:#e5e7eb;}

    .card{
      background:var(--panel);border-radius:var(--radius);
      border:1px solid var(--border);box-shadow:var(--shadow);
      padding:12px 14px;
    }
    .card-header{
      display:flex;align-items:center;justify-content:space-between;
      flex-wrap:wrap;gap:8px;margin-bottom:8px;
    }
    .card-title{font-size:14px;font-weight:600;}
    .card-subtitle{font-size:11px;color:var(--muted);margin-top:2px;}

    .overview-grid{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));
      gap:10px;
    }
    .kpi-card{
      background:var(--panel);border-radius:14px;border:1px solid var(--border);
      padding:9px 11px;box-shadow:0 14px 30px rgba(15,23,42,.08);
    }
    .kpi-label{font-size:11px;color:var(--muted);}
    .kpi-value{margin-top:4px;font-size:17px;font-weight:700;}
    .kpi-sub{margin-top:3px;font-size:10px;color:var(--muted);}

    .content-area{display:flex;flex-direction:column;gap:10px;}
    .toolbar{
      display:flex;align-items:center;justify-content:space-between;
      flex-wrap:wrap;gap:8px;
    }
    .toolbar-left,.toolbar-right{
      display:flex;align-items:center;gap:8px;flex-wrap:wrap;
    }
    .pill{
      font-size:11px;padding:3px 8px;border-radius:999px;
      background:var(--panel-soft);color:var(--muted);
      border:1px solid var(--border);
    }
    .search-input{
      border-radius:999px;border:1px solid var(--border);
      background:var(--panel);padding:6px 9px;font-size:12px;min-width:190px;
    }
    .search-input:focus{
      outline:none;border-color:var(--accent);
      box-shadow:0 0 0 1px var(--accent-soft);
    }

    .table-wrapper{
      border-radius:calc(var(--radius) - 4px);border:1px solid var(--border);
      overflow:hidden;background:var(--panel-soft);
    }
    table{width:100%;border-collapse:collapse;font-size:12px;}
    thead{background:#f3f4f6;}
    th,td{
      padding:7px 9px;text-align:left;border-bottom:1px solid var(--border);
      vertical-align:middle;
    }
    th{
      font-size:11px;text-transform:uppercase;letter-spacing:.08em;
      color:var(--muted);
    }
    tbody tr:hover{background:#f9fafb;}
    .muted{font-size:11px;color:var(--muted);}
    .badge{
      font-size:10px;padding:2px 6px;border-radius:999px;
      background:#e5e7eb;color:#374151;
    }

    .status-pill{
      font-size:11px;padding:3px 8px;border-radius:999px;
      display:inline-flex;align-items:center;gap:4px;
    }
    .status-ok{background:#dcfce7;color:#16a34a;}
    .status-warn{background:#fef9c3;color:#ca8a04;}
    .status-bad{background:#fee2e2;color:#b91c1c;}

    .empty-state{
      text-align:center;padding:20px 10px;font-size:12px;color:var(--muted);
    }

    .alert{
      font-size:11px;padding:6px 8px;border-radius:9px;margin-bottom:7px;
    }
    .alert-info{
      background:#eff6ff;color:#1d4ed8;border:1px solid #bfdbfe;
    }
    .alert-error{
      background:#fef2f2;color:#b91c1c;border:1px solid #fecaca;
    }
    .alert-success{
      background:#ecfdf5;color:#15803d;border:1px solid #bbf7d0;
    }

    .field{margin-bottom:8px;}
    .field-label{
      font-size:11px;margin-bottom:3px;color:#4b5563;
    }
    .field-input,.field-textarea{
      width:100%;padding:7px 9px;border-radius:9px;
      border:1px solid var(--border);background:var(--panel-soft);
      font-size:12px;
    }
    .field-textarea{resize:vertical;min-height:70px;}
    .field-input:focus,.field-textarea:focus{
      outline:none;border-color:var(--accent);
      box-shadow:0 0 0 1px var(--accent-soft);
    }
    .field-hint{font-size:10px;color:var(--muted);margin-top:2px;}

    .variant-group-header{
      display:flex;align-items:center;justify-content:space-between;
      gap:8px;margin-bottom:4px;
    }
    .variant-label-row{
      display:grid;grid-template-columns:1.3fr 0.7fr 0.7fr 0.9fr auto;
      gap:6px;margin-bottom:4px;
    }
    .variant-small-input{
      width:100%;padding:5px 7px;border-radius:8px;
      border:1px solid var(--border);background:var(--panel);font-size:11px;
    }
    .variant-small-input:focus{
      outline:none;border-color:var(--accent);
      box-shadow:0 0 0 1px var(--accent-soft);
    }

    .logo-preview-box{
      display:flex;align-items:center;gap:10px;
      padding:8px;border-radius:10px;border:1px dashed var(--border);
      background:var(--panel-soft);min-height:52px;
    }
    .logo-preview-img{
      max-height:40px;max-width:140px;object-fit:contain;
    }
    .logo-preview-placeholder{
      font-size:11px;color:var(--muted);
    }

    /* MODAL */
    .modal-backdrop{
      position:fixed;inset:0;background:rgba(15,23,42,.4);
      display:none;align-items:center;justify-content:center;z-index:50;
    }
    .modal-backdrop.show{display:flex;}
    .modal{
      width:100%;max-width:480px;background:var(--panel);
      border-radius:18px;border:1px solid var(--border);
      box-shadow:0 22px 55px rgba(15,23,42,.4);
      padding:14px 15px 12px;
    }
    .modal-header{
      display:flex;align-items:flex-start;justify-content:space-between;
      gap:8px;margin-bottom:8px;
    }
    .modal-title{font-size:15px;font-weight:600;}
    .modal-subtitle{font-size:11px;color:var(--muted);margin-top:2px;}
    .modal-close{
      border:none;background:transparent;cursor:pointer;
      font-size:16px;color:var(--muted);
    }
    .modal-footer{
      display:flex;justify-content:flex-end;gap:6px;margin-top:8px;
    }

    @media(max-width:900px){
      .sidebar{display:none;}
      .main{padding:14px 12px;}
      .topbar{flex-direction:column;align-items:flex-start;}
      .toolbar{flex-direction:column;align-items:flex-start;}
    }
  </style>
</head>
<body>

  <!-- LOGIN -->
  <div id="login-screen" class="auth-wrapper">
    <div class="auth-card">
      <div class="auth-header">
        <div class="auth-logo">L</div>
        <div class="auth-title-block">
          <div class="auth-title">Luma Store OS</div>
          <div class="auth-subtitle">Brand login</div>
        </div>
      </div>
      <div>
        <label for="login-email" class="auth-label">Email</label>
        <input id="login-email" type="email" class="auth-input" placeholder="you@brand.com"/>
        <label for="login-password" class="auth-label">Password</label>
        <input id="login-password" type="password" class="auth-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
        <button id="login-btn" class="auth-btn">Login</button>
        <div id="login-error" class="auth-error"></div>
        <div class="auth-helper">
          Use the email & password of your brand owner or manager account.  
          If you received a special signup link, use that link first to create your account.
        </div>
      </div>
    </div>
  </div>

  <!-- OWNER SIGNUP (when opened with ?brand=..&token=..) -->
  <div id="signup-screen" class="auth-wrapper" style="display:none;">
    <div class="auth-card">
      <div class="auth-header">
        <div class="auth-logo">L</div>
        <div class="auth-title-block">
          <div class="auth-title">Brand owner setup</div>
          <div class="auth-subtitle" id="signup-brand-label">Connecting brand‚Ä¶</div>
        </div>
      </div>
      <div id="signup-alert" class="auth-error" style="display:none;"></div>
      <div>
        <label class="auth-label" for="signup-name">Your name</label>
        <input id="signup-name" class="auth-input" placeholder="Full name"/>

        <label class="auth-label" for="signup-email">Email</label>
        <input id="signup-email" type="email" class="auth-input" placeholder="you@brand.com"/>

        <label class="auth-label" for="signup-password">Password</label>
        <input id="signup-password" type="password" class="auth-input" placeholder="Choose a strong password"/>

        <button id="signup-btn" class="auth-btn">Create owner account</button>
        <div class="auth-helper">
          This will create your brand owner account and connect it to this brand.
        </div>
      </div>
    </div>
  </div>

  <!-- APP SHELL -->
  <div id="app-shell" style="display:none;">
    <aside class="sidebar">
      <div class="brand-mark">
        <div class="brand-mark-logo" id="brand-logo-badge">
          <span id="brand-logo-initials">B</span>
        </div>
        <div>
          <div class="brand-mark-text-title" id="brand-name-sidebar">Brand</div>
          <div class="brand-mark-text-sub" id="brand-subtitle-sidebar">Luma brand dashboard</div>
        </div>
      </div>

      <div>
        <div class="nav-section-title">Dashboard</div>
        <ul class="nav-list">
          <li class="nav-item active" data-view="overview"><span class="icon">üìä</span><span>Overview</span></li>
          <li class="nav-item" data-view="products"><span class="icon">üì¶</span><span>Products & stock</span></li>
          <li class="nav-item" data-view="customers"><span class="icon">üë•</span><span>Customers</span></li>
          <li class="nav-item" data-view="settings"><span class="icon">‚öôÔ∏è</span><span>Brand settings</span></li>
        </ul>
      </div>

      <div class="sidebar-footer">
        <div>Signed in as:</div>
        <div id="sidebar-user-email" style="font-size:11px;font-weight:600;">‚Äî</div>
        <div style="margin-top:3px;">Role: <span class="badge" id="sidebar-user-role">‚Äî</span></div>
      </div>
    </aside>

    <main class="main">
      <header class="topbar">
        <div>
          <div class="page-title" id="page-title">Overview</div>
          <div class="page-subtitle" id="page-subtitle">
            Sales, orders and stock summary for this brand.
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
          <div class="user-chip">
            <div class="user-chip-avatar" id="user-avatar">BO</div>
            <div class="user-chip-text">
              <div class="user-chip-name" id="user-name">Brand Owner</div>
              <div class="user-chip-role" id="user-role-label">Brand owner</div>
            </div>
          </div>
          <button id="logout-btn" class="btn btn-ghost">Logout</button>
        </div>
      </header>

      <!-- OVERVIEW -->
      <section id="view-overview" class="content-area">
        <div class="overview-grid">
          <div class="kpi-card">
            <div class="kpi-label">Sales today</div>
            <div class="kpi-value" id="kpi-sales-today">0</div>
            <div class="kpi-sub">Completed orders (net of returns)</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Orders today</div>
            <div class="kpi-value" id="kpi-orders-today">0</div>
            <div class="kpi-sub">All orders created today</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Total products</div>
            <div class="kpi-value" id="kpi-products">0</div>
            <div class="kpi-sub">Active products in this brand</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Total stock units</div>
            <div class="kpi-value" id="kpi-stock-units">0</div>
            <div class="kpi-sub">Sum of all variant quantities</div>
          </div>
        </div>
      </section>

      <!-- PRODUCTS -->
      <section id="view-products" class="content-area" style="display:none;">
        <div class="toolbar">
          <div class="toolbar-left">
            <span class="pill">Products & stock</span>
            <span class="muted">Manage items visible in POS.</span>
          </div>
          <div class="toolbar-right">
            <input id="products-search" class="search-input" placeholder="Search product name or SKU‚Ä¶"/>
            <button id="products-refresh" class="btn-icon" title="Refresh">‚ü≥</button>
            <button id="btn-add-product" class="btn btn-primary">+ New product</button>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Products list</div>
              <div class="card-subtitle">Stock here will match the POS stock exactly.</div>
            </div>
          </div>
          <div id="products-table-wrapper" class="table-wrapper">
            <table>
              <thead>
              <tr>
                <th>Product</th>
                <th>Variants</th>
                <th>Stock total</th>
                <th>Price range</th>
                <th style="text-align:right;">Actions</th>
              </tr>
              </thead>
              <tbody id="products-tbody">
              <tr><td colspan="5"><div class="empty-state">Loading products‚Ä¶</div></td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- CUSTOMERS -->
      <section id="view-customers" class="content-area" style="display:none;">
        <div class="toolbar">
          <div class="toolbar-left">
            <span class="pill">Customers</span>
          </div>
          <div class="toolbar-right">
            <input id="customers-search" class="search-input" placeholder="Search name, email or phone‚Ä¶"/>
            <button id="customers-refresh" class="btn-icon" title="Refresh">‚ü≥</button>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Saved customers</div>
              <div class="card-subtitle">Customers created from POS with phone or email.</div>
            </div>
          </div>
          <div class="table-wrapper">
            <table>
              <thead>
              <tr>
                <th>Name</th>
                <th>Contact</th>
                <th>Last updated</th>
              </tr>
              </thead>
              <tbody id="customers-tbody">
              <tr><td colspan="3"><div class="empty-state">Loading customers‚Ä¶</div></td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- SETTINGS -->
      <section id="view-settings" class="content-area" style="display:none;">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Brand settings</div>
              <div class="card-subtitle">Logo, contact info and dangerous actions.</div>
            </div>
          </div>

          <div id="settings-alert-container"></div>

          <div class="field">
            <div class="field-label">Brand name</div>
            <input id="setting-brand-name" class="field-input" placeholder="Brand name"/>
          </div>

          <div class="field">
            <div class="field-label">Country</div>
            <input id="setting-country" class="field-input" placeholder="Country"/>
          </div>

          <div class="field">
            <div class="field-label">Owner email</div>
            <input id="setting-owner-email" class="field-input" placeholder="Owner email"/>
          </div>

          <div class="field">
            <div class="field-label">Brand logo (for POS & dashboard)</div>
            <input id="setting-logo-file" type="file" class="field-input" accept="image/*"/>
            <div class="field-hint">Upload a PNG or JPG. This logo will appear on POS and receipts.</div>
          </div>

          <div class="field">
            <div class="field-label">Current logo</div>
            <div class="logo-preview-box">
              <img id="brand-logo-preview" class="logo-preview-img" style="display:none;" alt="Brand logo preview"/>
              <span id="brand-logo-placeholder" class="logo-preview-placeholder">No logo uploaded.</span>
            </div>
          </div>

          <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
            <button id="btn-save-settings" class="btn btn-primary">Save brand settings</button>
            <span class="muted" id="settings-status">Not saved yet.</span>
          </div>
        </div>

        <div class="card" style="margin-top:10px;border-color:#fecaca;">
          <div class="card-header">
            <div>
              <div class="card-title" style="color:#b91c1c;">Danger zone</div>
              <div class="card-subtitle">
                Delete this brand from Luma Store OS. This is a soft delete: POS users and orders keep their data, but the brand is hidden.
              </div>
            </div>
          </div>
          <div class="alert alert-info">
            Deleting a brand sets its status to <strong>deleted</strong> and <strong>isActive = false</strong>.  
            It will disappear from normal lists in Super Admin and Brand portals.
          </div>
          <button id="btn-delete-brand" class="btn btn-danger">Delete brand</button>
        </div>
      </section>
    </main>
  </div>

  <!-- PRODUCT MODAL -->
  <div id="product-modal-backdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <div>
          <div class="modal-title" id="product-modal-title">New product</div>
          <div class="modal-subtitle">This product will appear in POS after you save.</div>
        </div>
        <button id="product-modal-close" class="modal-close">&times;</button>
      </div>

      <div id="product-modal-alert"></div>

      <div class="field">
        <div class="field-label">Product name</div>
        <input id="prod-name" class="field-input" placeholder="Example: Hoodie"/>
      </div>

      <div class="field">
        <div class="field-label">SKU / code (optional)</div>
        <input id="prod-sku" class="field-input" placeholder="Internal reference code"/>
      </div>

      <div class="field">
        <div class="field-label">Base price</div>
        <input id="prod-base-price" type="number" step="0.01" min="0" class="field-input" placeholder="Base price in EGP"/>
        <div class="field-hint">Variants can override this price individually.</div>
      </div>

      <div class="field">
        <div class="field-label">Product image</div>
        <input id="prod-image-file" type="file" class="field-input" accept="image/*"/>
        <div class="field-hint">Shown in POS. Optional but recommended.</div>
      </div>

      <div class="field">
        <div class="field-label">Variant group name</div>
        <div class="variant-group-header">
          <input id="variant-group-name" class="field-input" placeholder="Example: Size"/>
        </div>
        <div class="field-hint">Old style you asked for: one group (e.g., Size) and multiple labels below (S, M, L‚Ä¶).</div>
      </div>

      <div class="field">
        <div class="field-label">Variant labels</div>
        <div id="variant-labels-container"></div>
        <button id="btn-add-variant-label" type="button" class="btn-mini">+ Add label</button>
        <div class="field-hint">
          Each label is what appears in POS selector (for example: ‚ÄúSmall‚Äù, ‚ÄúMedium‚Äù, ‚ÄúLarge‚Äù).
        </div>
      </div>

      <div class="modal-footer">
        <button id="product-modal-cancel" type="button" class="btn btn-ghost">Cancel</button>
        <button id="product-modal-save" type="button" class="btn btn-primary">Save product</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore,
      collection,
      doc,
      getDoc,
      getDocs,
      setDoc,
      updateDoc,
      deleteDoc,
      query,
      orderBy,
      where,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getStorage,
      ref as storageRef,
      uploadBytes,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA80bAAGPuyscnTVS-zwrxE9Jp3tPiS1gM",
      authDomain: "events-339ce.firebaseapp.com",
      projectId: "events-339ce",
      storageBucket: "events-339ce.firebasestorage.app",
      messagingSenderId: "175601544315",
      appId: "1:175601544315:web:00c94b4affa972b3a286de"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    const qs = (sel)=>document.querySelector(sel);
    const qsa = (sel)=>Array.from(document.querySelectorAll(sel));

    // Screens
    const loginScreen = qs("#login-screen");
    const signupScreen = qs("#signup-screen");
    const appShell = qs("#app-shell");

    // Login elements
    const loginEmail = qs("#login-email");
    const loginPassword = qs("#login-password");
    const loginBtn = qs("#login-btn");
    const loginError = qs("#login-error");

    // Signup elements
    const signupBrandLabel = qs("#signup-brand-label");
    const signupName = qs("#signup-name");
    const signupEmail = qs("#signup-email");
    const signupPassword = qs("#signup-password");
    const signupBtn = qs("#signup-btn");
    const signupAlert = qs("#signup-alert");

    // App shell elements
    const pageTitleEl = qs("#page-title");
    const pageSubtitleEl = qs("#page-subtitle");
    const userAvatarEl = qs("#user-avatar");
    const userNameEl = qs("#user-name");
    const userRoleLabelEl = qs("#user-role-label");
    const logoutBtn = qs("#logout-btn");

    const brandNameSidebar = qs("#brand-name-sidebar");
    const brandLogoBadge = qs("#brand-logo-badge");
    const brandLogoInitials = qs("#brand-logo-initials");
    const brandSubtitleSidebar = qs("#brand-subtitle-sidebar");
    const sidebarUserEmail = qs("#sidebar-user-email");
    const sidebarUserRole = qs("#sidebar-user-role");

    // Overview KPIs
    const kpiSalesTodayEl = qs("#kpi-sales-today");
    const kpiOrdersTodayEl = qs("#kpi-orders-today");
    const kpiProductsEl = qs("#kpi-products");
    const kpiStockUnitsEl = qs("#kpi-stock-units");

    // Navigation
    const navItems = qsa(".nav-item");
    const viewOverview = qs("#view-overview");
    const viewProducts = qs("#view-products");
    const viewCustomers = qs("#view-customers");
    const viewSettings = qs("#view-settings");

    // Products DOM
    const productsTbody = qs("#products-tbody");
    const productsSearchInput = qs("#products-search");
    const productsRefreshBtn = qs("#products-refresh");
    const addProductBtn = qs("#btn-add-product");

    // Customers DOM
    const customersTbody = qs("#customers-tbody");
    const customersSearchInput = qs("#customers-search");
    const customersRefreshBtn = qs("#customers-refresh");

    // Settings DOM
    const settingsAlertContainer = qs("#settings-alert-container");
    const settingsStatus = qs("#settings-status");
    const settingBrandName = qs("#setting-brand-name");
    const settingCountry = qs("#setting-country");
    const settingOwnerEmail = qs("#setting-owner-email");
    const settingLogoFile = qs("#setting-logo-file");
    const brandLogoPreview = qs("#brand-logo-preview");
    const brandLogoPlaceholder = qs("#brand-logo-placeholder");
    const saveSettingsBtn = qs("#btn-save-settings");
    const deleteBrandBtn = qs("#btn-delete-brand");

    // Product modal
    const productModalBackdrop = qs("#product-modal-backdrop");
    const productModalClose = qs("#product-modal-close");
    const productModalCancel = qs("#product-modal-cancel");
    const productModalSave = qs("#product-modal-save");
    const productModalTitle = qs("#product-modal-title");
    const productModalAlert = qs("#product-modal-alert");
    const prodNameInput = qs("#prod-name");
    const prodSkuInput = qs("#prod-sku");
    const prodBasePriceInput = qs("#prod-base-price");
    const prodImageFileInput = qs("#prod-image-file");
    const variantGroupNameInput = qs("#variant-group-name");
    const variantLabelsContainer = qs("#variant-labels-container");
    const btnAddVariantLabel = qs("#btn-add-variant-label");

    let currentUser = null;
    let currentUserDoc = null;
    let currentBrandId = null;
    let currentBrandDoc = null;
    let allProducts = [];
    let allCustomers = [];
    let editingProductId = null;
    let editingProductExistingImageUrl = null;

    function parseQuery(){
      const params = new URLSearchParams(window.location.search);
      return {
        brand: params.get("brand"),
        token: params.get("token"),
        impersonate: params.get("impersonate")
      };
    }

    function showView(view){
      navItems.forEach(item=>{
        const v = item.getAttribute("data-view");
        if(v === view) item.classList.add("active");
        else item.classList.remove("active");
      });

      viewOverview.style.display = (view==="overview")?"flex":"none";
      viewProducts.style.display = (view==="products")?"flex":"none";
      viewCustomers.style.display = (view==="customers")?"flex":"none";
      viewSettings.style.display = (view==="settings")?"flex":"none";

      if(view === "overview"){
        pageTitleEl.textContent = "Overview";
        pageSubtitleEl.textContent = "Sales, orders and stock summary for this brand.";
      }else if(view === "products"){
        pageTitleEl.textContent = "Products & stock";
        pageSubtitleEl.textContent = "Manage products and keep stock in sync with POS.";
      }else if(view === "customers"){
        pageTitleEl.textContent = "Customers";
        pageSubtitleEl.textContent = "Customers captured from POS.";
      }else if(view === "settings"){
        pageTitleEl.textContent = "Brand settings";
        pageSubtitleEl.textContent = "Logo, contact and dangerous actions.";
      }
    }

    navItems.forEach(item=>{
      item.addEventListener("click",()=>{
        const v = item.getAttribute("data-view");
        showView(v);
      });
    });

    function initialsFromString(str){
      if(!str) return "B";
      const parts = str.trim().split(/\s+/);
      if(parts.length === 1) return parts[0].slice(0,2).toUpperCase();
      return (parts[0][0] + parts[1][0]).toUpperCase();
    }

    function formatDate(ts){
      if(!ts || !ts.seconds) return "";
      const d = new Date(ts.seconds*1000);
      return d.toLocaleString();
    }

    function showLogin(){
      loginScreen.style.display = "flex";
      signupScreen.style.display = "none";
      appShell.style.display = "none";
    }
    function showSignup(){
      loginScreen.style.display = "none";
      signupScreen.style.display = "flex";
      appShell.style.display = "none";
    }
    function showApp(){
      loginScreen.style.display = "none";
      signupScreen.style.display = "none";
      appShell.style.display = "flex";
    }

    function showSettingsAlert(msg,type="success"){
      const cls = type==="success"?"alert-success":type==="error"?"alert-error":"alert-info";
      settingsAlertContainer.innerHTML = `<div class="alert ${cls}">${msg}</div>`;
      setTimeout(()=>{settingsAlertContainer.innerHTML="";},3500);
    }

    function clearProductModal(){
      productModalAlert.innerHTML = "";
      editingProductId = null;
      editingProductExistingImageUrl = null;
      prodNameInput.value = "";
      prodSkuInput.value = "";
      prodBasePriceInput.value = "";
      prodImageFileInput.value = "";
      variantGroupNameInput.value = "";
      variantLabelsContainer.innerHTML = "";
      addVariantLabelRow();
    }

    function openProductModal(editProduct){
      clearProductModal();
      if(editProduct){
        editingProductId = editProduct.id;
        productModalTitle.textContent = "Edit product";
        prodNameInput.value = editProduct.name || "";
        prodSkuInput.value = editProduct.sku || "";
        prodBasePriceInput.value = editProduct.basePrice != null ? editProduct.basePrice : "";
        variantGroupNameInput.value = editProduct.variantGroupName || "";
        editingProductExistingImageUrl = editProduct.imageUrl || null;

        const labels = editProduct.variants || [];
        if(labels.length === 0){
          addVariantLabelRow();
        }else{
          labels.forEach(v=>addVariantLabelRow(v));
        }
      }else{
        productModalTitle.textContent = "New product";
      }
      productModalBackdrop.classList.add("show");
    }

    function closeProductModal(){
      productModalBackdrop.classList.remove("show");
    }

    function addVariantLabelRow(vData){
      const row = document.createElement("div");
      row.className = "variant-label-row";
      row.innerHTML = `
        <input class="variant-small-input var-label-name" placeholder="Label (e.g. Small)" value="${vData?.label || ""}"/>
        <input class="variant-small-input var-label-price" type="number" step="0.01" min="0" placeholder="Price" value="${vData?.price ?? ""}"/>
        <input class="variant-small-input var-label-stock" type="number" step="1" min="0" placeholder="Stock" value="${vData?.stock ?? ""}"/>
        <input class="variant-small-input var-label-barcode" placeholder="Barcode" value="${vData?.barcode || ""}"/>
        <button type="button" class="btn-mini btn-remove-label">‚úï</button>
      `;
      const removeBtn = row.querySelector(".btn-remove-label");
      removeBtn.addEventListener("click",()=>{
        row.remove();
        const remaining = variantLabelsContainer.querySelectorAll(".variant-label-row").length;
        if(remaining === 0) addVariantLabelRow();
      });
      variantLabelsContainer.appendChild(row);
    }

    btnAddVariantLabel.addEventListener("click",()=>addVariantLabelRow());

    if(productModalClose) productModalClose.addEventListener("click",closeProductModal);
    if(productModalCancel) productModalCancel.addEventListener("click",closeProductModal);

    function showProductModalAlert(msg,type="error"){
      const cls = type==="error"?"alert-error":"alert-info";
      productModalAlert.innerHTML = `<div class="alert ${cls}">${msg}</div>`;
    }

    async function saveProduct(){
      const name = prodNameInput.value.trim();
      if(!name){
        showProductModalAlert("Please enter a product name.","error");
        return;
      }
      if(!currentBrandId){
        showProductModalAlert("Brand not loaded yet.","error");
        return;
      }

      const sku = prodSkuInput.value.trim() || null;
      const basePrice = parseFloat(prodBasePriceInput.value||"0") || 0;
      const groupName = variantGroupNameInput.value.trim() || null;

      const rows = Array.from(variantLabelsContainer.querySelectorAll(".variant-label-row"));
      const variants = [];
      let totalStock = 0;
      let minPrice = null;
      let maxPrice = null;

      for(const row of rows){
        const labelEl = row.querySelector(".var-label-name");
        const priceEl = row.querySelector(".var-label-price");
        const stockEl = row.querySelector(".var-label-stock");
        const barcodeEl = row.querySelector(".var-label-barcode");

        const label = labelEl.value.trim();
        const price = parseFloat(priceEl.value||"0") || basePrice || 0;
        const stock = parseInt(stockEl.value||"0",10) || 0;
        const barcode = barcodeEl.value.trim() || null;

        if(!label) continue;

        totalStock += stock;
        if(minPrice === null || price < minPrice) minPrice = price;
        if(maxPrice === null || price > maxPrice) maxPrice = price;

        variants.push({
          id: crypto.randomUUID ? crypto.randomUUID() : (Math.random().toString(36).slice(2)),
          groupName: groupName,
          label,
          price,
          stock,
          barcode
        });
      }

      if(variants.length === 0){
        showProductModalAlert("Please add at least one variant label with a name.","error");
        return;
      }

      const productsRef = collection(db,"brands",currentBrandId,"products");
      let productRef;
      if(editingProductId){
        productRef = doc(productsRef, editingProductId);
      }else{
        productRef = doc(productsRef);
      }

      productModalSave.disabled = true;
      productModalSave.textContent = "Saving‚Ä¶";

      try{
        let imageUrl = editingProductExistingImageUrl || null;
        const file = prodImageFileInput.files?.[0];
        if(file){
          const refPath = `brands/${currentBrandId}/products/${productRef.id}/image`;
          const fileRef = storageRef(storage, refPath);
          await uploadBytes(fileRef,file);
          imageUrl = await getDownloadURL(fileRef);
        }

        const payload = {
          name,
          sku,
          basePrice,
          variantGroupName: groupName,
          variants,
          stockTotal: totalStock,
          minPrice: minPrice ?? basePrice,
          maxPrice: maxPrice ?? basePrice,
          imageUrl: imageUrl || null,
          updatedAt: serverTimestamp()
        };
        if(!editingProductId){
          payload.createdAt = serverTimestamp();
          payload.isActive = true;
        }

        await setDoc(productRef, payload, {merge:true});
        closeProductModal();
        await loadProducts();
        await loadOverview();
      }catch(err){
        console.error("Error saving product",err);
        showProductModalAlert("Failed to save product. Check console.","error");
      }finally{
        productModalSave.disabled = false;
        productModalSave.textContent = "Save product";
      }
    }

    productModalSave.addEventListener("click",saveProduct);

    function renderProducts(filterText=""){
      const ft = filterText.trim().toLowerCase();
      productsTbody.innerHTML = "";
      const filtered = allProducts.filter(p=>{
        if(!ft) return true;
        const hay = `${p.name||""} ${p.sku||""}`.toLowerCase();
        return hay.includes(ft);
      });

      if(filtered.length === 0){
        productsTbody.innerHTML = `<tr><td colspan="5"><div class="empty-state">${allProducts.length===0?"No products yet. Add your first product.":"No products match your search."}</div></td></tr>`;
        return;
      }

      for(const p of filtered){
        const tr = document.createElement("tr");
        const priceRange = (()=>{
          if(p.minPrice == null && p.maxPrice == null) return "‚Äî";
          if(p.minPrice === p.maxPrice) return `${p.minPrice}`;
          return `${p.minPrice} ‚Äì ${p.maxPrice}`;
        })();

        const variantsSummary = p.variants?.map(v=>v.label).join(", ") || "‚Äî";

        tr.innerHTML = `
          <td>
            <div style="display:flex;align-items:center;gap:8px;">
              ${p.imageUrl ? `<img src="${p.imageUrl}" style="width:32px;height:32px;border-radius:8px;object-fit:cover;border:1px solid var(--border);"/>` : `<div style="width:32px;height:32px;border-radius:8px;background:#e5e7eb;display:flex;align-items:center;justify-content:center;font-size:11px;color:#4b5563;">${(p.name||"?").charAt(0).toUpperCase()}</div>`}
              <div style="display:flex;flex-direction:column;gap:2px;">
                <span style="font-size:12px;font-weight:600;">${p.name || ""}</span>
                <span class="muted">${p.sku || ""}</span>
              </div>
            </div>
          </td>
          <td>
            <div style="display:flex;flex-direction:column;gap:2px;">
              <span style="font-size:12px;">${variantsSummary}</span>
              <span class="muted">${p.variantGroupName ? "Group: " + p.variantGroupName : ""}</span>
            </div>
          </td>
          <td>${p.stockTotal ?? 0}</td>
          <td>${priceRange}</td>
          <td style="text-align:right;">
            <button class="btn-mini btn-edit-product" data-id="${p.id}">Edit</button>
            <button class="btn-mini btn-danger-mini" data-id="${p.id}">Delete</button>
          </td>
        `;
        productsTbody.appendChild(tr);
      }

      qsa(".btn-edit-product").forEach(btn=>{
        btn.addEventListener("click",()=>{
          const id = btn.dataset.id;
          const prod = allProducts.find(p=>p.id===id);
          if(prod) openProductModal(prod);
        });
      });

      qsa(".btn-danger-mini").forEach(btn=>{
        btn.addEventListener("click",async()=>{
          const id = btn.dataset.id;
          if(!id || !currentBrandId) return;
          const confirmed = confirm("Delete this product? It will be removed from POS.");
          if(!confirmed) return;
          try{
            const ref = doc(db,"brands",currentBrandId,"products",id);
            await deleteDoc(ref);
            await loadProducts();
            await loadOverview();
          }catch(err){
            console.error("Error deleting product",err);
            alert("Failed to delete product.");
          }
        });
      });
    }

    async function loadProducts(){
      if(!currentBrandId) return;
      try{
        productsTbody.innerHTML = `<tr><td colspan="5"><div class="empty-state">Loading products‚Ä¶</div></td></tr>`;
        const productsRef = collection(db,"brands",currentBrandId,"products");
        const qProducts = query(productsRef, orderBy("createdAt","desc"));
        const snap = await getDocs(qProducts);
        const list = [];
        snap.forEach(docSnap=>{
          const data = docSnap.data() || {};
          list.push({
            id: docSnap.id,
            ...data
          });
        });
        allProducts = list;
        renderProducts(productsSearchInput.value);
      }catch(err){
        console.error("Error loading products",err);
        productsTbody.innerHTML = `<tr><td colspan="5"><div class="empty-state">Error loading products.</div></td></tr>`;
      }
    }

    function renderCustomers(filterText=""){
      const ft = filterText.trim().toLowerCase();
      customersTbody.innerHTML = "";
      const filtered = allCustomers.filter(c=>{
        if(!ft) return true;
        const hay = `${c.name||""} ${c.email||""} ${c.phone||""}`.toLowerCase();
        return hay.includes(ft);
      });

      if(filtered.length === 0){
        customersTbody.innerHTML = `<tr><td colspan="3"><div class="empty-state">${allCustomers.length===0?"No customers yet.":"No customers match your search."}</div></td></tr>`;
        return;
      }

      for(const c of filtered){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${c.name || "‚Äî"}</td>
          <td>
            <div style="display:flex;flex-direction:column;gap:2px;">
              <span class="muted">${c.email || ""}</span>
              <span class="muted">${c.phone || ""}</span>
            </div>
          </td>
          <td><span class="muted">${formatDate(c.updatedAt || c.createdAt)}</span></td>
        `;
        customersTbody.appendChild(tr);
      }
    }

    async function loadCustomers(){
      if(!currentBrandId) return;
      try{
        customersTbody.innerHTML = `<tr><td colspan="3"><div class="empty-state">Loading customers‚Ä¶</div></td></tr>`;
        const customersRef = collection(db,"brands",currentBrandId,"customers");
        const snap = await getDocs(customersRef);
        const list = [];
        snap.forEach(docSnap=>{
          const data = docSnap.data() || {};
          list.push({
            id: docSnap.id,
            ...data
          });
        });
        allCustomers = list;
        renderCustomers(customersSearchInput.value);
      }catch(err){
        console.error("Error loading customers",err);
        customersTbody.innerHTML = `<tr><td colspan="3"><div class="empty-state">Error loading customers.</div></td></tr>`;
      }
    }

    async function loadOverview(){
      if(!currentBrandId) return;
      try{
        const productsRef = collection(db,"brands",currentBrandId,"products");
        const productsSnap = await getDocs(productsRef);
        let productCount = 0;
        let stockUnits = 0;
        productsSnap.forEach(docSnap=>{
          const d = docSnap.data() || {};
          productCount += 1;
          stockUnits += d.stockTotal || 0;
        });
        kpiProductsEl.textContent = productCount.toString();
        kpiStockUnitsEl.textContent = stockUnits.toString();

        const today = new Date();
        today.setHours(0,0,0,0);
        const tomorrow = new Date(today.getTime()+24*60*60*1000);

        const ordersRef = collection(db,"brands",currentBrandId,"branches");
        // Simple: iterate all branches then their orders
        let ordersToday = 0;
        let salesToday = 0;

        const branchesSnap = await getDocs(ordersRef);
        for(const branchDoc of branchesSnap.docs){
          const ordersCol = collection(branchDoc.ref,"orders");
          const snapOrders = await getDocs(ordersCol);
          snapOrders.forEach(os=>{
            const data = os.data() || {};
            const createdAt = data.createdAt || data.createdAtLocal;
            if(!createdAt || !createdAt.seconds) return;
            const d = new Date(createdAt.seconds*1000);
            if(d >= today && d < tomorrow){
              ordersToday += 1;
              const total = data.total || 0;
              const type = data.type || "sale";
              if(type === "sale"){
                salesToday += total;
              }else if(type === "return"){
                salesToday += total; // total is negative for returns
              }
            }
          });
        }

        kpiOrdersTodayEl.textContent = ordersToday.toString();
        kpiSalesTodayEl.textContent = salesToday.toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:0});
      }catch(err){
        console.error("Error loading overview",err);
        kpiOrdersTodayEl.textContent = "‚Äî";
        kpiSalesTodayEl.textContent = "‚Äî";
      }
    }

    function applyBrandUI(){
      if(!currentBrandDoc) return;
      const name = currentBrandDoc.name || "Brand";
      brandNameSidebar.textContent = name;
      brandSubtitleSidebar.textContent = "Luma brand dashboard";
      settingBrandName.value = name || "";
      settingCountry.value = currentBrandDoc.country || "";
      settingOwnerEmail.value = currentBrandDoc.ownerEmail || "";

      const logoUrl = currentBrandDoc.logoUrl;
      if(logoUrl){
        brandLogoBadge.innerHTML = `<img src="${logoUrl}" alt="Brand logo"/>`;
        brandLogoPreview.src = logoUrl;
        brandLogoPreview.style.display = "block";
        brandLogoPlaceholder.style.display = "none";
      }else{
        brandLogoBadge.innerHTML = `<span>${initialsFromString(name)}</span>`;
        brandLogoPreview.style.display = "none";
        brandLogoPlaceholder.style.display = "inline";
      }
    }

    async function loadBrand(brandId){
      if(!brandId) return null;
      const brandRef = doc(db,"brands",brandId);
      const snap = await getDoc(brandRef);
      if(!snap.exists()) return null;
      currentBrandDoc = snap.data() || {};
      currentBrandId = brandId;
      applyBrandUI();
      await Promise.all([
        loadProducts(),
        loadCustomers(),
        loadOverview()
      ]);
      return currentBrandDoc;
    }

    async function saveBrandSettings(){
      if(!currentBrandId) return;
      try{
        saveSettingsBtn.disabled = true;
        saveSettingsBtn.textContent = "Saving‚Ä¶";
        settingsStatus.textContent = "Saving‚Ä¶";

        const brandRef = doc(db,"brands",currentBrandId);
        await updateDoc(brandRef,{
          name: settingBrandName.value.trim() || null,
          country: settingCountry.value.trim() || null,
          ownerEmail: settingOwnerEmail.value.trim() || null,
          updatedAt: serverTimestamp()
        });

        const logoFile = settingLogoFile.files?.[0];
        if(logoFile){
          const refPath = `brands/${currentBrandId}/brand-logo`;
          const fileRef = storageRef(storage, refPath);
          await uploadBytes(fileRef, logoFile);
          const url = await getDownloadURL(fileRef);
          await updateDoc(brandRef,{logoUrl:url,updatedAt:serverTimestamp()});
          currentBrandDoc.logoUrl = url;
        }

        const snap = await getDoc(brandRef);
        currentBrandDoc = snap.data() || currentBrandDoc;
        applyBrandUI();
        settingsStatus.textContent = "Saved.";
        showSettingsAlert("Brand settings saved.","success");
      }catch(err){
        console.error("Error saving brand settings",err);
        settingsStatus.textContent = "Error saving.";
        showSettingsAlert("Failed to save settings.","error");
      }finally{
        saveSettingsBtn.disabled = false;
        saveSettingsBtn.textContent = "Save brand settings";
      }
    }

    async function softDeleteBrand(){
      if(!currentBrandId) return;
      const confirmed = confirm("Are you sure you want to delete this brand? It will be archived and hidden.");
      if(!confirmed) return;
      try{
        deleteBrandBtn.disabled = true;
        deleteBrandBtn.textContent = "Deleting‚Ä¶";
        const brandRef = doc(db,"brands",currentBrandId);
        await updateDoc(brandRef,{
          status:"deleted",
          isActive:false,
          deletedAt: serverTimestamp()
        });
        alert("Brand deleted (soft delete). You will be logged out.");
        await signOut(auth);
      }catch(err){
        console.error("Error deleting brand",err);
        alert("Failed to delete brand.");
      }finally{
        deleteBrandBtn.disabled = false;
        deleteBrandBtn.textContent = "Delete brand";
      }
    }

    saveSettingsBtn.addEventListener("click",saveBrandSettings);
    deleteBrandBtn.addEventListener("click",softDeleteBrand);

    // Search and refresh events
    productsSearchInput.addEventListener("input",()=>renderProducts(productsSearchInput.value));
    productsRefreshBtn.addEventListener("click",()=>loadProducts());
    customersSearchInput.addEventListener("input",()=>renderCustomers(customersSearchInput.value));
    customersRefreshBtn.addEventListener("click",()=>loadCustomers());
    addProductBtn.addEventListener("click",()=>openProductModal());

    // Login logic
    loginBtn.addEventListener("click",async()=>{
      loginError.style.display="none";
      loginError.textContent="";
      const email = loginEmail.value.trim();
      const pass = loginPassword.value;
      if(!email || !pass){
        loginError.textContent="Enter email and password.";
        loginError.style.display="block";
        return;
      }
      try{
        loginBtn.disabled = true;
        loginBtn.textContent = "Logging in‚Ä¶";
        await signInWithEmailAndPassword(auth,email,pass);
      }catch(err){
        console.error("Login error",err);
        loginError.textContent="Invalid email or password.";
        loginError.style.display="block";
      }finally{
        loginBtn.disabled = false;
        loginBtn.textContent = "Login";
      }
    });

    logoutBtn.addEventListener("click",async()=>{
      try{await signOut(auth);}catch(e){console.error(e);}
    });

    // Signup from link
    async function initSignupFromLink(){
      const {brand,token} = parseQuery();
      if(!brand || !token) return false;
      try{
        const brandRef = doc(db,"brands",brand);
        const snap = await getDoc(brandRef);
        if(!snap.exists()){
          signupBrandLabel.textContent = "Brand not found.";
          signupAlert.textContent = "This signup link is invalid (brand not found).";
          signupAlert.style.display = "block";
          return true;
        }
        const data = snap.data() || {};
        if(data.status === "deleted"){
          signupBrandLabel.textContent = data.name || "Deleted brand";
          signupAlert.textContent = "This brand has been deleted. Contact support.";
          signupAlert.style.display = "block";
          return true;
        }
        if(data.signupToken && data.signupToken !== token){
          signupBrandLabel.textContent = data.name || "Brand";
          signupAlert.textContent = "This signup link is invalid or already used.";
          signupAlert.style.display = "block";
          return true;
        }
        signupBrandLabel.textContent = `Brand: ${data.name || "Untitled"}`;
        signupAlert.style.display = "none";

        signupBtn.addEventListener("click",async()=>{
          signupAlert.style.display="none";
          const name = signupName.value.trim();
          const email = signupEmail.value.trim();
          const pass = signupPassword.value;
          if(!name || !email || !pass){
            signupAlert.textContent = "Fill all fields.";
            signupAlert.style.display = "block";
            return;
          }
          try{
            signupBtn.disabled = true;
            signupBtn.textContent = "Creating‚Ä¶";
            const cred = await createUserWithEmailAndPassword(auth,email,pass);
            const uid = cred.user.uid;
            await setDoc(doc(db,"users",uid),{
              name,
              email,
              role:"brand_owner",
              brandId: brand,
              brandName: data.name || null,
              status:"active",
              createdAt: serverTimestamp()
            });
            await updateDoc(brandRef,{
              ownerUserId: uid,
              ownerEmail: email,
              signupToken: token,
              signupCompletedAt: serverTimestamp(),
              status: data.status === "pending_setup" ? "active" : (data.status || "active")
            });
            // onAuthStateChanged will handle dashboard
          }catch(err){
            console.error("Signup error",err);
            signupAlert.textContent = "Failed to create account. Maybe email already used.";
            signupAlert.style.display = "block";
          }finally{
            signupBtn.disabled = false;
            signupBtn.textContent = "Create owner account";
          }
        });

        return true;
      }catch(err){
        console.error("Error initializing signup",err);
        signupAlert.textContent = "Error loading brand. Check console.";
        signupAlert.style.display = "block";
        return true;
      }
    }

    // onAuthStateChanged
    onAuthStateChanged(auth,async(user)=>{
      if(!user){
        currentUser = null;
        currentUserDoc = null;
        currentBrandId = null;
        currentBrandDoc = null;

        // Decide which auth screen
        const hasSignupParams = !!(parseQuery().brand && parseQuery().token);
        if(hasSignupParams){
          showSignup();
          initSignupFromLink();
        }else{
          showLogin();
        }
        return;
      }

      currentUser = user;
      sidebarUserEmail.textContent = user.email || "";
      loginError.style.display="none";

      try{
        const userRef = doc(db,"users",user.uid);
        const snap = await getDoc(userRef);
        if(!snap.exists()){
          await signOut(auth);
          alert("Your user record is missing. Contact support.");
          return;
        }
        const data = snap.data() || {};
        currentUserDoc = data;

        const allowedRoles = ["brand_owner","brand_manager"];
        if(!allowedRoles.includes(data.role)){
          await signOut(auth);
          alert("You do not have permission to access the brand dashboard.");
          return;
        }

        sidebarUserRole.textContent = data.role.replace("_"," ");
        userNameEl.textContent = data.name || (user.email || "");
        userRoleLabelEl.textContent = data.role.replace("_"," ");
        userAvatarEl.textContent = initialsFromString(data.name || user.email || "BO");

        const brandId = data.brandId;
        if(!brandId){
          await signOut(auth);
          alert("Your user has no brandId set. Contact support.");
          return;
        }

        showApp();
        showView("overview");
        await loadBrand(brandId);
      }catch(err){
        console.error("Error loading user or brand",err);
        await signOut(auth);
        alert("Error loading user or brand.");
      }
    });

    // Initial: decide screen (before auth listener fires) ‚Äì just for UX
    (async ()=>{
      const {brand,token} = parseQuery();
      if(brand && token){
        showSignup();
        await initSignupFromLink();
      }else{
        showLogin();
      }
    })();
  </script>
</body>
</html>
