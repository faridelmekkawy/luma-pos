<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Luma Store OS — POS</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#f3f4f6;
      --panel:#ffffff;
      --panel-soft:#f9fafb;
      --ink:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --accent:#2563eb;
      --accent-soft:#dbeafe;
      --accent-strong:#1d4ed8;
      --radius:16px;
      --shadow:0 18px 40px rgba(15,23,42,.12);
      --danger:#ef4444;
      --ok:#16a34a;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{
      height:100%;
      font-family:"Montserrat",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--ink);
    }
    body{
      min-height:100vh;
      padding:14px;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .hidden{display:none !important;}

    /* LOGIN */
    .auth-wrapper{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
      background:radial-gradient(circle at top,#e5edff,#f3f4f6 46%,#e5e7eb 100%);
      z-index:30;
    }
    .auth-shell{
      width:100%;
      max-width:380px;
      background:var(--panel);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      border:1px solid rgba(148,163,184,.3);
      padding:18px 18px 16px;
    }
    .auth-header{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .auth-logo{
      width:34px;height:34px;border-radius:999px;
      background:linear-gradient(135deg,#2563eb,#a855f7);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:700;font-size:18px;
    }
    .auth-title{
      font-size:16px;font-weight:700;
    }
    .auth-subtitle{
      font-size:11px;color:var(--muted);margin-top:2px;
    }
    .auth-alert{
      font-size:11px;
      padding:6px 9px;
      border-radius:9px;
      margin-bottom:8px;
    }
    .auth-alert-error{
      background:#fef2f2;
      color:#b91c1c;
      border:1px solid #fecaca;
    }
    .field{
      margin-bottom:8px;
    }
    .field-label{
      font-size:11px;margin-bottom:3px;color:#4b5563;
    }
    .field-input{
      width:100%;
      padding:8px 9px;
      border-radius:9px;
      border:1px solid var(--border);
      background:#f9fafb;
      font-size:12px;
    }
    .field-input:focus{
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 1px var(--accent-soft);
    }
    .btn-auth{
      width:100%;
      border:none;
      border-radius:999px;
      padding:9px 12px;
      font-size:13px;
      font-weight:600;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      background:var(--accent);
      color:#fff;
      box-shadow:0 12px 28px rgba(37,99,235,.3);
    }
    .btn-auth:hover{
      background:var(--accent-strong);
    }
    .btn-auth:disabled{
      opacity:.7;cursor:default;box-shadow:none;
    }
    .auth-footer{
      text-align:center;
      margin-top:8px;
      font-size:10px;
      color:var(--muted);
    }

    /* POS SHELL */
    .shell{
      width:100%;
      max-width:1180px;
      background:var(--panel);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      border:1px solid var(--border);
      padding:12px 14px 14px;
      display:none;
      flex-direction:column;
      gap:10px;
    }
    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      border-bottom:1px solid var(--border);
      padding-bottom:6px;
    }
    .top-left{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .title{
      font-size:18px;font-weight:700;
    }
    .subtitle{
      font-size:11px;color:var(--muted);
    }
    .brand-chip{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:11px;
      margin-top:4px;
    }
    .brand-logo{
      width:26px;height:26px;border-radius:999px;
      background:linear-gradient(135deg,#2563eb,#a855f7);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:700;font-size:14px;
      overflow:hidden;
      background-size:cover;
      background-position:center;
    }

    .top-right{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:flex-end;
    }
    .top-actions{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .top-search-wrap{
      position:relative;
    }
    .top-search-input{
      width:210px;
      max-width:50vw;
      padding:7px 9px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-size:12px;
    }
    .top-search-input:focus{
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 1px var(--accent-soft);
    }
    .cart-pill{
      display:flex;
      align-items:center;
      gap:6px;
      padding:5px 9px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--panel-soft);
      font-size:11px;
    }
    .cart-pill-count{
      font-weight:600;
    }
    .cart-pill-total{
      color:var(--muted);
      font-size:11px;
    }

    .mode-toggle{
      display:flex;
      align-items:center;
      gap:4px;
      margin-top:2px;
      justify-content:flex-end;
    }
    .mode-label{
      font-size:10px;
      color:var(--muted);
    }
    .mode-group{
      display:inline-flex;
      border-radius:999px;
      border:1px solid var(--border);
      background:#f9fafb;
      overflow:hidden;
    }
    .mode-pill{
      font-size:10px;
      padding:4px 10px;
      border:none;
      background:transparent;
      cursor:pointer;
      color:#6b7280;
    }
    .mode-pill-active{
      background:#2563eb;
      color:#fff;
    }

    .user-chip{
      display:flex;
      align-items:center;
      gap:7px;
      border-radius:999px;
      border:1px solid var(--border);
      padding:6px 9px;
      background:var(--panel-soft);
      font-size:11px;
    }
    .user-initials{
      width:24px;height:24px;border-radius:999px;
      background:var(--accent-soft);
      display:flex;align-items:center;justify-content:center;
      font-size:11px;font-weight:600;color:var(--accent-strong);
    }
    .user-text{
      display:flex;flex-direction:column;
    }
    .user-name{
      font-size:11px;font-weight:600;
    }
    .user-role{
      font-size:10px;color:var(--muted);
    }

    .main-row{
      display:grid;
      grid-template-columns:1.3fr 1fr; /* LEFT: products/returns, RIGHT: cart */
      gap:10px;
      margin-top:6px;
    }
    @media(max-width:900px){
      body{padding:8px;}
      .shell{padding:10px;}
      .topbar{flex-direction:column;align-items:flex-start;}
      .top-right{align-items:flex-start;}
      .main-row{grid-template-columns:1fr;}
    }
    .card{
      background:var(--panel-soft);
      border-radius:12px;
      border:1px solid var(--border);
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
    }
    .card-title{
      font-size:13px;font-weight:600;
    }
    .card-subtitle{
      font-size:11px;color:var(--muted);
    }
    .badge{
      font-size:10px;
      padding:2px 6px;
      border-radius:999px;
      background:#eef2ff;
      color:#4f46e5;
    }

    .alert{
      font-size:11px;
      padding:6px 9px;
      border-radius:9px;
      margin-bottom:4px;
    }
    .alert-info{
      background:#eff6ff;
      color:#1d4ed8;
      border:1px solid #bfdbfe;
    }
    .alert-error{
      background:#fef2f2;
      color:#b91c1c;
      border:1px solid #fecaca;
    }
    .alert-ok{
      background:#ecfdf5;
      color:#15803d;
      border:1px solid #bbf7d0;
    }

    .field-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .field-pos{
      flex:1;
      min-width:120px;
    }
    .field-label-pos{
      font-size:11px;margin-bottom:3px;color:#4b5563;
    }
    .field-input-pos, .field-select-pos{
      width:100%;
      padding:7px 9px;
      border-radius:9px;
      border:1px solid var(--border);
      background:#fff;
      font-size:12px;
    }
    .field-input-pos:focus, .field-select-pos:focus{
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 1px var(--accent-soft);
    }
    .field-hint-pos{
      font-size:10px;color:var(--muted);margin-top:2px;
    }

    .btn{
      border:none;
      border-radius:999px;
      padding:7px 12px;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      white-space:nowrap;
    }
    .btn-primary{
      background:var(--accent);
      color:#fff;
      box-shadow:0 10px 24px rgba(37,99,235,.25);
    }
    .btn-primary:hover{
      background:var(--accent-strong);
    }
    .btn-ghost{
      background:transparent;
      color:var(--accent-strong);
      border:1px solid var(--accent-soft);
    }
    .btn-ghost:hover{
      background:var(--accent-soft);
    }
    .btn-small{
      padding:5px 9px;
      font-size:11px;
    }
    .btn-danger{
      background:#fee2e2;
      color:#b91c1c;
      border:1px solid #fecaca;
    }

    .cart-table-wrapper{
      border-radius:10px;
      border:1px solid var(--border);
      overflow:hidden;
      background:#fff;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    th,td{
      padding:7px 8px;
      text-align:left;
      border-bottom:1px solid var(--border);
      vertical-align:middle;
    }
    thead{
      background:#f3f4f6;
    }
    th{
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--muted);
    }
    tbody tr:hover{
      background:#f9fafb;
    }
    .empty{
      text-align:center;
      font-size:11px;
      color:var(--muted);
      padding:12px 4px;
    }

    .qty-control{
      display:inline-flex;
      align-items:center;
      gap:3px;
      border-radius:999px;
      border:1px solid var(--border);
      padding:1px 4px;
      background:#fff;
    }
    .qty-btn{
      border:none;
      background:transparent;
      font-size:11px;
      cursor:pointer;
      width:16px;
      text-align:center;
    }
    .qty-val{
      min-width:18px;
      text-align:center;
      font-size:11px;
    }

    .summary{
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:12px;
      margin-top:4px;
    }
    .summary-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .summary-label{
      color:var(--muted);
    }
    .summary-total{
      font-size:15px;
      font-weight:700;
    }

    .products-list{
      border-radius:10px;
      border:1px solid var(--border);
      background:#fff;
      padding:6px;
      max-height:420px;
      overflow:auto;
    }
    .product-item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:6px 6px;
      border-radius:8px;
      font-size:12px;
      gap:8px;
      cursor:pointer;
    }
    .product-item.disabled{
      opacity:.6;
      cursor:not-allowed;
    }
    .product-item:hover{
      background:#e5e7eb;
    }
    .product-left{
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
    }
    .product-img-thumb{
      width:40px;
      height:40px;
      border-radius:8px;
      background:#e5e7eb;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-shrink:0;
      font-size:10px;
      color:#6b7280;
    }
    .product-img-thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .product-text{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .product-title{
      font-weight:500;
      white-space:nowrap;
      text-overflow:ellipsis;
      overflow:hidden;
      max-width:180px;
    }
    .product-meta{
      font-size:10px;
      color:#6b7280;
      white-space:nowrap;
      text-overflow:ellipsis;
      overflow:hidden;
      max-width:220px;
    }
    .product-right{
      display:flex;
      align-items:center;
      gap:6px;
      flex-shrink:0;
    }

    /* CHECKOUT / PRODUCT MODALS */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.4);
      display:none;
      align-items:center;
      justify-content:center;
      padding:12px;
      z-index:40;
    }
    .modal-panel{
      width:100%;
      max-width:420px;
      background:var(--panel);
      border-radius:16px;
      box-shadow:var(--shadow);
      border:1px solid var(--border);
      padding:14px 16px 12px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .modal-title{
      font-size:14px;
      font-weight:600;
    }
    .modal-subtitle{
      font-size:11px;
      color:var(--muted);
    }
    .modal-alert{
      font-size:11px;
      padding:6px 9px;
      border-radius:9px;
      margin-top:4px;
    }
    .modal-alert-error{
      background:#fef2f2;
      color:#b91c1c;
      border:1px solid #fecaca;
    }
    .modal-footer{
      display:flex;
      justify-content:flex-end;
      gap:6px;
      margin-top:4px;
    }
    .customer-suggestions{
      margin-top:4px;
      border-radius:9px;
      border:1px solid var(--border);
      background:#f9fafb;
      max-height:120px;
      overflow:auto;
      font-size:11px;
    }
    .customer-suggestion-item{
      padding:6px 8px;
      cursor:pointer;
      border-bottom:1px solid var(--border);
    }
    .customer-suggestion-item:last-child{
      border-bottom:none;
    }
    .customer-suggestion-item:hover{
      background:#e5e7eb;
    }
    .text-muted{
      color:var(--muted);
    }
    .text-note{
      font-size:10px;
      color:var(--muted);
      margin-top:3px;
    }

    .product-img-large{
      width:80px;
      height:80px;
      border-radius:12px;
      background:#e5e7eb;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:11px;
      color:#6b7280;
      flex-shrink:0;
    }
    .product-img-large img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
  </style>
</head>
<body>

  <!-- LOGIN OVERLAY -->
  <div id="pos-auth-wrapper" class="auth-wrapper">
    <div class="auth-shell">
      <div class="auth-header">
        <div class="auth-logo">P</div>
        <div>
          <div class="auth-title">Luma Store OS — POS</div>
          <div class="auth-subtitle">
            Log in with a POS user (username + PIN) created from the Brand Dashboard.
          </div>
        </div>
      </div>

      <div id="auth-alert"></div>

      <form id="pos-login-form">
        <div class="field">
          <div class="field-label">Username</div>
          <input id="pos-login-username" class="field-input" placeholder="POS username"/>
        </div>
        <div class="field">
          <div class="field-label">PIN</div>
          <input id="pos-login-pin" class="field-input" type="password" placeholder="PIN (e.g. 4–6 digits)"/>
        </div>
        <button type="submit" id="pos-login-btn" class="btn-auth">Log in</button>
      </form>

      <div class="auth-footer">
        Admin: in the Brand Dashboard, create a POS user in <code>posUsers</code> with username, pin, brandId and branchId.
      </div>
    </div>
  </div>

  <!-- POS SHELL -->
  <div class="shell" id="pos-shell">
    <header class="topbar">
      <div class="top-left">
        <div class="title">POS</div>
        <div id="subtitle" class="subtitle">Loading brand and branch…</div>
        <div class="brand-chip">
          <div id="brand-logo" class="brand-logo">B</div>
          <div id="brand-chip-text">—</div>
        </div>
      </div>

      <div class="top-right">
        <div class="top-actions">
          <div class="top-search-wrap">
            <input id="top-product-search" class="top-search-input" placeholder="Search products (name/code)"/>
          </div>
          <div class="cart-pill">
            <span id="cart-summary-count" class="cart-pill-count">0 items</span>
            <span id="cart-summary-total" class="cart-pill-total">0.00</span>
          </div>
          <button type="button" id="btn-open-checkout" class="btn btn-primary btn-small">
            Proceed
          </button>
        </div>
        <div class="mode-toggle">
          <span class="mode-label">Mode:</span>
          <div class="mode-group">
            <button type="button" id="mode-sale" class="mode-pill mode-pill-active">Sale</button>
            <button type="button" id="mode-return" class="mode-pill">Return</button>
          </div>
        </div>
        <div class="user-chip">
          <div id="user-initials" class="user-initials">U</div>
          <div class="user-text">
            <div id="user-name" class="user-name">User</div>
            <div id="user-role" class="user-role">Cashier</div>
          </div>
        </div>
      </div>
    </header>

    <div id="global-alert"></div>

    <div class="main-row">
      <!-- LEFT: PRODUCTS (sale) / ORDER SEARCH (return) -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title" id="left-card-title">Products</div>
            <div class="card-subtitle" id="left-card-subtitle">
              Scan barcode, type a code, or tap an item to add to cart.
            </div>
          </div>
          <span id="branch-badge" class="badge">Branch: —</span>
        </div>

        <!-- Code input -->
        <div class="field-row" style="margin-top:4px;">
          <div class="field-pos">
            <div class="field-label-pos" id="code-input-label">Scan or type product code</div>
            <input id="code-input" class="field-input-pos" placeholder="Focus here, then scan or type code"/>
            <div class="field-hint-pos" id="code-input-hint">
              Works with barcode scanners that behave like a keyboard and send Enter after scanning.
            </div>
          </div>
          <div>
            <div class="field-label-pos">&nbsp;</div>
            <button type="button" id="btn-add-code" class="btn btn-primary btn-small">Add to cart</button>
          </div>
        </div>

        <!-- Product list (hidden in return mode) -->
        <div id="products-list" class="products-list">
          <div class="empty">Loading products…</div>
        </div>
      </div>

      <!-- RIGHT: CART + OFFLINE QUEUE -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title" id="cart-card-title">Cart</div>
            <div class="card-subtitle" id="cart-card-subtitle">
              Adjust quantities or remove items. Proceed to add customer & payment details.
            </div>
          </div>
        </div>

        <!-- Cart table -->
        <div class="cart-table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Item</th>
                <th>Code</th>
                <th>Qty</th>
                <th>Price</th>
                <th>Total</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="cart-tbody">
              <tr><td colspan="6" class="empty">No items yet. Scan or select a product.</td></tr>
            </tbody>
          </table>
        </div>

        <!-- Summary -->
        <div class="summary">
          <div class="summary-row">
            <span class="summary-label" id="summary-subtotal-label">Subtotal</span>
            <span id="summary-subtotal">0.00</span>
          </div>
          <div class="summary-row">
            <span class="summary-label" id="summary-total-label">Total</span>
            <span id="summary-total" class="summary-total">0.00</span>
          </div>
          <div class="summary-row">
            <span class="summary-label" id="summary-payment-label">Payment method</span>
            <select id="payment-method" class="field-select-pos" style="max-width:180px;">
              <option value="cash">Cash</option>
              <option value="card">Card</option>
              <option value="wallet">Wallet</option>
              <option value="other">Other</option>
            </select>
          </div>
        </div>

        <div class="summary-row" style="margin-top:6px;">
          <button type="button" id="btn-clear-cart" class="btn btn-ghost btn-small">Clear cart</button>
          <button type="button" id="btn-open-checkout-secondary" class="btn btn-primary btn-small">Proceed</button>
        </div>

        <!-- Return full order action (only in return mode) -->
        <div class="summary-row" id="return-full-row" style="margin-top:4px; display:none;">
          <button type="button" id="btn-return-full" class="btn btn-ghost btn-small">Return full order</button>
        </div>

        <div class="text-note" id="return-note" style="display:none;">
          Return mode: load an order by ID or phone, set the quantity to return, then refund. Amounts in the system are stored as negative.
        </div>

        <!-- Offline status + queue -->
        <div id="offline-status" class="alert alert-error" style="display:none;margin-top:6px;"></div>
        <div id="offline-queue-list" class="field-hint-pos" style="margin-top:2px;"></div>
      </div>
    </div>
  </div>

  <!-- CHECKOUT MODAL -->
  <div id="checkout-modal" class="modal-backdrop">
    <div class="modal-panel">
      <div class="modal-header">
        <div>
          <div class="modal-title" id="checkout-title">Checkout — customer & payment</div>
          <div class="modal-subtitle" id="checkout-subtitle">
            Name and email are required. Suggestions appear as you type.
          </div>
          <div class="text-note" id="checkout-original-order-note" style="display:none;"></div>
        </div>
        <span id="checkout-total" class="summary-total">0.00</span>
      </div>

      <div id="checkout-alert" class="modal-alert hidden"></div>

      <div class="field-row">
        <div class="field-pos">
          <div class="field-label-pos">Customer name <span class="text-muted">*</span></div>
          <input id="checkout-customer-name" class="field-input-pos" placeholder="Customer full name"/>
        </div>
      </div>
      <div class="field-row">
        <div class="field-pos">
          <div class="field-label-pos">Phone</div>
          <input id="checkout-customer-phone" class="field-input-pos" placeholder="Optional, used to find customer"/>
        </div>
        <div class="field-pos">
          <div class="field-label-pos">Email <span class="text-muted">*</span></div>
          <input id="checkout-customer-email" class="field-input-pos" type="email" placeholder="Required"/>
        </div>
      </div>

      <div id="checkout-customer-suggestions" class="customer-suggestions hidden"></div>

      <div class="field-row">
        <div class="field-pos">
          <div class="field-label-pos">Payment method</div>
          <div class="field-input-pos" style="background:#f9fafb;" id="checkout-payment-summary">
            <!-- filled from main select -->
          </div>
          <div class="field-hint-pos">
            Change payment method from the main POS screen if needed.
          </div>
        </div>
      </div>

      <div class="field-row" id="card-txn-row" style="display:none;">
        <div class="field-pos">
          <div class="field-label-pos">Card transaction number <span class="text-muted">*</span></div>
          <input id="checkout-card-txn" class="field-input-pos" placeholder="Last 4 / transaction reference"/>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" id="btn-checkout-cancel" class="btn btn-ghost btn-small">Cancel</button>
        <button type="button" id="btn-checkout-confirm" class="btn btn-primary btn-small">Confirm &amp; place order</button>
      </div>
    </div>
  </div>

  <!-- PRODUCT QUICK VIEW MODAL -->
  <div id="product-modal" class="modal-backdrop">
    <div class="modal-panel">
      <div class="modal-header">
        <div>
          <div class="modal-title" id="product-modal-name">Product</div>
          <div class="modal-subtitle" id="product-modal-code"></div>
        </div>
        <span id="product-modal-price" class="summary-total">0.00</span>
      </div>

      <div style="display:flex;gap:10px;align-items:flex-start;margin-top:4px;">
        <div id="product-modal-image" class="product-img-large">No image</div>
        <div style="flex:1;">
          <div class="field-row" id="product-modal-variant-row" style="display:none;margin-bottom:6px;">
            <div class="field-pos">
              <div class="field-label-pos">Variant</div>
              <select id="product-modal-variant-select" class="field-select-pos"></select>
            </div>
          </div>
          <div class="text-note">
            Tap “Add to cart” to add one unit. You can adjust quantity in the cart.
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" id="product-modal-cancel" class="btn btn-ghost btn-small">Close</button>
        <button type="button" id="product-modal-add" class="btn btn-primary btn-small">Add to cart</button>
      </div>
    </div>
  </div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getFirestore,
    doc,
    getDoc,
    setDoc,
    addDoc,
    collection,
    getDocs,
    query,
    where,
    limit,
    runTransaction,
    serverTimestamp,
    updateDoc
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import {
    getAuth,
    signInAnonymously
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  const firebaseConfig = {
    apiKey:"AIzaSyA80bAAGPuyscnTVS-zwrxE9Jp3tPiS1gM",
    authDomain:"events-339ce.firebaseapp.com",
    databaseURL:"https://events-339ce-default-rtdb.europe-west1.firebasedatabase.app",
    projectId:"events-339ce",
    storageBucket:"events-339ce.firebasestorage.app",
    messagingSenderId:"175601544315",
    appId:"1:175601544315:web:00c94b4affa972b3a286de"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // n8n webhook
  const WEBHOOK_URL = "https://automation.evu.business/webhook/e220fde4-d2bd-46b3-b0d9-b8cfc15ca6f5";

  // Try anonymous auth so Firestore rules with request.auth != null will work
  signInAnonymously(auth).catch(err => {
    console.error("Anonymous auth failed:", err);
  });

  const qs = s => document.querySelector(s);

  // LOGIN DOM
  const authWrapper = qs("#pos-auth-wrapper");
  const authAlertEl = qs("#auth-alert");
  const loginForm = qs("#pos-login-form");
  const loginUsernameEl = qs("#pos-login-username");
  const loginPinEl = qs("#pos-login-pin");
  const loginBtn = qs("#pos-login-btn");

  // POS DOM
  const shellEl = qs("#pos-shell");
  const subtitleEl = qs("#subtitle");
  const brandLogoEl = qs("#brand-logo");
  const brandChipTextEl = qs("#brand-chip-text");
  const userInitialsEl = qs("#user-initials");
  const userNameEl = qs("#user-name");
  const userRoleEl = qs("#user-role");
  const branchBadgeEl = qs("#branch-badge");
  const globalAlertEl = qs("#global-alert");

  const leftCardTitleEl = qs("#left-card-title");
  const leftCardSubtitleEl = qs("#left-card-subtitle");
  const codeInputLabelEl = qs("#code-input-label");
  const codeInputHintEl = qs("#code-input-hint");
  const cartCardTitleEl = qs("#cart-card-title");
  const cartCardSubtitleEl = qs("#cart-card-subtitle");
  const summarySubtotalLabelEl = qs("#summary-subtotal-label");
  const summaryTotalLabelEl = qs("#summary-total-label");
  const summaryPaymentLabelEl = qs("#summary-payment-label");
  const returnNoteEl = qs("#return-note");

  const codeInputEl = qs("#code-input");
  const btnAddCode = qs("#btn-add-code");

  const cartTbody = qs("#cart-tbody");
  const summarySubtotalEl = qs("#summary-subtotal");
  const summaryTotalEl = qs("#summary-total");
  const paymentMethodEl = qs("#payment-method");
  const btnClearCart = qs("#btn-clear-cart");

  const productsListEl = qs("#products-list");
  const topSearchEl = qs("#top-product-search");
  const cartSummaryCountEl = qs("#cart-summary-count");
  const cartSummaryTotalEl = qs("#cart-summary-total");
  const btnOpenCheckoutTop = qs("#btn-open-checkout");
  const btnOpenCheckoutSecondary = qs("#btn-open-checkout-secondary");

  const modeSaleBtn = qs("#mode-sale");
  const modeReturnBtn = qs("#mode-return");

  const returnFullRowEl = qs("#return-full-row");
  const btnReturnFull = qs("#btn-return-full");

  // Offline DOM
  const offlineStatusEl = qs("#offline-status");
  const offlineQueueListEl = qs("#offline-queue-list");

  // Checkout modal DOM
  const checkoutModalEl = qs("#checkout-modal");
  const checkoutAlertEl = qs("#checkout-alert");
  const checkoutTotalEl = qs("#checkout-total");
  const checkoutPaymentSummaryEl = qs("#checkout-payment-summary");
  const checkoutNameEl = qs("#checkout-customer-name");
  const checkoutPhoneEl = qs("#checkout-customer-phone");
  const checkoutEmailEl = qs("#checkout-customer-email");
  const checkoutCardTxnRowEl = qs("#card-txn-row");
  const checkoutCardTxnEl = qs("#checkout-card-txn");
  const checkoutSuggestionsEl = qs("#checkout-customer-suggestions");
  const checkoutTitleEl = qs("#checkout-title");
  const checkoutSubtitleEl = qs("#checkout-subtitle");
  const checkoutOriginalOrderNoteEl = qs("#checkout-original-order-note");
  const btnCheckoutCancel = qs("#btn-checkout-cancel");
  const btnCheckoutConfirm = qs("#btn-checkout-confirm");
  const checkoutModal = qs("#checkout-modal");

  // Product modal DOM
  const productModalEl = qs("#product-modal");
  const productModalNameEl = qs("#product-modal-name");
  const productModalCodeEl = qs("#product-modal-code");
  const productModalPriceEl = qs("#product-modal-price");
  const productModalImageEl = qs("#product-modal-image");
  const productModalVariantRowEl = qs("#product-modal-variant-row");
  const productModalVariantSelectEl = qs("#product-modal-variant-select");
  const productModalCancelBtn = qs("#product-modal-cancel");
  const productModalAddBtn = qs("#product-modal-add");

  let brandId = null;
  let branchId = null;
  let brandData = null;
  let branchData = null;
  let posUser = null;

  let products = [];
  let cartItems = [];
  let currentCustomerId = null;
  let lastCustomerSearchTerm = "";
  let currentMode = "sale"; // "sale" | "return"
  let currentReturnOrderMeta = null; // {orderDocId, orderId, data}
  let currentProductForModal = null;

  // Offline orders queue
  let offlineOrders = [];
  const OFFLINE_KEY_PREFIX = "luma_pos_offline_orders";
  const CRED_KEY = "luma_pos_credentials";

  function getOfflineKeyForBrandBranch(){
    return `${OFFLINE_KEY_PREFIX}_${brandId || "noBrand"}_${branchId || "noBranch"}`;
  }

  function showAuthAlert(msg){
    authAlertEl.innerHTML = `<div class="auth-alert auth-alert-error">${msg}</div>`;
  }
  function clearAuthAlert(){
    authAlertEl.innerHTML = "";
  }
  function showGlobalAlert(msg,type="info"){
    let cls = "alert-info";
    if(type==="error") cls = "alert-error";
    if(type==="ok") cls = "alert-ok";
    globalAlertEl.innerHTML = `<div class="alert ${cls}">${msg}</div>`;
    setTimeout(()=>{ globalAlertEl.innerHTML = ""; }, 4000);
  }

  function initialsFromNameOrUsername(name,username){
    if(name){
      const p = name.trim().split(" ");
      if(p.length === 1) return p[0].slice(0,2).toUpperCase();
      return (p[0][0]+p[p.length-1][0]).toUpperCase();
    }
    if(username){
      const s = username.toString();
      if(s.length<=2) return s.toUpperCase();
      const parts = s.split(/[._-]/).filter(Boolean);
      if(parts.length===0) return s.slice(0,2).toUpperCase();
      return (parts[0][0]+(parts[1]?.[0] || "")).toUpperCase();
    }
    return "U";
  }

  function updateCartSummary(subtotal){
    const totalItems = cartItems.reduce((sum,i)=>sum + i.qty,0);
    cartSummaryCountEl.textContent = totalItems === 1 ? "1 item" : `${totalItems} items`;
    cartSummaryTotalEl.textContent = subtotal.toFixed(2);
  }

  function renderCart(){
    if(cartItems.length === 0){
      cartTbody.innerHTML = `<tr><td colspan="6" class="empty">No items yet. ${
        currentMode==="sale"
          ? "Scan or select a product."
          : "Load an order in return mode."
      }</td></tr>`;
      summarySubtotalEl.textContent = "0.00";
      summaryTotalEl.textContent = "0.00";
      updateCartSummary(0);
      return;
    }
    let html = "";
    let subtotal = 0;
    cartItems.forEach((item,idx)=>{
      const line = item.price * item.qty;
      subtotal += line;
      const qtyInfo = (currentMode==="return" && item.originalQty != null)
        ? ` (${item.qty}/${item.originalQty})`
        : "";
      const fullName = item.variantName
        ? `${item.name} (${item.variantName})`
        : item.name;
      html += `
        <tr>
          <td>${fullName}</td>
          <td>${item.code || ""}</td>
          <td>
            <div class="qty-control">
              <button class="qty-btn" data-idx="${idx}" data-action="dec">-</button>
              <span class="qty-val">${item.qty}${qtyInfo}</span>
              <button class="qty-btn" data-idx="${idx}" data-action="inc">+</button>
            </div>
          </td>
          <td>${item.price.toFixed(2)}</td>
          <td>${line.toFixed(2)}</td>
          <td><button class="btn btn-small btn-danger" data-idx="${idx}" data-action="remove">✕</button></td>
        </tr>`;
    });
    cartTbody.innerHTML = html;
    summarySubtotalEl.textContent = subtotal.toFixed(2);
    summaryTotalEl.textContent = subtotal.toFixed(2);
    updateCartSummary(subtotal);

    cartTbody.querySelectorAll(".qty-btn").forEach(btn=>{
      btn.addEventListener("click",()=>{
        const idx = parseInt(btn.dataset.idx,10);
        const action = btn.dataset.action;
        if(Number.isNaN(idx)) return;
        if(action==="inc"){
          if(currentMode==="return"){
            const maxQty = cartItems[idx].originalQty != null ? cartItems[idx].originalQty : cartItems[idx].qty;
            cartItems[idx].qty = Math.min(cartItems[idx].qty + 1, maxQty);
          }else{
            cartItems[idx].qty += 1;
          }
        }else if(action==="dec"){
          cartItems[idx].qty = Math.max(1, cartItems[idx].qty - 1);
        }
        renderCart();
      });
    });
    cartTbody.querySelectorAll(".btn-danger").forEach(btn=>{
      btn.addEventListener("click",()=>{
        const idx = parseInt(btn.dataset.idx,10);
        if(Number.isNaN(idx)) return;
        cartItems.splice(idx,1);
        renderCart();
      });
    });
  }

  function addProductToCart(prod, qty=1, variant=null){
    if(!prod) return;
    const variantId = variant && typeof variant.id !== "undefined" ? variant.id : null;
    const variantName = variant && variant.name ? variant.name : null;

    const existingIdx = cartItems.findIndex(i=>
      i.id===prod.id &&
      (i.variantId || null) === (variantId || null) &&
      (i.variantName || null) === (variantName || null)
    );

    if(existingIdx>=0){
      if(currentMode==="return"){
        const maxQty = cartItems[existingIdx].originalQty != null ? cartItems[existingIdx].originalQty : cartItems[existingIdx].qty;
        cartItems[existingIdx].qty = Math.min(cartItems[existingIdx].qty + qty, maxQty);
      }else{
        cartItems[existingIdx].qty += qty;
      }
    }else{
      cartItems.push({
        id:prod.id,
        name:prod.name || "Item",
        code:prod.code || "",
        price:typeof prod.price==="number" ? prod.price : 0,
        qty,
        originalQty: currentMode==="return" ? (prod.originalQty ?? qty) : null,
        variantId,
        variantName
      });
    }
    renderCart();
  }

  async function loadBrandAndBranch(){
    const brandRef = doc(db,"brands",brandId);
    const brandSnap = await getDoc(brandRef);
    if(!brandSnap.exists()) throw new Error("Brand not found");
    brandData = brandSnap.data();
    const brandName = brandData.name || "Brand";
    const country = brandData.country || "";
    const logoUrl = brandData.logoUrl || brandData.logo || null;

    if(logoUrl){
      brandLogoEl.style.backgroundImage = `url('${logoUrl}')`;
      brandLogoEl.textContent = "";
    }else{
      brandLogoEl.style.backgroundImage = "";
      brandLogoEl.textContent = brandName[0]?.toUpperCase() || "B";
    }

    brandChipTextEl.textContent = country ? `${brandName} • ${country}` : brandName;
    subtitleEl.textContent = "POS for this branch. Sales and returns are stored in the system.";

    const branchRef = doc(brandRef,"branches",branchId);
    const branchSnap = await getDoc(branchRef);
    if(!branchSnap.exists()) throw new Error("Branch not found");
    branchData = branchSnap.data();
    branchBadgeEl.textContent = `Branch: ${branchData.name || "Branch"}`;
  }

  async function loadProducts(){
    productsListEl.innerHTML = `<div class="empty">Loading products…</div>`;
    const productsCol = collection(db,"brands",brandId,"branches",branchId,"products");
    const snap = await getDocs(productsCol);
    products = [];
    snap.forEach(d=>{
      const p = d.data() || {};
      if(p.isActive === false) return;
      products.push({
        id:d.id,
        name:p.name || "Item",
        code:p.code || "",
        price:typeof p.price==="number" ? p.price : 0,
        variants:Array.isArray(p.variants)? p.variants : null,
        imageUrl:p.imageUrl || p.photoUrl || p.image || null
      });
    });
    renderProductsList();
  }

  function renderProductsList(filterText=""){
    const ft = filterText.trim().toLowerCase();
    const list = ft
      ? products.filter(p=>{
          const s = `${p.name} ${p.code}`.toLowerCase();
          return s.includes(ft);
        })
      : products;

    if(list.length===0){
      productsListEl.innerHTML = `<div class="empty">No products found for this branch.</div>`;
      return;
    }
    productsListEl.innerHTML = "";
    list.forEach(p=>{
      const div = document.createElement("div");
      div.className = "product-item" + (currentMode==="return" ? " disabled" : "");
      const hasVariants = p.variants && p.variants.length>0;
      const imgHtml = p.imageUrl
        ? `<div class="product-img-thumb"><img src="${p.imageUrl}" alt=""/></div>`
        : `<div class="product-img-thumb">No img</div>`;
      const variantsInfo = hasVariants
        ? ` • Variants: ${p.variants.map(v=>v.name || v.label || "").filter(Boolean).join(", ")}`
        : "";
      div.innerHTML = `
        <div class="product-left">
          ${imgHtml}
          <div class="product-text">
            <div class="product-title">${p.name}</div>
            <div class="product-meta">Code: ${p.code || "—"}${variantsInfo}</div>
          </div>
        </div>
        <div class="product-right">
          <div><strong>${p.price.toFixed(2)}</strong></div>
          <button class="btn btn-small btn-primary product-add-btn" data-id="${p.id}" ${currentMode==="return" ? "disabled" : ""}>Add</button>
        </div>`;

      // Clicking the row opens simple popup (sale mode only)
      div.addEventListener("click",(e)=>{
        if(currentMode==="return") return;
        const target = e.target;
        if(target instanceof Element && target.closest(".product-add-btn")) return;
        openProductModal(p);
      });

      const btn = div.querySelector(".product-add-btn");
      if(btn){
        btn.addEventListener("click",(e)=>{
          e.stopPropagation();
          if(currentMode==="return") return;
          if(hasVariants){
            openProductModal(p);
          }else{
            addProductToCart(p,1,null);
          }
        });
      }
      productsListEl.appendChild(div);
    });
  }

  function openProductModal(prod){
    if(currentMode==="return") return;
    currentProductForModal = prod;
    productModalNameEl.textContent = prod.name || "Item";
    productModalCodeEl.textContent = prod.code ? `Code: ${prod.code}` : "";
    productModalPriceEl.textContent = (typeof prod.price==="number" ? prod.price : 0).toFixed(2);

    if(prod.imageUrl){
      productModalImageEl.innerHTML = `<img src="${prod.imageUrl}" alt=""/>`;
    }else{
      productModalImageEl.textContent = "No image";
    }

    if(prod.variants && prod.variants.length>0){
      productModalVariantSelectEl.innerHTML = "";
      prod.variants.forEach((v,idx)=>{
        const opt = document.createElement("option");
        const vName = v.name || v.label || `Variant ${idx+1}`;
        opt.value = (v.id != null ? String(v.id) : String(idx));
        opt.textContent = vName;
        productModalVariantSelectEl.appendChild(opt);
      });
      productModalVariantRowEl.style.display = "block";
    }else{
      productModalVariantSelectEl.innerHTML = "";
      productModalVariantRowEl.style.display = "none";
    }

    productModalEl.style.display = "flex";
  }

  function closeProductModal(){
    productModalEl.style.display = "none";
    currentProductForModal = null;
  }

  function getSelectedVariantForCurrentProduct(){
    if(!currentProductForModal) return null;
    const prod = currentProductForModal;
    if(!prod.variants || prod.variants.length===0) return null;
    const val = productModalVariantSelectEl.value;
    if(!val && prod.variants.length===1){
      const v = prod.variants[0];
      return {
        id: v.id != null ? v.id : 0,
        name: v.name || v.label || "Variant"
      };
    }
    const found = prod.variants.find((v,idx)=>{
      const idStr = v.id != null ? String(v.id) : String(idx);
      return idStr === val;
    });
    if(!found) return null;
    return {
      id: found.id != null ? found.id : prod.variants.indexOf(found),
      name: found.name || found.label || "Variant"
    };
  }

  function findProductInMemoryByCode(code){
    return products.find(p=>p.code === code) || null;
  }

  async function handleAddByCodeSale(){
    const code = codeInputEl.value.trim();
    if(!code){
      showGlobalAlert("Enter or scan a code first.","error");
      return;
    }
    let prod = findProductInMemoryByCode(code);
    if(!prod){
      const productsCol = collection(db,"brands",brandId,"branches",branchId,"products");
      const qCode = query(productsCol, where("code","==",code), limit(1));
      const snap = await getDocs(qCode);
      if(!snap.empty){
        const d = snap.docs[0];
        const p = d.data() || {};
        prod = {
          id:d.id,
          name:p.name || "Item",
          code:p.code || "",
          price:typeof p.price==="number" ? p.price : 0,
          variants:Array.isArray(p.variants)? p.variants : null,
          imageUrl:p.imageUrl || p.photoUrl || p.image || null
        };
        products.push(prod);
      }
    }
    if(!prod){
      showGlobalAlert(`No product found with code "${code}".`,"error");
      return;
    }
    // If only one variant, auto-select it; if multiple, open popup
    if(prod.variants && prod.variants.length>1){
      openProductModal(prod);
    }else if(prod.variants && prod.variants.length===1){
      const v = prod.variants[0];
      const variant = {
        id: v.id != null ? v.id : 0,
        name: v.name || v.label || "Variant"
      };
      addProductToCart(prod,1,variant);
    }else{
      addProductToCart(prod,1,null);
    }
    codeInputEl.value = "";
    codeInputEl.focus();
  }

  async function handleLoadOrderForReturn(){
    const input = codeInputEl.value.trim();
    if(!input){
      showGlobalAlert("Enter or scan an order ID or customer phone first.","error");
      return;
    }
    const ordersCol = collection(db,"brands",brandId,"branches",branchId,"orders");

    // 1) Try by orderId
    let foundOrderDoc = null;
    try{
      const qOrderId = query(ordersCol, where("orderId","==",input), limit(1));
      const snapId = await getDocs(qOrderId);
      if(!snapId.empty){
        foundOrderDoc = snapId.docs[0];
      }
    }catch(e){
      console.warn("OrderId search error",e);
    }

    // 2) If not found, try by customer phone (use latest)
    if(!foundOrderDoc){
      try{
        const qPhone = query(ordersCol, where("customerPhone","==",input), limit(5));
        const snapPhone = await getDocs(qPhone);
        if(!snapPhone.empty){
          let docs = snapPhone.docs.slice();
          docs.sort((a,b)=>{
            const da = (a.data().createdAtLocal || "");
            const db = (b.data().createdAtLocal || "");
            return db.localeCompare(da);
          });
          foundOrderDoc = docs[0];
          if(snapPhone.size > 1){
            showGlobalAlert(`Found multiple orders for this phone. Using the most recent one (${foundOrderDoc.data().orderId || "no ID"}).`,"info");
          }
        }
      }catch(e){
        console.warn("Phone search error",e);
      }
    }

    if(!foundOrderDoc){
      showGlobalAlert(`No order found with ID or phone "${input}".`,"error");
      return;
    }

    const data = foundOrderDoc.data() || {};
    const originalOrderId = data.orderId || input;

    // Build map of already returned quantities per product
    const returnedMap = {};
    try{
      const qReturns = query(ordersCol, where("originalOrderId","==", originalOrderId));
      const returnsSnap = await getDocs(qReturns);
      returnsSnap.forEach(docR=>{
        const dR = docR.data() || {};
        if(!dR.isReturn) return;
        const itemsR = Array.isArray(dR.items) ? dR.items : [];
        itemsR.forEach(itR=>{
          const pid = itR.productId || itR.id || "";
          if(!pid) return;
          const q = typeof itR.qty === "number" ? Math.abs(itR.qty) : 0;
          if(q <= 0) return;
          returnedMap[pid] = (returnedMap[pid] || 0) + q;
        });
      });
    }catch(e){
      console.warn("Error reading previous returns",e);
    }

    // Also include offline queued returns that haven't synced yet
    offlineOrders
      .filter(o => o.mode === "return" && o.originalOrderMeta && o.originalOrderMeta.orderId === originalOrderId)
      .forEach(o=>{
        (o.cartItems || []).forEach(i=>{
          const pid = i.id;
          if(!pid) return;
          const q = typeof i.qty === "number" ? i.qty : 0;
          if(q <= 0) return;
          returnedMap[pid] = (returnedMap[pid] || 0) + q;
        });
      });

    currentReturnOrderMeta = {
      orderDocId:foundOrderDoc.id,
      orderId:originalOrderId,
      data
    };

    const items = Array.isArray(data.items) ? data.items : [];
    cartItems = [];
    let anyRemaining = false;

    items.forEach(it=>{
      const pid = it.productId || it.id || "";
      if(!pid) return;
      const originalQty = typeof it.qty === "number" ? Math.abs(it.qty) : 1;
      const alreadyReturned = returnedMap[pid] || 0;
      const remaining = originalQty - alreadyReturned;
      if(remaining <= 0) return; // fully refunded
      anyRemaining = true;
      cartItems.push({
        id:pid,
        name:it.name || "Item",
        code:it.code || "",
        price:typeof it.price==="number" ? it.price : 0,
        qty:remaining,
        originalQty,
        variantId: it.variant && typeof it.variant.id !== "undefined" ? it.variant.id : null,
        variantName: it.variant && it.variant.name ? it.variant.name : null
      });
    });

    if(!anyRemaining){
      cartItems = [];
      renderCart();
      showGlobalAlert("This order is already fully refunded. No remaining quantity to return.","info");
      codeInputEl.value = "";
      codeInputEl.focus();
      return;
    }

    renderCart();
    showGlobalAlert(`Loaded order ${originalOrderId} for return.`,`ok`);
    codeInputEl.value = "";
    codeInputEl.focus();
  }

  async function findExistingCustomer(email,phone){
    const customersCol = collection(db,"brands",brandId,"customers");
    if(email){
      const qEmail = query(customersCol, where("email","==",email), limit(1));
      const snap = await getDocs(qEmail);
      if(!snap.empty){
        const d = snap.docs[0];
        return { id:d.id, data:d.data() };
      }
    }
    if(phone){
      const qPhone = query(customersCol, where("phone","==",phone), limit(1));
      const snap = await getDocs(qPhone);
      if(!snap.empty){
        const d = snap.docs[0];
        return { id:d.id, data:d.data() };
      }
    }
    return null;
  }

  async function searchCustomersForSuggestions(term){
    const t = term.trim();
    if(t.length < 1){
      checkoutSuggestionsEl.classList.add("hidden");
      checkoutSuggestionsEl.innerHTML = "";
      lastCustomerSearchTerm = "";
      return;
    }
    lastCustomerSearchTerm = t;

    const customersCol = collection(db,"brands",brandId,"customers");
    const candidates = [];

    try{
      const qPhone = query(
        customersCol,
        where("phone", ">=", t),
        where("phone", "<=", t + "\uf8ff"),
        limit(5)
      );
      const snapPhone = await getDocs(qPhone);
      snapPhone.forEach(d=>{
        candidates.push({ id:d.id, data:d.data() });
      });
    }catch(e){ console.warn("Phone prefix search error",e); }

    try{
      const qEmail = query(
        customersCol,
        where("email", ">=", t),
        where("email", "<=", t + "\uf8ff"),
        limit(5)
      );
      const snapEmail = await getDocs(qEmail);
      snapEmail.forEach(d=>{
        if(!candidates.find(c=>c.id===d.id)){
          candidates.push({ id:d.id, data:d.data() });
        }
      });
    }catch(e){ console.warn("Email prefix search error",e); }

    try{
      const qName = query(
        customersCol,
        where("name", ">=", t),
        where("name", "<=", t + "\uf8ff"),
        limit(5)
      );
      const snapName = await getDocs(qName);
      snapName.forEach(d=>{
        if(!candidates.find(c=>c.id===d.id)){
          candidates.push({ id:d.id, data:d.data() });
        }
      });
    }catch(e){ console.warn("Name prefix search error",e); }

    if(lastCustomerSearchTerm !== t) return;

    if(candidates.length === 0){
      checkoutSuggestionsEl.classList.add("hidden");
      checkoutSuggestionsEl.innerHTML = "";
      return;
    }

    checkoutSuggestionsEl.innerHTML = "";
    candidates.forEach(c=>{
      const data = c.data || {};
      const name = data.name || "(No name)";
      const phone = data.phone || "";
      const email = data.email || "";
      const div = document.createElement("div");
      div.className = "customer-suggestion-item";
      div.innerHTML = `
        <div><strong>${name}</strong></div>
        <div class="text-muted">${phone || "No phone"} • ${email || "No email"}</div>
      `;
      div.addEventListener("click",()=>{
        currentCustomerId = c.id;
        checkoutNameEl.value = name || "";
        checkoutPhoneEl.value = phone || "";
        checkoutEmailEl.value = email || "";
        checkoutSuggestionsEl.classList.add("hidden");
        checkoutSuggestionsEl.innerHTML = "";
      });
      checkoutSuggestionsEl.appendChild(div);
    });
    checkoutSuggestionsEl.classList.remove("hidden");
  }

  async function ensureCustomer(){
    const name = checkoutNameEl.value.trim();
    const phone = checkoutPhoneEl.value.trim();
    const email = checkoutEmailEl.value.trim();
    const customersCol = collection(db,"brands",brandId,"customers");

    if(!name && !phone && !email){
      return { id:null, data:null };
    }

    if(currentCustomerId){
      const ref = doc(customersCol,currentCustomerId);
      await setDoc(ref,{
        name: name || null,
        phone: phone || null,
        email: email || null,
        updatedAt:serverTimestamp()
      },{ merge:true });
      return { id:currentCustomerId, data:{ name, phone, email } };
    }

    const found = await findExistingCustomer(email,phone);
    if(found){
      const ref = doc(customersCol,found.id);
      await setDoc(ref,{
        name: name || found.data.name || null,
        phone: phone || found.data.phone || null,
        email: email || found.data.email || null,
        updatedAt:serverTimestamp()
      },{ merge:true });
      currentCustomerId = found.id;
      const data = {
        name: name || found.data.name || null,
        phone: phone || found.data.phone || null,
        email: email || found.data.email || null
      };
      return { id:found.id, data };
    }

    const newRef = await addDoc(customersCol,{
      name: name || null,
      phone: phone || null,
      email: email || null,
      createdAt:serverTimestamp(),
      updatedAt:serverTimestamp()
    });
    currentCustomerId = newRef.id;
    return { id:newRef.id, data:{ name, phone, email } };
  }

  async function generateOrderId(){
    const now = new Date();
    const dd = String(now.getDate()).padStart(2,"0");
    const mm = String(now.getMonth()+1).padStart(2,"0");
    const humanDate = `${dd}${mm}`;
    const dateKey = `${now.getFullYear()}-${mm}-${dd}`;
    const countersRef = doc(db,"brands",brandId,"branches",branchId,"orderCounters",dateKey);

    const orderNumber = await runTransaction(db, async (tx)=>{
      const snap = await tx.get(countersRef);
      let current = 0;
      if(snap.exists()){
        current = snap.data().value || 0;
      }
      const next = current + 1;
      tx.set(countersRef,{ value:next },{ merge:true });
      return next;
    });

    return `${humanDate}-${orderNumber}`;
  }

  function makeLocalOrderIdForOffline(){
    const now = new Date();
    const dd = String(now.getDate()).padStart(2,"0");
    const mm = String(now.getMonth()+1).padStart(2,"0");
    const hh = String(now.getHours()).padStart(2,"0");
    const mi = String(now.getMinutes()).padStart(2,"0");
    const ss = String(now.getSeconds()).padStart(2,"0");
    return `${dd}${mm}-L${hh}${mi}${ss}`;
  }

  function showCheckoutAlert(msg){
    checkoutAlertEl.textContent = msg;
    checkoutAlertEl.classList.remove("hidden");
    checkoutAlertEl.classList.add("modal-alert","modal-alert-error");
  }
  function clearCheckoutAlert(){
    checkoutAlertEl.textContent = "";
    checkoutAlertEl.classList.add("hidden");
  }

  function nameOrNull(v){
    const t = v.trim();
    return t ? t : null;
  }
  function phoneOrNull(v){
    const t = v.trim();
    return t ? t : null;
  }
  function emailOrNull(v){
    const t = v.trim();
    return t ? t : null;
  }

  function openCheckoutModal(){
    if(cartItems.length === 0){
      showGlobalAlert("Cart is empty.","error");
      return;
    }
    clearCheckoutAlert();
    const total = parseFloat(summaryTotalEl.textContent) || 0;
    checkoutTotalEl.textContent = total.toFixed(2);
    const pm = paymentMethodEl.value;
    const pmLabelMap = {
      cash:"Cash",
      card:"Card",
      wallet:"Wallet",
      other:"Other"
    };
    checkoutPaymentSummaryEl.textContent = pmLabelMap[pm] || pm;
    checkoutCardTxnRowEl.style.display = pm === "card" ? "block" : "none";

    currentCustomerId = null;
    checkoutNameEl.value = "";
    checkoutPhoneEl.value = "";
    checkoutEmailEl.value = "";
    checkoutCardTxnEl.value = "";
    checkoutSuggestionsEl.classList.add("hidden");
    checkoutSuggestionsEl.innerHTML = "";

    if(currentMode==="return" && currentReturnOrderMeta && currentReturnOrderMeta.data){
      const od = currentReturnOrderMeta.data;
      const cn = od.customerName || "";
      const cp = od.customerPhone || "";
      const ce = od.customerEmail || "";
      checkoutNameEl.value = cn;
      checkoutPhoneEl.value = cp;
      checkoutEmailEl.value = ce;
      checkoutOriginalOrderNoteEl.style.display = "block";
      checkoutOriginalOrderNoteEl.textContent = `Return for order ${od.orderId || currentReturnOrderMeta.orderId || ""}. Original total: ${
        typeof od.total==="number" ? Math.abs(od.total).toFixed(2) : ""
      }`;
      checkoutTitleEl.textContent = "Return — customer & refund details";
      checkoutSubtitleEl.textContent = "Confirm customer and refund info. This will create a return linked to the original order.";
    }else{
      checkoutOriginalOrderNoteEl.style.display = "none";
      checkoutTitleEl.textContent = "Checkout — customer & payment";
      checkoutSubtitleEl.textContent = "Name and email are required. Suggestions appear as you type.";
    }

    checkoutModalEl.style.display = "flex";
    checkoutNameEl.focus();
  }

  function closeCheckoutModal(){
    checkoutModalEl.style.display = "none";
  }

  function loadOfflineOrders(){
    try{
      const key = getOfflineKeyForBrandBranch();
      const raw = localStorage.getItem(key);
      if(!raw){
        offlineOrders = [];
      }else{
        const parsed = JSON.parse(raw);
        offlineOrders = Array.isArray(parsed) ? parsed : [];
      }
    }catch(e){
      console.warn("Failed to load offline orders",e);
      offlineOrders = [];
    }
    renderOfflineOrders();
  }

  function saveOfflineOrders(){
    try{
      const key = getOfflineKeyForBrandBranch();
      localStorage.setItem(key, JSON.stringify(offlineOrders));
    }catch(e){
      console.warn("Failed to save offline orders",e);
    }
    renderOfflineOrders();
  }

  function renderOfflineOrders(){
    if(!offlineOrders.length){
      offlineStatusEl.style.display = "none";
      offlineQueueListEl.textContent = "";
      return;
    }
    const isOffline = !navigator.onLine;
    const msg = `${isOffline ? "Offline" : "Online"} — queued orders: ${offlineOrders.length}. <button id="btn-sync-offline" class="btn btn-small btn-ghost" style="margin-left:8px;">Sync now</button>`;
    offlineStatusEl.style.display = "block";
    offlineStatusEl.innerHTML = msg;

    offlineQueueListEl.textContent = offlineOrders
      .map(o=>`${o.mode==="return"?"Return":"Sale"} ${o.orderId} • ${o.totalPositive.toFixed(2)}`)
      .join(" | ");

    const btnSync = document.querySelector("#btn-sync-offline");
    if(btnSync){
      btnSync.onclick = ()=>{ syncQueuedOrders(); };
    }
  }

  function queueOfflineOrder({mode,totalPositive,paymentMethod,cardTxn,name,phone,email,cartItemsSnapshot,originalOrderMeta}){
    const orderId = makeLocalOrderIdForOffline();
    const localId = Date.now() + "-" + Math.random().toString(36).slice(2,8);
    const offlineOrder = {
      localId,
      mode,
      orderId,
      totalPositive,
      paymentMethod,
      cardTxn,
      name,
      phone,
      email,
      cartItems: cartItemsSnapshot.map(i=>({
        id:i.id,
        name:i.name,
        code:i.code || "",
        price:i.price,
        qty:i.qty,
        originalQty:i.originalQty ?? null,
        variantId:i.variantId || null,
        variantName:i.variantName || null
      })),
      brandId,
      branchId,
      brandName: brandData?.name || null,
      branchName: branchData?.name || null,
      posUser:{
        id:posUser?.id || null,
        username:posUser?.username || null,
        displayName:posUser?.displayName || null,
        role:posUser?.role || null
      },
      originalOrderMeta: originalOrderMeta || null,
      createdAtLocal:(new Date()).toISOString()
    };
    offlineOrders.push(offlineOrder);
    saveOfflineOrders();
    showGlobalAlert(`Offline — ${mode==="return"?"return":"order"} queued as ${orderId}. It will sync when internet is back.`,"info");

    cartItems = [];
    renderCart();
    currentReturnOrderMeta = null;
    closeCheckoutModal();
    codeInputEl.focus();
  }

  async function syncQueuedOrders(){
    if(!offlineOrders.length){
      showGlobalAlert("No queued orders to sync.","info");
      return;
    }
    if(!navigator.onLine){
      showGlobalAlert("Still offline. Cannot sync queued orders.","error");
      return;
    }
    const syncedIds = [];
    for(const o of offlineOrders){
      try{
        const ordersCol = collection(db,"brands",o.brandId,"branches",o.branchId,"orders");
        const orderRef = doc(ordersCol);

        const itemsForDb = o.cartItems.map(i=>{
          const qtySign = (o.mode==="return" ? -1 : 1);
          const qtyVal = i.qty * qtySign;
          const lineTotalVal = i.price * i.qty * qtySign;
          const base = {
            productId:i.id,
            name:i.name,
            code:i.code || null,
            qty:qtyVal,
            price:i.price,
            lineTotal:lineTotalVal,
            _absQty:Math.abs(qtyVal),
            _absLineTotal:Math.abs(lineTotalVal)
          };
          if(i.variantId || i.variantName){
            base.variant = {
              id:i.variantId || null,
              name:i.variantName || null
            };
          }
          return base;
        });

        const signedTotal = o.mode==="return" ? -o.totalPositive : o.totalPositive;
        const nowIso = o.createdAtLocal || (new Date()).toISOString();

        const orderData = {
          orderId:o.orderId,
          createdAt:serverTimestamp(),
          createdAtLocal:nowIso,
          paymentMethod:o.paymentMethod,
          total:signedTotal,
          totalAbsolute:o.totalPositive,
          items:itemsForDb,
          customerId:null,
          customerName:o.name || null,
          customerPhone:o.phone || null,
          customerEmail:o.email || null,
          cardTransaction: o.paymentMethod==="card" ? (o.cardTxn || null) : null,
          brandId:o.brandId,
          branchId:o.branchId,
          brandName:o.brandName || null,
          branchName:o.branchName || null,
          status: o.mode==="return" ? "return" : "normal",
          type: o.mode==="return" ? "return" : "sale",
          isReturn: o.mode==="return",
          originalOrderId: o.originalOrderMeta?.orderId || null,
          originalOrderDocId: o.originalOrderMeta?.orderDocId || null,
          originalPaymentMethod: o.originalOrderMeta?.data?.paymentMethod || null,
          posUser: o.posUser || null
        };

        await setDoc(orderRef,orderData);

        // Recompute refund status for original order if this is a return
        if(orderData.isReturn && orderData.originalOrderId && orderData.originalOrderDocId){
          await recomputeOriginalRefundStatus(orderData.originalOrderId, orderData.originalOrderDocId);
        }

        const payload = {
          source:"store-pos",
          mode:o.mode,
          orderId:o.orderId,
          orderDocId:orderRef.id,
          brandId:o.brandId,
          brandName:o.brandName || null,
          branchId:o.branchId,
          branchName:o.branchName || null,
          posUser:o.posUser || null,
          customer:{
            id:null,
            name:orderData.customerName,
            phone:orderData.customerPhone,
            email:orderData.customerEmail
          },
          totals:{
            signedTotal:orderData.total,
            absoluteTotal:o.totalPositive
          },
          items:itemsForDb,
          payment:{
            method:o.paymentMethod,
            cardTransaction:orderData.cardTransaction
          },
          isReturn:o.mode==="return",
          originalOrderId:orderData.originalOrderId || null,
          createdAtLocal:nowIso
        };

        if(WEBHOOK_URL){
          try{
            fetch(WEBHOOK_URL,{
              method:"POST",
              headers:{ "Content-Type":"application/json" },
              body:JSON.stringify(payload)
            }).catch(err=>console.error("Webhook error (sync)",err));
          }catch(e){
            console.error("Webhook exception (sync)",e);
          }
        }

        syncedIds.push(o.localId);
      }catch(err){
        console.error("Failed to sync offline order",o.orderId,err);
      }
    }
    if(syncedIds.length){
      offlineOrders = offlineOrders.filter(o=>!syncedIds.includes(o.localId));
      saveOfflineOrders();
      showGlobalAlert(`Synced ${syncedIds.length} queued order(s) successfully.`,"ok");
    }else{
      showGlobalAlert("Could not sync queued orders. Check console.","error");
    }
  }

  async function recomputeOriginalRefundStatus(originalOrderId, originalOrderDocId){
    if(!originalOrderId || !originalOrderDocId) return;
    try{
      const ordersCol = collection(db,"brands",brandId,"branches",branchId,"orders");
      const origRef = doc(ordersCol, originalOrderDocId);
      const origSnap = await getDoc(origRef);
      if(!origSnap.exists()) return;
      const origData = origSnap.data() || {};
      const originalTotal = typeof origData.totalAbsolute === "number"
        ? origData.totalAbsolute
        : Math.abs(origData.total || 0);

      const qAllReturns = query(ordersCol, where("originalOrderId","==", originalOrderId));
      const snap = await getDocs(qAllReturns);
      let refundedTotal = 0;
      snap.forEach(d=>{
        const data = d.data() || {};
        if(!data.isReturn) return;
        const tAbs = typeof data.totalAbsolute === "number"
          ? data.totalAbsolute
          : Math.abs(data.total || 0);
        refundedTotal += tAbs;
      });

      let refundStatus = "none";
      const eps = 0.01;
      if(refundedTotal > eps && refundedTotal < originalTotal - eps){
        refundStatus = "partial";
      }else if(refundedTotal >= originalTotal - eps){
        refundStatus = "full";
      }

      await updateDoc(origRef,{
        refundStatus,
        refundedTotal
      });
    }catch(e){
      console.warn("Failed to recompute refund status",e);
    }
  }

  async function handlePlaceOrder(){
    if(cartItems.length === 0){
      showCheckoutAlert("Cart is empty.");
      return;
    }
    const name = checkoutNameEl.value.trim();
    const email = checkoutEmailEl.value.trim();
    const phone = checkoutPhoneEl.value.trim();
    const pm = paymentMethodEl.value;
    const cardTxn = checkoutCardTxnEl.value.trim();

    if(!name){
      showCheckoutAlert("Customer name is required.");
      return;
    }
    if(!email){
      showCheckoutAlert("Customer email is required.");
      return;
    }
    if(pm === "card" && !cardTxn){
      showCheckoutAlert("Card transaction number is required for card payments.");
      return;
    }

    const totalPositive = parseFloat(summaryTotalEl.textContent) || 0;
    const paymentMethod = pm;

    btnCheckoutConfirm.disabled = true;
    btnCheckoutConfirm.textContent = "Placing…";
    try{
      const customerResult = await ensureCustomer();
      const customerId = customerResult.id;
      const customer = customerResult.data;

      const orderId = await generateOrderId();
      const now = new Date();

      const itemsForDb = cartItems.map(i=>{
        const qtySign = (currentMode==="return" ? -1 : 1);
        const qtyVal = i.qty * qtySign;
        const lineTotalVal = i.price * i.qty * qtySign;
        const base = {
          productId:i.id,
          name:i.name,
          code:i.code || null,
          qty:qtyVal,
          price:i.price,
          lineTotal:lineTotalVal,
          _absQty:Math.abs(qtyVal),
          _absLineTotal:Math.abs(lineTotalVal)
        };
        if(i.variantId || i.variantName){
          base.variant = {
            id:i.variantId || null,
            name:i.variantName || null
          };
        }
        return base;
      });

      const ordersCol = collection(db,"brands",brandId,"branches",branchId,"orders");
      const orderRef = doc(ordersCol);

      const baseOrderData = {
        orderId,
        createdAt:serverTimestamp(),
        createdAtLocal:now.toISOString(),
        paymentMethod,
        total: currentMode==="return" ? -totalPositive : totalPositive,
        totalAbsolute: totalPositive,
        items:itemsForDb,
        customerId:customerId || null,
        customerName:customer?.name || nameOrNull(checkoutNameEl.value),
        customerPhone:customer?.phone || phoneOrNull(checkoutPhoneEl.value),
        customerEmail:customer?.email || emailOrNull(checkoutEmailEl.value),
        cardTransaction: paymentMethod === "card" ? cardTxn : null,
        brandId,
        branchId,
        brandName:brandData?.name || null,
        branchName:branchData?.name || null,
        posUser:{
          id:posUser?.id || null,
          username:posUser?.username || null,
          displayName:posUser?.displayName || null,
          role:posUser?.role || null
        }
      };

      const orderData = currentMode==="return"
        ? {
            ...baseOrderData,
            status:"return",
            type:"return",
            isReturn:true,
            originalOrderId: currentReturnOrderMeta?.orderId || null,
            originalOrderDocId: currentReturnOrderMeta?.orderDocId || null,
            originalPaymentMethod: currentReturnOrderMeta?.data?.paymentMethod || null
          }
        : {
            ...baseOrderData,
            status:"normal",
            type:"sale",
            isReturn:false
          };

      await setDoc(orderRef,orderData);

      // Update original order refund status if online and this is a return
      if(currentMode==="return" && orderData.originalOrderId && orderData.originalOrderDocId && navigator.onLine){
        await recomputeOriginalRefundStatus(
          orderData.originalOrderId,
          orderData.originalOrderDocId
        );
      }

      const payload = {
        source:"store-pos",
        mode:currentMode,
        orderId,
        orderDocId:orderRef.id,
        brandId,
        brandName:brandData?.name || null,
        branchId,
        branchName:branchData?.name || null,
        posUser:{
          id:posUser?.id || null,
          username:posUser?.username || null,
          displayName:posUser?.displayName || null,
          role:posUser?.role || null
        },
        customer:{
          id:customerId || null,
          name:orderData.customerName,
          phone:orderData.customerPhone,
          email:orderData.customerEmail
        },
        totals:{
          signedTotal:orderData.total,
          absoluteTotal:totalPositive
        },
        items:itemsForDb,
        payment:{
          method:paymentMethod,
          cardTransaction: paymentMethod === "card" ? cardTxn : null
        },
        isReturn: currentMode==="return",
        originalOrderId: orderData.originalOrderId || null,
        createdAtLocal:orderData.createdAtLocal
      };

      if(WEBHOOK_URL){
        try{
          fetch(WEBHOOK_URL,{
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body:JSON.stringify(payload)
          }).catch(err=>console.error("Webhook error",err));
        }catch(e){
          console.error("Webhook exception",e);
        }
      }

      showGlobalAlert(`${currentMode==="return" ? "Return" : "Order"} ${orderId} created successfully.`,"ok");
      cartItems = [];
      renderCart();
      currentCustomerId = null;
      currentReturnOrderMeta = null;
      closeCheckoutModal();
      codeInputEl.focus();
    }catch(err){
      console.error(err);
      const networkCodes = ["unavailable","failed-precondition","network-request-failed"];
      if(!navigator.onLine || networkCodes.includes(err.code)){
        const snapshot = cartItems.map(i=>({...i}));
        queueOfflineOrder({
          mode:currentMode,
          totalPositive,
          paymentMethod,
          cardTxn,
          name,
          phone,
          email,
          cartItemsSnapshot:snapshot,
          originalOrderMeta:currentReturnOrderMeta
        });
      }else{
        showCheckoutAlert("Error placing order. Check console.");
      }
    }finally{
      btnCheckoutConfirm.disabled = false;
      btnCheckoutConfirm.textContent = "Confirm & place order";
    }
  }

  function updateModeUI(){
    if(currentMode==="sale"){
      modeSaleBtn.classList.add("mode-pill-active");
      modeReturnBtn.classList.remove("mode-pill-active");
      leftCardTitleEl.textContent = "Products";
      leftCardSubtitleEl.textContent = "Scan barcode, type a code, or tap an item to add to cart.";
      codeInputLabelEl.textContent = "Scan or type product code";
      codeInputHintEl.textContent = "Works with barcode scanners that behave like a keyboard and send Enter after scanning.";
      cartCardTitleEl.textContent = "Cart";
      cartCardSubtitleEl.textContent = "Adjust quantities or remove items. Proceed to add customer & payment details.";
      summarySubtotalLabelEl.textContent = "Subtotal";
      summaryTotalLabelEl.textContent = "Total";
      summaryPaymentLabelEl.textContent = "Payment method";
      returnNoteEl.style.display = "none";
      subtitleEl.textContent = "POS — Sale mode. Every sale is stored in the system.";
      productsListEl.style.display = "block";
      topSearchEl.disabled = false;
      topSearchEl.placeholder = "Search products (name/code)";
      btnOpenCheckoutTop.textContent = "Proceed";
      btnOpenCheckoutSecondary.textContent = "Proceed";
      returnFullRowEl.style.display = "none";
    }else{
      modeSaleBtn.classList.remove("mode-pill-active");
      modeReturnBtn.classList.add("mode-pill-active");
      leftCardTitleEl.textContent = "Returns";
      leftCardSubtitleEl.textContent = "Enter or scan the original order ID or customer phone, then choose full or partial refund.";
      codeInputLabelEl.textContent = "Order ID or customer phone";
      codeInputHintEl.textContent = "Use the printed order ID (e.g. 1507-3) or the customer's phone.";
      cartCardTitleEl.textContent = "Return cart";
      cartCardSubtitleEl.textContent = "Set the quantity to return for each item, then refund.";
      summarySubtotalLabelEl.textContent = "Refund subtotal";
      summaryTotalLabelEl.textContent = "Refund total";
      summaryPaymentLabelEl.textContent = "Refund method";
      returnNoteEl.style.display = "block";
      subtitleEl.textContent = "POS — Return mode. Refunds are stored as negative totals linked to the original order.";
      productsListEl.style.display = "none";
      topSearchEl.disabled = true;
      topSearchEl.placeholder = "Products hidden in return mode";
      btnOpenCheckoutTop.textContent = "Refund selected items";
      btnOpenCheckoutSecondary.textContent = "Refund selected items";
      returnFullRowEl.style.display = "flex";
    }
    renderProductsList(topSearchEl.value);
    cartItems = [];
    currentReturnOrderMeta = null;
    renderCart();
    codeInputEl.value = "";
    codeInputEl.focus();
  }

  function prefillLoginFromStorage(){
    try{
      const raw = localStorage.getItem(CRED_KEY);
      if(!raw) return;
      const obj = JSON.parse(raw);
      if(obj && typeof obj === "object"){
        if(obj.username) loginUsernameEl.value = obj.username;
        if(obj.pin) loginPinEl.value = obj.pin;
      }
    }catch(e){
      console.warn("Failed to prefill login from storage",e);
    }
  }

  async function handleLogin(evt){
    evt.preventDefault();
    clearAuthAlert();
    const username = loginUsernameEl.value.trim();
    const pin = loginPinEl.value.trim();
    if(!username || !pin){
      showAuthAlert("Enter username and PIN.");
      return;
    }
    try{
      loginBtn.disabled = true;
      loginBtn.textContent = "Logging in…";

      const posUsersCol = collection(db,"posUsers");
      const qUser = query(
        posUsersCol,
        where("username","==",username),
        where("pin","==",pin),
        limit(1)
      );
      const snap = await getDocs(qUser);
      if(snap.empty){
        showAuthAlert("No POS user found with this username/PIN combination.");
        loginBtn.disabled = false;
        loginBtn.textContent = "Log in";
        return;
      }
      const d = snap.docs[0];
      const u = d.data() || {};
      if(u.isActive === false){
        showAuthAlert("This POS user is disabled.");
        loginBtn.disabled = false;
        loginBtn.textContent = "Log in";
        return;
      }
      if(!u.brandId || !u.branchId){
        showAuthAlert("POS user is missing brand or branch assignment (brandId/branchId).");
        loginBtn.disabled = false;
        loginBtn.textContent = "Log in";
        return;
      }

      try{
        localStorage.setItem(CRED_KEY, JSON.stringify({username, pin}));
      }catch(e){
        console.warn("Failed to store credentials",e);
      }

      posUser = {
        id:d.id,
        username:u.username,
        displayName:u.displayName || u.username,
        role:u.role || "cashier"
      };
      brandId = u.brandId;
      branchId = u.branchId;

      authWrapper.style.display = "none";
      shellEl.style.display = "flex";
      document.body.style.alignItems = "flex-start";

      userNameEl.textContent = posUser.displayName;
      userRoleEl.textContent = posUser.role;
      userInitialsEl.textContent = initialsFromNameOrUsername(posUser.displayName,posUser.username);

      await loadBrandAndBranch();
      await loadProducts();
      loadOfflineOrders();

      codeInputEl.focus();
    }catch(err){
      console.error("POS login error:", err);
      let msg = "Login error.";
      if(err.code === "permission-denied"){
        msg = "Firestore rules are blocking access to posUsers. Allow read on posUsers for authenticated POS clients (anonymous auth is used).";
      }
      showAuthAlert(msg + (err.code ? ` (${err.code})` : ""));
    }finally{
      loginBtn.disabled = false;
      loginBtn.textContent = "Log in";
    }
  }

  function initEvents(){
    loginForm.addEventListener("submit",handleLogin);

    btnAddCode.addEventListener("click",()=>{
      if(currentMode==="sale"){
        handleAddByCodeSale();
      }else{
        handleLoadOrderForReturn();
      }
    });
    codeInputEl.addEventListener("keydown",(e)=>{
      if(e.key==="Enter"){
        e.preventDefault();
        if(currentMode==="sale"){
          handleAddByCodeSale();
        }else{
          handleLoadOrderForReturn();
        }
      }
    });

    btnClearCart.addEventListener("click",()=>{
      cartItems = [];
      currentReturnOrderMeta = null;
      renderCart();
      codeInputEl.focus();
    });

    topSearchEl.addEventListener("input",()=>{
      renderProductsList(topSearchEl.value);
    });

    const openCheckout = ()=>openCheckoutModal();
    btnOpenCheckoutTop.addEventListener("click",openCheckout);
    btnOpenCheckoutSecondary.addEventListener("click",openCheckout);

    btnCheckoutCancel.addEventListener("click",()=>{
      closeCheckoutModal();
      codeInputEl.focus();
    });

    btnCheckoutConfirm.addEventListener("click",handlePlaceOrder);

    checkoutNameEl.addEventListener("input",()=>searchCustomersForSuggestions(checkoutNameEl.value));
    checkoutPhoneEl.addEventListener("input",()=>searchCustomersForSuggestions(checkoutPhoneEl.value));
    checkoutEmailEl.addEventListener("input",()=>searchCustomersForSuggestions(checkoutEmailEl.value));

    checkoutModal.addEventListener("click",(e)=>{
      if(e.target === checkoutModal){
        closeCheckoutModal();
        codeInputEl.focus();
      }
    });

    // Product modal events
    productModalCancelBtn.addEventListener("click",()=>{
      closeProductModal();
    });
    productModalAddBtn.addEventListener("click",()=>{
      if(!currentProductForModal) return;
      const variant = getSelectedVariantForCurrentProduct();
      addProductToCart(currentProductForModal,1,variant);
      closeProductModal();
    });
    productModalEl.addEventListener("click",(e)=>{
      if(e.target === productModalEl){
        closeProductModal();
      }
    });

    modeSaleBtn.addEventListener("click",()=>{
      if(currentMode!=="sale"){
        currentMode = "sale";
        updateModeUI();
      }
    });
    modeReturnBtn.addEventListener("click",()=>{
      if(currentMode!=="return"){
        currentMode = "return";
        updateModeUI();
      }
    });

    btnReturnFull.addEventListener("click",()=>{
      if(currentMode!=="return"){
        showGlobalAlert("Full refund is only available in return mode.","error");
        return;
      }
      if(!currentReturnOrderMeta){
        showGlobalAlert("Load an order first before returning full order.","error");
        return;
      }
      if(cartItems.length===0){
        showGlobalAlert("No items loaded from this order.","error");
        return;
      }
      cartItems.forEach(i=>{
        if(i.originalQty != null){
          i.qty = i.originalQty;
        }
      });
      renderCart();
      openCheckoutModal();
    });

    window.addEventListener("online",()=>{
      renderOfflineOrders();
      showGlobalAlert("Back online. You can sync queued orders from the offline banner.","info");
    });
    window.addEventListener("offline",()=>{
      renderOfflineOrders();
      showGlobalAlert("You are offline. New orders will be queued locally.","error");
    });
  }

  function init(){
    prefillLoginFromStorage();
    initEvents();
    updateModeUI();
  }

  init();
  </script>
</body>
</html>
