<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"/>
  <title>Luma Store OS — POS</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#020617;
      --panel:#020617;
      --panel-soft:#0b1220;
      --surface:#020617;
      --border:rgba(148,163,184,.35);
      --ink:#e5e7eb;
      --muted:#9ca3af;
      --accent:#38bdf8;
      --accent-strong:#0ea5e9;
      --danger:#ef4444;
      --radius:16px;
      --shadow:0 30px 80px rgba(15,23,42,.8);
      --success:#22c55e;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{
      height:100%;
      font-family:"Montserrat",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#020617,#000 70%);
      color:var(--ink);
    }
    body{
      display:flex;
      min-height:100vh;
      padding:12px;
    }
    .shell{
      flex:1;
      max-width:1280px;
      margin:0 auto;
      border-radius:24px;
      background:radial-gradient(circle at top,#020617,#000 70%);
      border:1px solid rgba(148,163,184,.4);
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .topbar{
      padding:10px 14px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      backdrop-filter:blur(18px);
      background:linear-gradient(to right,rgba(15,23,42,.85),rgba(15,23,42,.9));
    }
    .topbar-left{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .luma-chip{
      width:30px;height:30px;border-radius:999px;
      background:linear-gradient(135deg,#38bdf8,#a855f7);
      display:flex;align-items:center;justify-content:center;
      font-size:16px;font-weight:700;
    }
    .top-title{
      font-size:14px;font-weight:600;
    }
    .top-subtitle{
      font-size:11px;color:var(--muted);
    }
    .topbar-right{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .badge{
      font-size:10px;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.6);
      color:var(--muted);
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .badge-dot{
      width:6px;height:6px;border-radius:999px;
      background:var(--success);
    }
    .user-chip{
      display:flex;
      align-items:center;
      gap:6px;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(15,23,42,.7);
      font-size:11px;
    }
    .user-initials{
      width:22px;height:22px;border-radius:999px;
      background:rgba(56,189,248,.18);
      display:flex;align-items:center;justify-content:center;
      font-size:11px;font-weight:600;color:#e0f2fe;
    }
    .user-text{
      display:flex;flex-direction:column;
    }
    .user-name{
      font-size:11px;font-weight:500;
    }
    .user-role{
      font-size:10px;color:var(--muted);
    }
    .btn{
      border:none;
      border-radius:999px;
      padding:6px 10px;
      font-size:11px;
      font-weight:600;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      white-space:nowrap;
    }
    .btn-primary{
      background:var(--accent);
      color:#0b1120;
    }
    .btn-primary:hover{
      background:var(--accent-strong);
    }
    .btn-ghost{
      background:transparent;
      color:var(--muted);
      border:1px solid rgba(148,163,184,.6);
    }
    .btn-ghost:hover{
      background:rgba(15,23,42,.8);
    }
    .btn-toggle{
      background:rgba(15,23,42,.8);
      color:var(--muted);
      border:1px solid rgba(148,163,184,.6);
      padding:4px 9px;
      font-size:10px;
    }
    .btn-toggle.active{
      background:var(--accent);
      color:#0b1120;
      border-color:var(--accent-strong);
    }

    .body{
      flex:1;
      min-height:0;
      position:relative;
    }

    .layout-sale{
      height:100%;
      display:grid;
      grid-template-columns:3fr 2fr;
      gap:0;
    }
    .layout-return{
      height:100%;
      display:none;
      flex-direction:column;
      padding:10px 12px;
      background:radial-gradient(circle at top,#020617,#000 70%);
    }

    @media(max-width:960px){
      .layout-sale{
        grid-template-columns:1fr;
      }
    }

    .left{
      border-right:1px solid var(--border);
      display:flex;
      flex-direction:column;
      min-width:0;
      background:radial-gradient(circle at top left,#020617,#020617 55%,#000 100%);
    }
    .right{
      display:flex;
      flex-direction:column;
      background:radial-gradient(circle at top right,#020617,#020617 55%,#000 100%);
    }

    .search-row{
      padding:10px 12px 6px;
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .search-input{
      flex:1;
      min-width:160px;
      padding:7px 9px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(15,23,42,.8);
      color:var(--ink);
      font-size:11px;
    }
    .search-input::placeholder{
      color:var(--muted);
    }
    .search-input:focus{
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(56,189,248,.3);
    }
    .code-input{
      width:130px;
      padding:7px 9px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(15,23,42,.8);
      color:var(--ink);
      font-size:11px;
    }

    .suggestions{
      padding:0 12px 4px;
      max-height:80px;
      overflow:auto;
      font-size:11px;
    }
    .suggestion-item{
      padding:3px 6px;
      border-radius:8px;
      cursor:pointer;
      display:flex;
      justify-content:space-between;
      gap:8px;
    }
    .suggestion-item:hover{
      background:rgba(15,23,42,.9);
    }

    .products-grid{
      flex:1;
      padding:6px 10px 10px;
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(120px,1fr));
      gap:8px;
      overflow:auto;
    }
    .product-card{
      background:rgba(15,23,42,.9);
      border-radius:14px;
      border:1px solid rgba(30,64,175,.6);
      padding:7px;
      display:flex;
      flex-direction:column;
      gap:4px;
      cursor:pointer;
      transition:transform .05s ease,box-shadow .1s ease,border-color .1s ease;
    }
    .product-card:hover{
      transform:translateY(-1px);
      box-shadow:0 10px 25px rgba(15,23,42,.9);
      border-color:var(--accent);
    }
    .product-image-wrapper{
      width:100%;
      height:60px;
      border-radius:10px;
      overflow:hidden;
      background:radial-gradient(circle at top,#020617,#020617 60%,#000 100%);
      display:flex;
      align-items:center;
      justify-content:center;
      margin-bottom:3px;
    }
    .product-image{
      max-width:100%;
      max-height:100%;
      object-fit:contain;
    }
    .product-name{
      font-size:11px;font-weight:500;
    }
    .product-price{
      font-size:11px;color:#bae6fd;
    }
    .product-stock{
      font-size:10px;color:var(--muted);
    }
    .product-variant{
      font-size:10px;color:var(--muted);
    }

    .cart-header{
      padding:8px 12px 4px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      flex-wrap:wrap;
    }
    .cart-title{
      font-size:13px;font-weight:600;
    }
    .cart-sub{
      font-size:10px;color:var(--muted);
    }

    .customer-row{
      padding:6px 12px 6px;
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:6px;
      font-size:10px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .field-label{
      font-size:10px;color:var(--muted);
    }
    .field-input,.field-select,.field-textarea{
      padding:6px 8px;
      border-radius:10px;
      border:1px solid var(--border);
      background:rgba(15,23,42,.8);
      color:var(--ink);
      font-size:10px;
    }
    .field-textarea{
      resize:vertical;
      min-height:42px;
    }
    .field-input::placeholder,.field-textarea::placeholder{
      color:var(--muted);
    }
    .field-input:focus,.field-select:focus,.field-textarea:focus{
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(56,189,248,.3);
    }

    .meta-row{
      padding:0 12px 6px;
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:6px;
      font-size:10px;
    }

    .cart-body{
      flex:1;
      padding:6px 10px;
      overflow:auto;
    }
    .cart-item{
      display:grid;
      grid-template-columns:1fr auto auto;
      gap:6px;
      align-items:center;
      padding:6px 8px;
      border-radius:10px;
      background:rgba(15,23,42,.85);
      border:1px solid rgba(30,64,175,.6);
      font-size:11px;
      margin-bottom:6px;
    }
    .cart-item-name{
      font-weight:500;
    }
    .cart-item-meta{
      font-size:10px;color:var(--muted);
    }
    .qty-controls{
      display:flex;align-items:center;gap:4px;
    }
    .qty-btn{
      width:20px;height:20px;border-radius:999px;
      border:1px solid rgba(148,163,184,.6);
      background:transparent;
      color:var(--muted);
      font-size:12px;
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;
    }
    .qty-value{
      font-size:11px;
      min-width:16px;
      text-align:center;
    }
    .cart-item-price{
      text-align:right;
      font-size:11px;
    }
    .cart-empty{
      font-size:11px;color:var(--muted);
      text-align:center;
      margin-top:18px;
    }

    .totals{
      padding:8px 12px 10px;
      border-top:1px solid var(--border);
      background:linear-gradient(to top,rgba(15,23,42,.95),rgba(15,23,42,.9));
    }
    .totals-row{
      display:flex;
      justify-content:space-between;
      font-size:11px;
      margin-bottom:3px;
      color:var(--muted);
    }
    .totals-row strong{
      color:var(--ink);
    }
    .totals-main{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:4px;
      gap:8px;
    }
    .total-amount{
      font-size:16px;font-weight:700;
    }
    .totals-actions{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      justify-content:flex-end;
    }
    .toggle-pill{
      display:flex;
      align-items:center;
      gap:4px;
      font-size:10px;
      color:var(--muted);
    }
    .toggle-pill input{
      width:14px;height:14px;
      accent-color:var(--accent);
      cursor:pointer;
    }

    .alert{
      font-size:11px;
      padding:6px 8px;
      border-radius:10px;
      margin-top:6px;
    }
    .alert-info{
      background:rgba(59,130,246,.1);
      border:1px solid rgba(59,130,246,.5);
      color:#bfdbfe;
    }
    .alert-error{
      background:rgba(248,113,113,.1);
      border:1px solid rgba(248,113,113,.7);
      color:#fecaca;
    }
    .alert-success{
      background:rgba(74,222,128,.1);
      border:1px solid rgba(34,197,94,.7);
      color:#bbf7d0;
    }

    /* RETURN LAYOUT */
    .return-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      padding-bottom:6px;
      border-bottom:1px solid var(--border);
    }
    .return-title{
      font-size:13px;font-weight:600;
    }
    .return-sub{
      font-size:10px;color:var(--muted);
    }
    .return-body{
      flex:1;
      display:flex;
      flex-direction:column;
      padding-top:8px;
      gap:8px;
      overflow:auto;
    }
    .return-search-row{
      display:grid;
      grid-template-columns:2fr 1fr auto;
      gap:6px;
      font-size:10px;
    }
    .return-order-summary{
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(15,23,42,.9);
      padding:8px 9px;
      font-size:11px;
    }
    .return-items{
      margin-top:6px;
      font-size:10px;
    }
    .return-item{
      display:flex;
      justify-content:space-between;
      margin-bottom:3px;
    }
    .return-footer{
      padding-top:4px;
      border-top:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      font-size:10px;
    }
  </style>
</head>
<body>
<div class="shell">
  <header class="topbar">
    <div class="topbar-left">
      <div class="luma-chip">L</div>
      <div>
        <div class="top-title">Luma Store OS — POS</div>
        <div class="top-subtitle" id="top-subtitle">Loading brand & branch…</div>
      </div>
    </div>
    <div class="topbar-right">
      <span class="badge" id="tax-service-pill">Tax 0% • Service 0%</span>

      <div class="badge" id="mode-pill">
        <button id="btn-mode-sale" class="btn-toggle active" type="button">Sale</button>
        <button id="btn-mode-return" class="btn-toggle" type="button">Return</button>
      </div>

      <button id="btn-sync-queue" class="btn-ghost" style="font-size:10px;">
        Offline queue <span id="queue-count-badge">(0)</span>
      </button>

      <div class="user-chip">
        <div class="user-initials" id="user-initials">CA</div>
        <div class="user-text">
          <div class="user-name" id="user-name">Cashier</div>
          <div class="user-role" id="user-role">POS</div>
        </div>
      </div>
      <button id="btn-logout" class="btn btn-ghost">Logout</button>
    </div>
  </header>

  <div class="body">
    <!-- SALE LAYOUT -->
    <div id="layout-sale" class="layout-sale">
      <section class="left">
        <div class="search-row">
          <input id="search-input" class="search-input" placeholder="Search products by name, SKU, or code…"/>
          <input id="code-input" class="code-input" placeholder="Code / barcode…"/>
          <button id="btn-clear-search" class="btn btn-ghost" style="font-size:10px;">Clear</button>
        </div>
        <div id="suggestions" class="suggestions"></div>
        <div id="products-grid" class="products-grid">
          <!-- products -->
        </div>
      </section>

      <section class="right">
        <div class="cart-header">
          <div>
            <div class="cart-title">Cart</div>
            <div class="cart-sub" id="cart-sub">No items yet</div>
          </div>
          <button id="btn-clear-cart" class="btn btn-ghost" style="font-size:10px;">Clear cart</button>
        </div>

        <div class="customer-row">
          <div class="field">
            <label class="field-label">Customer phone</label>
            <input id="customer-phone" class="field-input" placeholder="0100..." />
          </div>
          <div class="field">
            <label class="field-label">Customer name</label>
            <input id="customer-name" class="field-input" placeholder="Optional" />
          </div>
        </div>

        <div class="meta-row">
          <div class="field">
            <label class="field-label">Payment method</label>
            <select id="payment-method" class="field-select">
              <option value="cash">Cash</option>
              <option value="card">Card</option>
              <option value="wallet">Wallet</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="field">
            <label class="field-label">Discount</label>
            <select id="discount-type" class="field-select">
              <option value="none">None</option>
              <option value="percent">Percent %</option>
              <option value="fixed">Fixed</option>
            </select>
          </div>
          <div class="field">
            <label class="field-label">Discount value</label>
            <input id="discount-value" class="field-input" type="number" placeholder="0"/>
          </div>
        </div>

        <div class="customer-row">
          <div class="field" style="grid-column:1/-1;">
            <label class="field-label">Order note</label>
            <textarea id="order-note" class="field-textarea" placeholder="Optional note for kitchen / admin…"></textarea>
          </div>
        </div>

        <div id="cart-body" class="cart-body">
          <div class="cart-empty">Start by tapping a product on the left.</div>
        </div>

        <div class="totals">
          <div class="totals-row">
            <span>Subtotal</span><span id="subtotal-amount">0</span>
          </div>
          <div class="totals-row">
            <span>Discount</span><span id="discount-amount">0</span>
          </div>
          <div class="totals-row">
            <span>Tax</span><span id="tax-amount">0</span>
          </div>
          <div class="totals-row">
            <span>Service</span><span id="service-amount">0</span>
          </div>
          <div class="totals-main">
            <div>
              <div class="total-amount" id="total-amount">0</div>
              <div class="top-subtitle" style="font-size:10px;">EGP (or brand default currency)</div>
            </div>
            <div class="totals-actions">
              <label class="toggle-pill">
                <input id="send-email-receipt" type="checkbox" checked/>
                <span>Email receipt</span>
              </label>
              <label class="toggle-pill">
                <input id="send-whatsapp-receipt" type="checkbox" checked/>
                <span>WhatsApp receipt</span>
              </label>
              <button id="btn-complete" class="btn btn-primary">Complete order</button>
            </div>
          </div>
          <div id="pos-alert"></div>
        </div>
      </section>
    </div>

    <!-- RETURN LAYOUT -->
    <div id="layout-return" class="layout-return">
      <div class="return-header">
        <div>
          <div class="return-title">Return / refund</div>
          <div class="return-sub">Find an order by ID or customer phone, then choose full or partial refund.</div>
        </div>
        <button id="btn-cancel-return" class="btn btn-ghost" style="font-size:10px;">Back to sale</button>
      </div>

      <div class="return-body">
        <div class="return-search-row">
          <input id="return-order-id" class="field-input" placeholder="Order ID (document ID)"/>
          <input id="return-phone" class="field-input" placeholder="or Customer phone"/>
          <button id="btn-find-order" class="btn btn-primary">Find order</button>
        </div>

        <div id="return-alert"></div>

        <div id="return-summary" class="return-order-summary" style="display:none;">
          <div id="return-summary-main"></div>
          <div class="return-items" id="return-items"></div>
          <div class="return-footer">
            <div>
              <div style="margin-bottom:4px;">Refund options:</div>
              <button id="btn-full-refund" class="btn btn-primary" style="font-size:10px;">Full refund</button>
            </div>
            <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
              <div class="field" style="min-width:130px;">
                <label class="field-label">Partial refund amount</label>
                <input id="partial-refund-amount" class="field-input" type="number" placeholder="0"/>
              </div>
              <button id="btn-partial-refund" class="btn btn-ghost" style="font-size:10px;">Partial refund</button>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getFirestore,
    collection,
    doc,
    getDoc,
    getDocs,
    setDoc,
    serverTimestamp,
    query,
    where,
    updateDoc
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import {
    getAuth,
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA80bAAGPuyscnTVS-zwrxE9Jp3tPiS1gM",
    authDomain: "events-339ce.firebaseapp.com",
    projectId: "events-339ce",
    storageBucket: "events-339ce.firebasestorage.app",
    messagingSenderId: "175601544315",
    appId: "1:175601544315:web:00c94b4affa972b3a286de"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // DOM
  const layoutSale = document.getElementById("layout-sale");
  const layoutReturn = document.getElementById("layout-return");
  const btnModeSale = document.getElementById("btn-mode-sale");
  const btnModeReturn = document.getElementById("btn-mode-return");

  const productsGrid = document.getElementById("products-grid");
  const searchInput = document.getElementById("search-input");
  const codeInput = document.getElementById("code-input");
  const btnClearSearch = document.getElementById("btn-clear-search");
  const suggestionsEl = document.getElementById("suggestions");

  const cartBody = document.getElementById("cart-body");
  const cartSub = document.getElementById("cart-sub");
  const subtotalEl = document.getElementById("subtotal-amount");
  const taxEl = document.getElementById("tax-amount");
  const serviceEl = document.getElementById("service-amount");
  const totalEl = document.getElementById("total-amount");
  const discountAmountEl = document.getElementById("discount-amount");
  const posAlert = document.getElementById("pos-alert");
  const taxServicePill = document.getElementById("tax-service-pill");
  const topSubtitleEl = document.getElementById("top-subtitle");
  const userInitialsEl = document.getElementById("user-initials");
  const userNameEl = document.getElementById("user-name");
  const userRoleEl = document.getElementById("user-role");
  const btnLogout = document.getElementById("btn-logout");
  const btnClearCart = document.getElementById("btn-clear-cart");
  const btnComplete = document.getElementById("btn-complete");

  const customerPhoneEl = document.getElementById("customer-phone");
  const customerNameEl = document.getElementById("customer-name");
  const paymentMethodEl = document.getElementById("payment-method");
  const discountTypeEl = document.getElementById("discount-type");
  const discountValueEl = document.getElementById("discount-value");
  const orderNoteEl = document.getElementById("order-note");
  const sendEmailReceiptEl = document.getElementById("send-email-receipt");
  const sendWhatsappReceiptEl = document.getElementById("send-whatsapp-receipt");

  // Return DOM
  const returnOrderIdEl = document.getElementById("return-order-id");
  const returnPhoneEl = document.getElementById("return-phone");
  const btnFindOrder = document.getElementById("btn-find-order");
  const btnCancelReturn = document.getElementById("btn-cancel-return");
  const returnAlertEl = document.getElementById("return-alert");
  const returnSummaryEl = document.getElementById("return-summary");
  const returnSummaryMainEl = document.getElementById("return-summary-main");
  const returnItemsEl = document.getElementById("return-items");
  const btnFullRefund = document.getElementById("btn-full-refund");
  const btnPartialRefund = document.getElementById("btn-partial-refund");
  const partialRefundAmountEl = document.getElementById("partial-refund-amount");

  const btnSyncQueue = document.getElementById("btn-sync-queue");
  const queueCountBadge = document.getElementById("queue-count-badge");

  let allProducts = [];
  let filteredProducts = [];
  let cart = [];
  let brandId = null;
  let branchId = null;
  let taxPercent = 0;
  let servicePercent = 0;
  let mode = "sale"; // sale | return
  let currentReturnOrder = null;

  const QUEUE_KEY = "luma_pos_offline_queue";

  function getQueue(){
    try{
      const raw = localStorage.getItem(QUEUE_KEY);
      if(!raw) return [];
      return JSON.parse(raw) || [];
    }catch(e){
      console.error(e);
      return [];
    }
  }
  function setQueue(q){
    try{
      localStorage.setItem(QUEUE_KEY, JSON.stringify(q || []));
    }catch(e){
      console.error(e);
    }
    updateQueueBadge();
  }
  function updateQueueBadge(){
    const q = getQueue();
    queueCountBadge.textContent = `(${q.length})`;
  }

  function showAlert(message,type="info",target=posAlert){
    let cls = "alert-info";
    if(type === "error") cls = "alert-error";
    if(type === "success") cls = "alert-success";
    target.innerHTML = `<div class="alert ${cls}">${message}</div>`;
    if(type !== "error"){
      setTimeout(()=>{ target.innerHTML = ""; },2500);
    }
  }

  function initialsFromNameOrEmail(name,email){
    if(name){
      const parts = name.split(" ").filter(Boolean);
      if(parts.length >= 2) return (parts[0][0]+parts[1][0]).toUpperCase();
      return name.slice(0,2).toUpperCase();
    }
    if(email){
      const part = email.split("@")[0] || "";
      return part.slice(0,2).toUpperCase();
    }
    return "CA";
  }

  function formatAmount(n){
    return (n || 0).toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:0});
  }

  function setMode(newMode){
    mode = newMode;
    if(mode === "sale"){
      layoutSale.style.display = "grid";
      layoutReturn.style.display = "none";
      btnModeSale.classList.add("active");
      btnModeReturn.classList.remove("active");
    }else{
      layoutSale.style.display = "none";
      layoutReturn.style.display = "flex";
      btnModeSale.classList.remove("active");
      btnModeReturn.classList.add("active");
      // Reset return UI
      currentReturnOrder = null;
      returnOrderIdEl.value = "";
      returnPhoneEl.value = "";
      returnSummaryEl.style.display = "none";
      returnAlertEl.innerHTML = "";
    }
  }

  function renderProducts(){
    productsGrid.innerHTML = "";
    const list = filteredProducts.length ? filteredProducts : allProducts;
    if(!list.length){
      productsGrid.innerHTML = `<div style="grid-column:1/-1;font-size:11px;color:var(--muted);text-align:center;margin-top:20px;">No products found. Add products from the brand dashboard.</div>`;
      return;
    }
    for(const p of list){
      const card = document.createElement("div");
      card.className = "product-card";
      card.dataset.id = p.id;
      card.innerHTML = `
        <div class="product-image-wrapper">
          ${
            p.imageUrl
              ? `<img src="${p.imageUrl}" class="product-image" alt="${p.name || "Product"}"/>`
              : `<span style="font-size:10px;color:var(--muted);">No image</span>`
          }
        </div>
        <div class="product-name">${p.name || "Unnamed"}</div>
        <div class="product-price">${formatAmount(p.price || 0)}</div>
        <div class="product-stock">Stock: ${p.stock ?? "—"}</div>
        ${p.variantSummary ? `<div class="product-variant">${p.variantSummary}</div>` : ""}
      `;
      card.addEventListener("click",()=>addToCart(p));
      productsGrid.appendChild(card);
    }
  }

  function renderSuggestions(queryText){
    suggestionsEl.innerHTML = "";
    const q = queryText.trim().toLowerCase();
    if(!q){
      return;
    }
    const matches = allProducts
      .filter(p=>{
        const hay = `${p.name||""} ${p.sku||""} ${p.code||""}`.toLowerCase();
        return hay.includes(q);
      })
      .slice(0,10);
    if(!matches.length) return;
    matches.forEach(p=>{
      const div = document.createElement("div");
      div.className = "suggestion-item";
      div.innerHTML = `
        <span>${p.name || "Product"}</span>
        <span>${formatAmount(p.price || 0)}</span>
      `;
      div.addEventListener("click",()=>{
        addToCart(p);
        suggestionsEl.innerHTML = "";
      });
      suggestionsEl.appendChild(div);
    });
  }

  function recomputeTotals(){
    const subtotal = cart.reduce((sum,item)=>sum + (item.price || 0)*item.qty,0);
    let discount = 0;
    const discountType = discountTypeEl.value;
    const dv = parseFloat(discountValueEl.value || "0");
    if(discountType === "percent" && dv > 0){
      discount = subtotal * (dv / 100);
    }else if(discountType === "fixed" && dv > 0){
      discount = dv;
    }
    if(discount > subtotal) discount = subtotal;

    const taxableBase = subtotal - discount;
    const tax = taxableBase * (taxPercent/100);
    const service = taxableBase * (servicePercent/100);
    const total = taxableBase + tax + service;

    subtotalEl.textContent = formatAmount(subtotal);
    discountAmountEl.textContent = formatAmount(discount);
    taxEl.textContent = formatAmount(tax);
    serviceEl.textContent = formatAmount(service);
    totalEl.textContent = formatAmount(total);
    cartSub.textContent = cart.length ? `${cart.length} item(s)` : "No items yet";
  }

  function renderCart(){
    if(!cart.length){
      cartBody.innerHTML = `<div class="cart-empty">Start by tapping a product on the left.</div>`;
      recomputeTotals();
      return;
    }
    const rows = cart.map(item=>{
      return `
      <div class="cart-item" data-id="${item.id}">
        <div>
          <div class="cart-item-name">${item.name || "Item"}</div>
          <div class="cart-item-meta">
            ${item.variantLabel ? `${item.variantLabel} • ` : ""}Unit: ${formatAmount(item.price || 0)}
          </div>
        </div>
        <div class="qty-controls">
          <button class="qty-btn" data-action="dec">-</button>
          <div class="qty-value">${item.qty}</div>
          <button class="qty-btn" data-action="inc">+</button>
        </div>
        <div class="cart-item-price">${formatAmount((item.price || 0)*item.qty)}</div>
      </div>`;
    }).join("");
    cartBody.innerHTML = rows;

    Array.from(cartBody.querySelectorAll(".cart-item")).forEach(el=>{
      const id = el.dataset.id;
      el.querySelectorAll(".qty-btn").forEach(btn=>{
        btn.addEventListener("click",()=>{
          const action = btn.dataset.action;
          const idx = cart.findIndex(i=>i.id === id);
          if(idx === -1) return;
          if(action === "inc") cart[idx].qty++;
          else cart[idx].qty--;
          if(cart[idx].qty <= 0){
            cart.splice(idx,1);
          }
          renderCart();
        });
      });
    });

    recomputeTotals();
  }

  function addToCart(p){
    // In future: show popup to choose variant (size/color) from p.variants
    const existing = cart.find(i=>i.id === p.id);
    if(existing){
      existing.qty++;
    }else{
      cart.push({
        id:p.id,
        name:p.name,
        price:p.price || 0,
        qty:1,
        variantLabel:null // reserved for per-size/color later
      });
    }
    renderCart();
  }

  function clearCart(){
    cart = [];
    renderCart();
  }

  async function loadConfigAndProducts(){
    if(!brandId) return;

    // platform settings (for defaults)
    const platformRef = doc(db,"platformSettings","globalConfig");
    const platformSnap = await getDoc(platformRef);
    let globalTax = 0;
    let globalService = 0;
    if(platformSnap.exists()){
      const d = platformSnap.data() || {};
      globalTax = d.defaultTaxPercent ?? 0;
      globalService = d.defaultServicePercent ?? 0;
    }

    // brand config overrides
    const brandCfgRef = doc(db,"brandConfigs",brandId);
    const brandCfgSnap = await getDoc(brandCfgRef);
    if(brandCfgSnap.exists()){
      const d = brandCfgSnap.data() || {};
      taxPercent = d.taxPercent ?? globalTax;
      servicePercent = d.servicePercent ?? globalService;
    }else{
      taxPercent = globalTax;
      servicePercent = globalService;
    }

    taxServicePill.textContent = `Tax ${taxPercent}% • Service ${servicePercent}%`;

    // brand + branch labels
    const brandRef = doc(db,"brands",brandId);
    const brandSnap = await getDoc(brandRef);
    let brandName = "Brand";
    if(brandSnap.exists()){
      const d = brandSnap.data() || {};
      brandName = d.name || "Brand";
    }
    topSubtitleEl.textContent = `${brandName} • Branch ${branchId || ""}`;

    const productsRef = collection(db,"brands",brandId,"products");
    const snap = await getDocs(productsRef);
    allProducts = [];
    snap.forEach(docSnap=>{
      const d = docSnap.data() || {};
      let variantSummary = "";
      if(d.variants && Array.isArray(d.variants) && d.variants.length){
        // Example: "Size: S/M/L • Color: Black/White"
        const labels = d.variants.map(v=>`${v.name}: ${(v.labels||[]).map(l=>l.name).join("/")}`);
        variantSummary = labels.join(" • ");
      }
      allProducts.push({
        id: docSnap.id,
        name: d.name || "Product",
        price: d.price || 0,
        stock: d.stock ?? null,
        sku: d.sku || "",
        code: d.code || "",
        imageUrl: d.imageUrl || "",
        variants: d.variants || [],
        variantSummary
      });
    });
    filteredProducts = [];
    renderProducts();
    updateQueueBadge();
  }

  function buildOrderPayload(){
    const subtotal = cart.reduce((sum,item)=>sum + (item.price || 0)*item.qty,0);
    const discountType = discountTypeEl.value;
    const dv = parseFloat(discountValueEl.value || "0");
    let discount = 0;
    if(discountType === "percent" && dv > 0){
      discount = subtotal * (dv / 100);
    }else if(discountType === "fixed" && dv > 0){
      discount = dv;
    }
    if(discount > subtotal) discount = subtotal;
    const taxableBase = subtotal - discount;
    const tax = taxableBase * (taxPercent/100);
    const service = taxableBase * (servicePercent/100);
    const total = taxableBase + tax + service;

    return {
      items: cart.map(i=>({
        productId:i.id,
        name:i.name,
        price:i.price,
        qty:i.qty,
        variantLabel:i.variantLabel || null
      })),
      subtotal,
      discount,
      taxPercent,
      servicePercent,
      tax,
      service,
      total,
      customerPhone: customerPhoneEl.value.trim() || null,
      customerName: customerNameEl.value.trim() || null,
      paymentMethod: paymentMethodEl.value,
      orderNote: orderNoteEl.value.trim() || null,
      sendEmailReceipt: !!sendEmailReceiptEl.checked,
      sendWhatsappReceipt: !!sendWhatsappReceiptEl.checked,
      status:"completed",
      source:"pos",
      cashierUserId: auth.currentUser?.uid || null,
      createdAt: serverTimestamp()
    };
  }

  async function saveOrderOnline(orderPayload){
    if(!brandId || !branchId){
      throw new Error("Missing brand/branch for POS user.");
    }
    const ordersColl = collection(db,"brands",brandId,"branches",branchId,"orders");
    const orderRef = doc(ordersColl);
    await setDoc(orderRef, orderPayload);
    return orderRef.id;
  }

  async function completeOrder(){
    if(!cart.length){
      showAlert("Cart is empty.","error");
      return;
    }
    btnComplete.disabled = true;
    btnComplete.textContent = "Saving…";
    try{
      const payload = buildOrderPayload();
      const orderId = await saveOrderOnline(payload);
      clearCart();
      customerPhoneEl.value = "";
      customerNameEl.value = "";
      discountTypeEl.value = "none";
      discountValueEl.value = "";
      orderNoteEl.value = "";
      recomputeTotals();
      showAlert(`Order saved successfully. ID: ${orderId}`,"success");
    }catch(e){
      console.error(e);
      // queue offline
      const payload = buildOrderPayload();
      const q = getQueue();
      q.push({type:"sale", brandId, branchId, payload});
      setQueue(q);
      showAlert("Online save failed. Order added to offline queue.","error");
    }finally{
      btnComplete.disabled = false;
      btnComplete.textContent = "Complete order";
    }
  }

  async function processQueue(){
    const q = getQueue();
    if(!q.length){
      showAlert("No queued orders.","info");
      return;
    }
    btnSyncQueue.disabled = true;
    btnSyncQueue.textContent = "Syncing…";
    let success = 0;
    const remaining = [];
    for(const item of q){
      try{
        if(item.type === "sale"){
          const ordersColl = collection(db,"brands",item.brandId,"branches",item.branchId,"orders");
          const ref = doc(ordersColl);
          await setDoc(ref,item.payload);
        }else if(item.type === "refund"){
          const ordersColl = collection(db,"brands",item.brandId,"branches",item.branchId,"orders");
          const ref = doc(ordersColl);
          await setDoc(ref,item.payload);
          if(item.updateRef){
            const origRef = doc(db,"brands",item.brandId,"branches",item.branchId,"orders",item.updateRef);
            await updateDoc(origRef,item.updateData || {});
          }
        }
        success++;
      }catch(e){
        console.error("Failed to sync queue item",e);
        remaining.push(item);
      }
    }
    setQueue(remaining);
    btnSyncQueue.disabled = false;
    btnSyncQueue.textContent = "Offline queue";
    if(success){
      showAlert(`Synced ${success} item(s) from queue.`,"success");
    }else{
      showAlert("Failed to sync queued items. Still offline?","error");
    }
  }

  function showReturnAlert(message,type="info"){
    showAlert(message,type,returnAlertEl);
  }

  async function findOrderForReturn(){
    if(!brandId || !branchId){
      showReturnAlert("Missing brand/branch for this POS user.","error");
      return;
    }
    const idInput = returnOrderIdEl.value.trim();
    const phoneInput = returnPhoneEl.value.trim();
    if(!idInput && !phoneInput){
      showReturnAlert("Enter order ID or customer phone.","error");
      return;
    }

    currentReturnOrder = null;
    returnSummaryEl.style.display = "none";
    returnItemsEl.innerHTML = "";
    returnSummaryMainEl.innerHTML = "";
    showReturnAlert("Searching…","info");

    try{
      let orderDocSnap = null;
      const ordersColl = collection(db,"brands",brandId,"branches",branchId,"orders");

      if(idInput){
        const ref = doc(ordersColl,idInput);
        const snap = await getDoc(ref);
        if(snap.exists()){
          orderDocSnap = snap;
        }
      }

      if(!orderDocSnap && phoneInput){
        const qRef = query(ordersColl, where("customerPhone","==",phoneInput));
        const qsnap = await getDocs(qRef);
        qsnap.forEach(s=>{
          if(!orderDocSnap) orderDocSnap = s;
        });
      }

      if(!orderDocSnap){
        showReturnAlert("Order not found.","error");
        return;
      }

      const data = orderDocSnap.data() || {};
      if(data.status === "refunded"){
        showReturnAlert("This order is already fully refunded.","error");
      }else if(data.status === "partial_refund"){
        showReturnAlert("This order already has a partial refund.","info");
      }else{
        showReturnAlert("Order found.","success");
      }

      const total = data.total ?? 0;
      const subtotal = data.subtotal ?? 0;
      const tax = data.tax ?? 0;
      const service = data.service ?? 0;

      returnSummaryMainEl.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:8px;">
          <div>
            <div>Order ID: <strong>${orderDocSnap.id}</strong></div>
            <div style="font-size:10px;color:var(--muted);margin-top:2px;">
              Customer: ${data.customerName || "—"} • ${data.customerPhone || "—"}
            </div>
          </div>
          <div style="text-align:right;font-size:11px;">
            <div>Total: <strong>${formatAmount(total)}</strong></div>
            <div style="font-size:10px;color:var(--muted);">Subtotal: ${formatAmount(subtotal)} • Tax: ${formatAmount(tax)} • Service: ${formatAmount(service)}</div>
          </div>
        </div>
      `;

      const items = data.items || [];
      if(items.length){
        returnItemsEl.innerHTML = items.map(i=>`
          <div class="return-item">
            <span>${i.name || "Item"}${i.variantLabel ? " • "+i.variantLabel : ""} × ${i.qty}</span>
            <span>${formatAmount((i.price||0)*i.qty)}</span>
          </div>
        `).join("");
      }else{
        returnItemsEl.innerHTML = `<div style="font-size:10px;color:var(--muted);">No items on this order.</div>`;
      }

      currentReturnOrder = {
        id: orderDocSnap.id,
        data
      };
      returnSummaryEl.style.display = "block";
    }catch(e){
      console.error(e);
      showReturnAlert("Error searching for order.","error");
    }
  }

  async function processRefund(type){
    if(!currentReturnOrder){
      showReturnAlert("Find an order first.","error");
      return;
    }
    const original = currentReturnOrder;
    const data = original.data;

    const ordersColl = collection(db,"brands",brandId,"branches",branchId,"orders");
    const refundRef = doc(ordersColl);
    const basePayload = {
      createdAt: serverTimestamp(),
      source:"pos_refund",
      originalOrderId: original.id,
      cashierUserId: auth.currentUser?.uid || null
    };

    let refundTotal = 0;
    let refundItems = [];
    if(type === "full"){
      refundTotal = data.total ?? 0;
      refundItems = (data.items || []).map(i=>({
        productId:i.productId,
        name:i.name,
        price:i.price,
        qty: -Math.abs(i.qty),
        variantLabel:i.variantLabel || null
      }));
    }else{
      const amount = parseFloat(partialRefundAmountEl.value || "0");
      if(!(amount > 0)){
        showReturnAlert("Enter a valid partial refund amount.","error");
        return;
      }
      refundTotal = amount;
      refundItems = [];
    }

    const refundPayload = {
      ...basePayload,
      items: refundItems,
      total: -Math.abs(refundTotal),
      status:"refund"
    };

    try{
      // Try online first
      await setDoc(refundRef,refundPayload);

      // Update original order status
      const origRef = doc(ordersColl, original.id);
      await updateDoc(origRef,{
        status: type === "full" ? "refunded" : "partial_refund",
        updatedAt: serverTimestamp()
      });

      // For full refund: restock items
      if(type === "full" && Array.isArray(data.items)){
        for(const it of data.items){
          if(!it.productId || !it.qty) continue;
          const pRef = doc(db,"brands",brandId,"products",it.productId);
          try{
            const pSnap = await getDoc(pRef);
            if(pSnap.exists()){
              const pd = pSnap.data() || {};
              const currentStock = pd.stock ?? 0;
              await updateDoc(pRef,{ stock: currentStock + Math.abs(it.qty) });
            }
          }catch(e){
            console.error("Error restocking product",e);
          }
        }
      }

      showReturnAlert("Refund saved successfully.","success");
      currentReturnOrder = null;
      returnSummaryEl.style.display = "none";
      partialRefundAmountEl.value = "";
    }catch(e){
      console.error(e);
      // queue offline
      const q = getQueue();
      q.push({
        type:"refund",
        brandId,
        branchId,
        payload:refundPayload,
        updateRef: original.id,
        updateData:{
          status: type === "full" ? "refunded" : "partial_refund"
        }
      });
      setQueue(q);
      showReturnAlert("Online refund failed. Added to offline queue.","error");
    }
  }

  // EVENTS
  searchInput.addEventListener("input",()=>{
    const q = searchInput.value.trim().toLowerCase();
    if(!q){
      filteredProducts = [];
      renderProducts();
      suggestionsEl.innerHTML = "";
      return;
    }
    filteredProducts = allProducts.filter(p=>{
      const hay = `${p.name||""} ${p.sku||""} ${p.code||""}`.toLowerCase();
      return hay.includes(q);
    });
    renderProducts();
    renderSuggestions(q);
  });

  codeInput.addEventListener("input",()=>{
    const code = codeInput.value.trim().toLowerCase();
    if(!code) return;
    // suggestions based on code/barcode
    const matches = allProducts.filter(p=>{
      const hay = `${p.code||""} ${p.sku||""}`.toLowerCase();
      return hay.includes(code);
    });
    suggestionsEl.innerHTML = "";
    matches.slice(0,10).forEach(p=>{
      const div = document.createElement("div");
      div.className = "suggestion-item";
      div.innerHTML = `
        <span>${p.name || "Product"}</span>
        <span>${formatAmount(p.price || 0)}</span>
      `;
      div.addEventListener("click",()=>{
        addToCart(p);
        codeInput.value = "";
        suggestionsEl.innerHTML = "";
      });
      suggestionsEl.appendChild(div);
    });
  });

  codeInput.addEventListener("keydown",(e)=>{
    if(e.key === "Enter"){
      const code = codeInput.value.trim().toLowerCase();
      if(!code) return;
      const found = allProducts.find(p=>{
        const hay = `${p.code||""} ${p.sku||""}`.toLowerCase();
        return hay === code;
      });
      if(found){
        addToCart(found);
        codeInput.value = "";
        suggestionsEl.innerHTML = "";
      }
    }
  });

  btnClearSearch.addEventListener("click",()=>{
    searchInput.value = "";
    codeInput.value = "";
    filteredProducts = [];
    suggestionsEl.innerHTML = "";
    renderProducts();
  });

  btnClearCart.addEventListener("click",()=>{
    clearCart();
  });

  discountTypeEl.addEventListener("change",recomputeTotals);
  discountValueEl.addEventListener("input",recomputeTotals);

  btnComplete.addEventListener("click",completeOrder);

  btnSyncQueue.addEventListener("click",processQueue);

  btnModeSale.addEventListener("click",()=>setMode("sale"));
  btnModeReturn.addEventListener("click",()=>setMode("return"));
  btnCancelReturn.addEventListener("click",()=>setMode("sale"));
  btnFindOrder.addEventListener("click",findOrderForReturn);
  btnFullRefund.addEventListener("click",()=>processRefund("full"));
  btnPartialRefund.addEventListener("click",()=>processRefund("partial"));

  btnLogout.addEventListener("click",async()=>{
    try{
      await signOut(auth);
    }catch(e){
      console.error(e);
    }finally{
      window.location.href = "login.html";
    }
  });

  onAuthStateChanged(auth, async (user)=>{
    if(!user){
      window.location.href = "login.html";
      return;
    }
    const platformRef = doc(db,"platformUsers",user.uid);
    const snap = await getDoc(platformRef);
    if(!snap.exists()){
      alert("Your POS account is not configured.");
      window.location.href = "login.html";
      return;
    }
    const data = snap.data() || {};
    if(data.role !== "cashier"){
      alert("You are not a POS user.");
      window.location.href = "login.html";
      return;
    }
    brandId = data.brandId || data.brand || null;
    branchId = data.branchId || data.branch || null;

    userNameEl.textContent = data.name || user.email || "Cashier";
    userRoleEl.textContent = "POS";
    userInitialsEl.textContent = initialsFromNameOrEmail(data.name,user.email);

    await loadConfigAndProducts();
    setMode("sale");
  });
</script>
</body>
</html>
