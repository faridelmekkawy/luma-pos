<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Lokamania 5 â€” Registration</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#f3f4f6;
      --ink:#111827;
      --muted:#6b7280;
      --panel:#ffffff;
      --panel-soft:#f9fafb;
      --accent:#f97316;      /* orange */
      --accent-alt:#0f766e;  /* teal */
      --accent-red:#ef4444;
      --accent-soft:#ffedd5;
      --radius-lg:22px;
      --radius-md:14px;
      --shadow-lg:0 22px 55px rgba(15,23,42,0.26);
      --shadow-md:0 14px 30px rgba(15,23,42,0.16);
    }
    *{box-sizing:border-box;margin:0;padding:0;}

    body{
      font-family:"Montserrat",system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
      min-height:100vh;
      background:
        radial-gradient(circle at 10% 0%,rgba(248,250,252,0.9),rgba(248,250,252,0) 40%),
        radial-gradient(circle at 90% 0%,rgba(254,243,199,0.9),rgba(254,243,199,0) 50%),
        radial-gradient(circle at 0% 100%,rgba(191,219,254,0.85),rgba(191,219,254,0) 55%),
        #e5e7eb;
      color:var(--ink);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px 12px;
      overflow-x:hidden;
    }

    .shell{
      position:relative;
      width:100%;
      max-width:980px;
      min-height:520px;
      display:grid;
      grid-template-columns:minmax(0,3fr) minmax(0,2.3fr);
      gap:22px;
      align-items:stretch;
    }

    /* Floating playful blobs */
    .blob{
      position:fixed;
      border-radius:999px;
      filter:blur(40px);
      opacity:0.7;
      pointer-events:none;
      z-index:-1;
      animation:floatBlob 18s ease-in-out infinite alternate;
    }
    .blob.orange{
      width:220px;height:220px;
      background:rgba(248,113,22,0.55);
      top:-60px;left:-40px;
    }
    .blob.teal{
      width:260px;height:260px;
      background:rgba(13,148,136,0.5);
      bottom:-80px;right:10%;
      animation-delay:3s;
    }
    .blob.red{
      width:180px;height:180px;
      background:rgba(239,68,68,0.5);
      top:30%;right:-60px;
      animation-delay:6s;
    }
    @keyframes floatBlob{
      0%{transform:translate3d(0,0,0) scale(1);}
      50%{transform:translate3d(10px,-18px,0) scale(1.05);}
      100%{transform:translate3d(-14px,22px,0) scale(1.02);}
    }

    /* Left: hero + copy */
    .hero{
      border-radius:var(--radius-lg);
      background:linear-gradient(145deg,rgba(15,23,42,0.96),rgba(15,23,42,0.88));
      color:#f9fafb;
      padding:22px 22px 20px;
      box-shadow:var(--shadow-lg);
      position:relative;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      gap:16px;
      animation:cardInLeft 0.7s cubic-bezier(0.23,1,0.32,1);
    }
    @keyframes cardInLeft{
      0%{opacity:0;transform:translate3d(-24px,10px,0) scale(0.98);}
      100%{opacity:1;transform:translate3d(0,0,0) scale(1);}
    }

    .hero-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .logo-badge{
      width:56px;height:56px;
      border-radius:999px;
      background:conic-gradient(from 210deg,#f97316,#0f766e,#ef4444,#f97316);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fefce8;
      font-weight:800;
      font-size:16px;
      box-shadow:0 14px 30px rgba(15,23,42,0.6);
      position:relative;
      overflow:hidden;
    }
    .logo-badge::after{
      content:"5";
      position:absolute;
      inset:10px;
      border-radius:999px;
      border:1px solid rgba(248,250,252,0.25);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:24px;
      font-weight:800;
      text-shadow:0 1px 2px rgba(15,23,42,0.7);
    }
    .hero-title-block{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .hero-kicker{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.22em;
      color:rgba(226,232,240,0.78);
    }
    .hero-title{
      font-size:22px;
      font-weight:700;
      letter-spacing:0.04em;
      text-transform:uppercase;
    }

    .hero-list{
      margin-top:12px;
      font-size:12px;
      color:rgba(226,232,240,0.9);
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .hero-list li{
      list-style:none;
      display:flex;
      align-items:flex-start;
      gap:8px;
    }
    .hero-dot{
      width:6px;height:6px;border-radius:999px;
      margin-top:4px;
      background:linear-gradient(135deg,#f97316,#facc15);
    }

    .hero-footer-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-top:12px;
      font-size:11px;
      color:rgba(226,232,240,0.86);
    }
    .hero-tag-row{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }
    .hero-tag{
      font-size:10px;
      padding:4px 8px;
      border-radius:999px;
      background:rgba(15,23,42,0.7);
      border:1px solid rgba(148,163,184,0.4);
    }

    /* Right: form card */
    .form-card{
      border-radius:var(--radius-lg);
      background:rgba(255,255,255,0.96);
      box-shadow:var(--shadow-md);
      padding:18px 18px 20px;
      position:relative;
      overflow:hidden;
      animation:cardInRight 0.7s cubic-bezier(0.23,1,0.32,1);
    }
    @keyframes cardInRight{
      0%{opacity:0;transform:translate3d(24px,10px,0) scale(0.98);}
      100%{opacity:1;transform:translate3d(0,0,0) scale(1);}
    }

    .form-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:10px;
    }
    .form-title-block{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .form-kicker{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.18em;
      color:var(--muted);
    }
    .form-title{
      font-size:18px;
      font-weight:700;
    }
    .badge-soft{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      background:rgba(15,23,42,0.04);
      color:var(--muted);
    }
    .badge-soft.green{
      background:rgba(22,163,74,0.08);
      color:#15803d;
    }

    .steps-row{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:10px;
      margin-bottom:10px;
      color:var(--muted);
    }
    .step-dot{
      width:6px;height:6px;border-radius:999px;
      background:rgba(148,163,184,0.8);
    }
    .step-dot.active{
      background:linear-gradient(135deg,#f97316,#0f766e);
      box-shadow:0 0 0 4px rgba(249,115,22,0.18);
    }

    form{
      margin-top:6px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .field-group{
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:12px;
    }
    .field-label{
      font-size:11px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.12em;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:4px;
    }
    .field-label span.required{
      color:#ef4444;
    }
    .input, select, textarea{
      border-radius:11px;
      border:1px solid #e5e7eb;
      padding:7px 9px;
      font-size:13px;
      font-family:inherit;
      background:var(--panel-soft);
      transition:border-color 0.16s,box-shadow 0.16s,background 0.16s,transform 0.1s;
    }
    textarea{min-height:56px;resize:vertical;}
    .input:focus, select:focus, textarea:focus{
      outline:none;
      border-color:var(--accent-alt);
      box-shadow:0 0 0 1px rgba(15,118,110,0.32);
      background:#fff;
      transform:translateY(-0.5px);
    }
    .field-hint{
      font-size:10px;
      color:var(--muted);
    }

    .radio-row, .checkbox-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:2px;
    }
    .chip-option{
      font-size:11px;
      padding:6px 9px;
      border-radius:999px;
      border:1px solid #e5e7eb;
      background:#fff;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:4px;
      transition:background 0.16s,border-color 0.16s,transform 0.1s,box-shadow 0.16s;
    }
    .chip-option input{
      accent-color:var(--accent-alt);
    }
    .chip-option:hover{
      border-color:rgba(15,118,110,0.4);
      background:#f0fdf4;
      transform:translateY(-0.5px);
      box-shadow:0 6px 16px rgba(15,23,42,0.08);
    }

    .error-text{
      font-size:11px;
      color:#b91c1c;
      margin-top:2px;
    }

    .button-row{
      margin-top:8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .btn-primary{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:9px 14px;
      border-radius:999px;
      border:1px solid transparent;
      font-size:13px;
      font-weight:600;
      cursor:pointer;
      background:radial-gradient(circle at 0 0,#facc15,#f97316 45%,#ef4444 100%);
      color:#111827;
      box-shadow:0 14px 35px rgba(249,115,22,0.45);
      transition:transform 0.12s,box-shadow 0.12s,filter 0.14s;
    }
    .btn-primary:hover{
      transform:translateY(-1px);
      filter:brightness(1.02);
      box-shadow:0 18px 40px rgba(249,115,22,0.6);
    }
    .btn-primary:disabled{
      opacity:0.6;
      cursor:default;
      box-shadow:none;
      transform:none;
    }
    .btn-secondary{
      font-size:11px;
      border:none;
      background:transparent;
      color:var(--muted);
      cursor:pointer;
      text-decoration:underline;
      text-underline-offset:3px;
    }

    .status-line{
      font-size:11px;
      color:var(--muted);
      margin-top:6px;
      min-height:14px;
    }
    .status-line.positive{color:#16a34a;}
    .status-line.negative{color:#b91c1c;}

    /* Success state */
    .success-panel{
      position:absolute;
      inset:0;
      background:radial-gradient(circle at top,#fef9c3,#fffbeb,#f9fafb);
      display:none;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding:22px 16px;
      text-align:center;
    }
    .success-panel.visible{
      display:flex;
      animation:successIn 0.6s cubic-bezier(0.23,1,0.32,1);
    }
    @keyframes successIn{
      0%{opacity:0;transform:translateY(12px) scale(0.98);}
      100%{opacity:1;transform:translateY(0) scale(1);}
    }
    .success-badge{
      width:70px;height:70px;
      border-radius:999px;
      background:conic-gradient(from 215deg,#22c55e,#4ade80,#facc15,#22c55e);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#065f46;
      font-size:28px;
      font-weight:800;
      box-shadow:0 20px 40px rgba(22,163,74,0.4);
      position:relative;
      margin-bottom:14px;
    }
    .success-badge::after{
      content:"";
      position:absolute;
      inset:10px;
      border-radius:999px;
      background:#f0fdf4;
    }
    .success-badge span{
      position:relative;
      z-index:1;
    }
    .success-title{
      font-size:18px;
      font-weight:700;
      margin-bottom:6px;
      color:#111827;
    }
    .success-number{
      font-size:26px;
      font-weight:800;
      letter-spacing:0.12em;
      text-transform:uppercase;
      margin:8px 0;
      color:#0f766e;
    }
    .success-text{
      font-size:12px;
      color:var(--muted);
      max-width:260px;
      margin:0 auto 12px;
    }
    .pill-line{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border-radius:999px;
      padding:5px 10px;
      background:rgba(15,23,42,0.04);
      font-size:11px;
      color:var(--muted);
      margin-bottom:10px;
    }

    /* Confetti */
    .confetti-piece{
      position:fixed;
      width:7px;
      height:14px;
      border-radius:2px;
      opacity:0;
      pointer-events:none;
      animation:confettiFall 1.4s ease-out forwards;
      z-index:40;
    }
    @keyframes confettiFall{
      0%{opacity:0;transform:translate3d(0,-20px,0) rotateZ(0deg);}
      10%{opacity:1;}
      100%{opacity:0;transform:translate3d(0,120vh,0) rotateZ(340deg);}
    }

    /* Avoid zoom on mobile for phone/email inputs */
    @media (max-width:640px){
      input[type="tel"],
      input[type="email"]{
        font-size:16px;
      }
    }

    @media (max-width:840px){
      .shell{
        grid-template-columns:minmax(0,1fr);
        max-width:540px;
      }
      .hero{
        order:-1;
      }
    }
    @media (max-width:480px){
      body{padding:12px 8px;}
      .hero{padding:18px 16px;}
      .form-card{padding:16px 14px 18px;}
      .form-title{font-size:16px;}
      .hero-title{font-size:18px;}
    }
  </style>
</head>
<body>
<div class="blob orange"></div>
<div class="blob teal"></div>
<div class="blob red"></div>

<div class="shell">
  <!-- Left: hero -->
  <aside class="hero">
    <div>
      <div class="hero-header">
        <div class="logo-badge"></div>
        <div class="hero-title-block">
          <div class="hero-kicker">Lokamania tombola</div>
          <div class="hero-title">Registration Â· 5th edition</div>
        </div>
      </div>

      <ul class="hero-list">
        <li>
          <div class="hero-dot"></div>
          <div>Register once Â· receive your unique tombola number on WhatsApp.</div>
        </li>
        <li>
          <div class="hero-dot"></div>
          <div>At the end of the event, one tombola number is randomly drawn to win a reward.</div>
        </li>
      </ul>
    </div>

    <div class="hero-footer-row">
      <div style="font-size:13px;font-weight:600;">Lokamania 5 â€” Registration</div>
      <div class="hero-tag-row">
        <span class="hero-tag">Local brands</span>
        <span class="hero-tag">Streetwear &amp; lifestyle</span>
        <span class="hero-tag">Community</span>
      </div>
    </div>
  </aside>

  <!-- Right: registration form -->
  <section class="form-card" id="formCard">
    <div class="form-header">
      <div class="form-title-block">
        <div class="form-kicker">Start here</div>
        <div class="form-title">Register for Lokamania 5</div>
      </div>
      <div class="badge-soft" id="statusBadge">Connectingâ€¦</div>
    </div>

    <div class="steps-row">
      <div class="step-dot active"></div>
      <div class="step-dot active"></div>
      <div class="step-dot"></div>
      <span>Tell us about you Â· One quick step</span>
    </div>

    <form id="registrationForm" novalidate>
      <div id="fieldsContainer"></div>

      <div class="button-row">
        <button type="submit" class="btn-primary" id="submitBtn">
          <span>Get my tombola number</span>
          <span>âœ¨</span>
        </button>
        <button type="button" class="btn-secondary" id="resetBtn" style="display:none;">Start a new registration</button>
      </div>

      <div class="status-line" id="formStatus"></div>
    </form>

    <!-- Success overlay -->
    <div class="success-panel" id="successPanel">
      <div class="success-badge"><span>â˜…</span></div>
      <div class="success-title">Youâ€™re in!</div>
      <div class="success-number" id="successTambola"></div>
      <div class="success-text">
        Weâ€™ve saved your registration for Lokamania 5.<br/>
        Keep this tombola number and the WhatsApp message â€” weâ€™ll use it for the live draw.
      </div>
      <div class="pill-line">
        <span>ðŸ“±</span>
        <span>Check your WhatsApp for a confirmation message as well.</span>
      </div>
      <button class="btn-primary" type="button" id="successCloseBtn">
        Done Â· Back to home
      </button>
    </div>
  </section>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getDatabase,
    ref,
    get,
    set,
    update,
    push,
    runTransaction
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
  import {
    getAuth,
    signInAnonymously,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey:"AIzaSyA80bAAGPuyscnTVS-zwrxE9Jp3tPiS1gM",
    authDomain:"events-339ce.firebaseapp.com",
    projectId:"events-339ce",
    storageBucket:"events-339ce.firebasestorage.app",
    messagingSenderId:"175601544315",
    appId:"1:175601544315:web:00c94b4affa972b3a286de",
    databaseURL:"https://events-339ce-default-rtdb.europe-west1.firebasedatabase.app"
  };

  const EVENT_ID = "lokamania5";
  const WEBHOOK_URL = ""; // you will fill this later

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  const settingsRef = ref(db, `events/${EVENT_ID}/settings`);
  const registrationsRef = ref(db, `events/${EVENT_ID}/registrations`);
  const tambolaLastRef = ref(db, `events/${EVENT_ID}/settings/tambolaLast`);

  const statusBadge = document.getElementById("statusBadge");
  const fieldsContainer = document.getElementById("fieldsContainer");
  const formStatus = document.getElementById("formStatus");
  const submitBtn = document.getElementById("submitBtn");
  const resetBtn = document.getElementById("resetBtn");
  const registrationForm = document.getElementById("registrationForm");
  const successPanel = document.getElementById("successPanel");
  const successTambola = document.getElementById("successTambola");
  const successCloseBtn = document.getElementById("successCloseBtn");

  let settingsCache = null;
  let isSubmitting = false;

  const DEFAULT_SETTINGS = {
    tambolaStart: 1001,
    tambolaLast: 1000,
    ballotMessageTemplate:
      "Hey {name}! ðŸŽª Thanks for registering at Lokamania 5. Your tombola number is #{number}. Keep this message safe â€“ weâ€™ll use this number when we announce the winner later today.",
    winnerMessageTemplate:
      "Hey {name}! ðŸŽ‰ Your tombola number #{number} has been selected as a winner at Lokamania 5. Please head to the registration desk to claim your prize.",
    fields: {
      name:           { label: "Full name",                               required: true,  enabled: true,  order: 1 },
      phone:          { label: "Phone number (WhatsApp)",                 required: true,  enabled: true,  order: 2 },
      email:          { label: "Email",                                   required: true,  enabled: true,  order: 3 },
      gender:         { label: "Gender",                                  required: true,  enabled: true,  order: 4 },
      city:           { label: "City",                                    required: true,  enabled: true,  order: 5 },
      ageGroup:       { label: "Age group",                               required: true,  enabled: true,  order: 6 },
      schoolOrCollege:{ label: "School / College name",                   required: false, enabled: true,  order: 7 },
      favoriteBrand:  { label: "Favorite brand",                          required: false, enabled: true,  order: 8 },
      favoriteItem:   { label: "Favorite clothing item",                  required: false, enabled: true,  order: 9 },
      brandsNextTime: { label: "Brands you'd love to see next time",      required: false, enabled: true,  order:10 },
      heardAbout:     { label: "How did you hear about Lokamania?",       required: false, enabled: true,  order:11 },
      firstTime:      { label: "Is it your first time in Lokamania?",     required: true,  enabled: true,  order:12 },
      shoppingFocus:  { label: "What are you mainly shopping for today?", required: false, enabled: true,  order:13 }
    }
  };

  signInAnonymously(auth).catch(err=>{
    console.error(err);
    statusBadge.textContent = "Auth error";
  });

  onAuthStateChanged(auth, async (user)=>{
    if(user){
      statusBadge.textContent = "Connected Â· Anonymous";
      await ensureSettings();
      await loadSettingsAndBuildForm();
    }
  });

  async function ensureSettings(){
    const snap = await get(settingsRef);
    if(!snap.exists()){
      await set(settingsRef, DEFAULT_SETTINGS);
    }else{
      const existing = snap.val() || {};
      const merged = structuredClone(DEFAULT_SETTINGS);
      Object.assign(merged, existing);
      merged.fields = { ...DEFAULT_SETTINGS.fields, ...(existing.fields || {}) };
      // Hard-delete old budgetRange field if it exists
      if(merged.fields && merged.fields.budgetRange){
        delete merged.fields.budgetRange;
      }
      await set(settingsRef, merged);
    }
  }

  async function loadSettingsAndBuildForm(){
    const snap = await get(settingsRef);
    settingsCache = snap.val() || DEFAULT_SETTINGS;
    // also make sure budget is not built even if somehow present
    if(settingsCache.fields && settingsCache.fields.budgetRange){
      delete settingsCache.fields.budgetRange;
    }
    buildFormFromSettings(settingsCache.fields || DEFAULT_SETTINGS.fields);
    statusBadge.textContent = "Ready";
    statusBadge.classList.add("green");
  }

  function buildFormFromSettings(fieldsCfg){
    fieldsContainer.innerHTML = "";
    const entries = Object.entries(fieldsCfg).sort((a,b)=>(a[1].order||0)-(b[1].order||0));
    for(const [key,cfg] of entries){
      if(!cfg.enabled) continue;
      const fieldEl = createFieldElement(key, cfg);
      if(fieldEl) fieldsContainer.appendChild(fieldEl);
    }
  }

  function createFieldElement(key, cfg){
    const group = document.createElement("div");
    group.className = "field-group";
    group.dataset.fieldKey = key;

    const labelRow = document.createElement("div");
    labelRow.className = "field-label";
    labelRow.textContent = cfg.label || key;
    if(cfg.required){
      const spanReq = document.createElement("span");
      spanReq.className = "required";
      spanReq.textContent = "*";
      labelRow.appendChild(spanReq);
    }
    group.appendChild(labelRow);

    let inputEl = null;
    let hint = "";

    const baseName = key;

    if(key === "gender"){
      const row = document.createElement("div");
      row.className = "radio-row";
      row.innerHTML = `
        <label class="chip-option">
          <input type="radio" name="${baseName}" value="female"> Female
        </label>
        <label class="chip-option">
          <input type="radio" name="${baseName}" value="male"> Male
        </label>
        <label class="chip-option">
          <input type="radio" name="${baseName}" value="prefer_not"> Prefer not to say
        </label>
      `;
      group.appendChild(row);
      hint = "Select the option youâ€™re most comfortable with.";
    }else if(key === "ageGroup"){
      const select = document.createElement("select");
      select.className = "input";
      select.name = baseName;
      select.innerHTML = `
        <option value="">Select age group</option>
        <option value="13-17">13â€“17</option>
        <option value="18-24">18â€“24</option>
        <option value="25-34">25â€“34</option>
        <option value="35-44">35â€“44</option>
        <option value="45+">45+</option>
      `;
      group.appendChild(select);
      inputEl = select;
    }else if(key === "firstTime"){
      const row = document.createElement("div");
      row.className = "radio-row";
      row.innerHTML = `
        <label class="chip-option">
          <input type="radio" name="${baseName}" value="yes"> Yes, first time
        </label>
        <label class="chip-option">
          <input type="radio" name="${baseName}" value="no"> No, Iâ€™ve been before
        </label>
      `;
      group.appendChild(row);
      hint = "Weâ€™d love to know if youâ€™re new to Lokamania.";
    }else if(key === "heardAbout"){
      const select = document.createElement("select");
      select.className = "input";
      select.name = baseName;
      select.innerHTML = `
        <option value="">Select one</option>
        <option value="instagram">Instagram</option>
        <option value="tiktok">TikTok</option>
        <option value="friend">Friend</option>
        <option value="influencer">Influencer</option>
        <option value="previous_lokamania">Previous Lokamania</option>
        <option value="other">Other</option>
      `;
      group.appendChild(select);
      inputEl = select;
    }else if(key === "favoriteItem"){
      const select = document.createElement("select");
      select.className = "input";
      select.name = baseName;
      select.innerHTML = `
        <option value="">Select item</option>
        <option value="t-shirts">T-shirts / tops</option>
        <option value="hoodies">Hoodies / sweatshirts</option>
        <option value="jeans">Jeans / pants</option>
        <option value="dresses">Dresses</option>
        <option value="abayas">Abayas / modest wear</option>
        <option value="accessories">Accessories / jewelry</option>
        <option value="shoes">Shoes</option>
        <option value="bags">Bags</option>
        <option value="other">Other</option>
      `;
      group.appendChild(select);
      inputEl = select;
    }else if(key === "shoppingFocus"){
      const row = document.createElement("div");
      row.className = "checkbox-row";
      row.innerHTML = `
        <label class="chip-option">
          <input type="checkbox" value="clothes"> Clothes
        </label>
        <label class="chip-option">
          <input type="checkbox" value="accessories"> Accessories
        </label>
        <label class="chip-option">
          <input type="checkbox" value="bags"> Bags
        </label>
        <label class="chip-option">
          <input type="checkbox" value="shoes"> Shoes
        </label>
        <label class="chip-option">
          <input type="checkbox" value="jewelry"> Jewelry
        </label>
        <label class="chip-option">
          <input type="checkbox" value="beauty"> Beauty
        </label>
      `;
      group.appendChild(row);
      hint = "Pick all that apply.";
    }else if(key === "brandsNextTime"){
      const ta = document.createElement("textarea");
      ta.className = "input";
      ta.name = baseName;
      ta.placeholder = "Type brand names or categories youâ€™d love to seeâ€¦";
      group.appendChild(ta);
      inputEl = ta;
    }else{
      const input = document.createElement("input");
      input.className = "input";
      input.name = baseName;
      if(key === "email") input.type = "email";
      else if(key === "phone") input.type = "tel";
      else input.type = "text";

      if(key === "phone"){
        input.placeholder = "+20â€¦";
        hint = "We use this to send your tombola number on WhatsApp.";
      }else if(key === "name"){
        input.placeholder = "Your full name";
      }else if(key === "city"){
        input.placeholder = "e.g. Cairo";
      }else if(key === "schoolOrCollege"){
        input.placeholder = "e.g. GUC, AUC, school nameâ€¦";
      }else if(key === "favoriteBrand"){
        input.placeholder = "Your favorite local or international brand";
      }

      group.appendChild(input);
      inputEl = input;
    }

    const error = document.createElement("div");
    error.className = "error-text";
    error.style.display = "none";
    group.appendChild(error);

    if(hint){
      const hintEl = document.createElement("div");
      hintEl.className = "field-hint";
      hintEl.textContent = hint;
      group.appendChild(hintEl);
    }

    return group;
  }

  function showStatus(msg,type="info"){
    formStatus.textContent = msg;
    formStatus.classList.remove("positive","negative");
    if(type==="positive") formStatus.classList.add("positive");
    if(type==="negative") formStatus.classList.add("negative");
  }

  function clearErrors(){
    document.querySelectorAll(".error-text").forEach(el=>{
      el.style.display="none";
      el.textContent="";
    });
  }

  function setFieldError(key,msg){
    const group = document.querySelector(`.field-group[data-field-key="${key}"]`);
    if(!group) return;
    const err = group.querySelector(".error-text");
    if(err){
      err.textContent = msg;
      err.style.display = "block";
    }
  }

  function getFormData(){
    const data = {};
    const fieldsCfg = settingsCache?.fields || DEFAULT_SETTINGS.fields;

    for(const [key,cfg] of Object.entries(fieldsCfg)){
      if(!cfg.enabled) continue;
      if(key === "gender" || key === "firstTime"){
        const checked = document.querySelector(`input[name="${key}"]:checked`);
        data[key] = checked ? checked.value : "";
      }else if(key === "shoppingFocus"){
        const checked = Array.from(document.querySelectorAll(`.field-group[data-field-key="${key}"] input[type="checkbox"]:checked`));
        data[key] = checked.map(c=>c.value).join(",") || "";
      }else{
        const el = registrationForm.querySelector(`[name="${key}"]`);
        if(el){
          data[key] = el.value.trim();
        }
      }
    }
    return data;
  }

  function validateForm(){
    clearErrors();
    const fieldsCfg = settingsCache?.fields || DEFAULT_SETTINGS.fields;
    const data = getFormData();
    let ok = true;

    for(const [key,cfg] of Object.entries(fieldsCfg)){
      if(!cfg.enabled || !cfg.required) continue;
      const value = data[key];
      if(key === "gender" || key === "firstTime"){
        if(!value){
          setFieldError(key,"Please choose an option.");
          ok = false;
        }
      }else if(key === "shoppingFocus"){
        if(!value){
          setFieldError(key,"Pick at least one.");
          ok = false;
        }
      }else{
        if(!value){
          setFieldError(key,"This field is required.");
          ok = false;
        }
      }
    }

    if(data.phone){
      const phoneNorm = data.phone.replace(/\s+/g,"");
      if(phoneNorm.length < 8){
        setFieldError("phone","Please enter a valid phone.");
        ok = false;
      }else{
        data.phone = phoneNorm;
      }
    }
    if(data.email){
      const emailLower = data.email.toLowerCase();
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if(!re.test(emailLower)){
        setFieldError("email","Please enter a valid email.");
        ok = false;
      }else{
        data.email = emailLower;
      }
    }

    return { ok, data };
  }

  // Duplicate check without index: read once, scan client-side
  async function checkDuplicate(phone,email){
    const snap = await get(registrationsRef);
    const data = snap.val() || {};
    const normPhone = phone ? String(phone).trim() : "";
    const normEmail = email ? String(email).trim().toLowerCase() : "";
    for(const id in data){
      const r = data[id] || {};
      if(normPhone && String(r.phone || "").trim() === normPhone) return true;
      if(normEmail && String(r.email || "").trim().toLowerCase() === normEmail) return true;
    }
    return false;
  }

  async function generateTambolaNumber(){
    const tambolaStart = settingsCache?.tambolaStart ?? DEFAULT_SETTINGS.tambolaStart;
    const result = await runTransaction(tambolaLastRef, current=>{
      if(current === null || current < tambolaStart-1){
        return tambolaStart;
      }
      return current + 1;
    });
    const number = result.snapshot.val();
    settingsCache.tambolaLast = number;
    return number;
  }

  async function postToWebhook(payload){
    if(!WEBHOOK_URL) return;
    try{
      await fetch(WEBHOOK_URL,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify(payload)
      });
    }catch(err){
      console.warn("Webhook error:",err);
    }
  }

  function playConfetti(){
    const colors = ["#f97316","#0f766e","#ef4444","#facc15"];
    for(let i=0;i<70;i++){
      const piece = document.createElement("div");
      piece.className="confetti-piece";
      const color = colors[Math.floor(Math.random()*colors.length)];
      piece.style.background=color;
      const left = Math.random()*100;
      piece.style.left = left+"vw";
      piece.style.transform = `translate3d(0,-20px,0) rotateZ(${Math.random()*360}deg)`;
      piece.style.animationDelay = (Math.random()*0.6)+"s";
      document.body.appendChild(piece);
      setTimeout(()=>{ piece.remove(); },2000);
    }
  }

  registrationForm.addEventListener("submit", async (e)=>{
    e.preventDefault();
    if(isSubmitting) return;
    showStatus("");
    const { ok, data } = validateForm();
    if(!ok){
      showStatus("Please fix the highlighted fields.", "negative");
      return;
    }

    isSubmitting = true;
    submitBtn.disabled = true;
    submitBtn.textContent = "Submittingâ€¦";
    showStatus("Checking your registrationâ€¦");

    try{
      const duplicate = await checkDuplicate(data.phone || "", data.email || "");
      if(duplicate){
        showStatus("It looks like youâ€™ve already registered with this phone or email.", "negative");
        isSubmitting = false;
        submitBtn.disabled = false;
        submitBtn.textContent = "Get my tombola number";
        return;
      }

      const tambolaNumber = await generateTambolaNumber();
      const now = Date.now();

      const firstTimeVal = data.firstTime === "yes"
        ? true
        : (data.firstTime === "no" ? false : undefined);

      const payload = {
        eventId: EVENT_ID,
        tambolaNumber,          // DB field
        createdAt: now,
        filledBy: "guest",
        name: data.name || "",
        phone: data.phone || "",
        email: data.email || "",
        gender: data.gender || "",
        city: data.city || "",
        ageGroup: data.ageGroup || "",
        schoolOrCollege: data.schoolOrCollege || "",
        favoriteBrand: data.favoriteBrand || "",
        favoriteItem: data.favoriteItem || "",
        brandsNextTime: data.brandsNextTime || "",
        heardAbout: data.heardAbout || "",
        firstTime: firstTimeVal,
        shoppingFocus: data.shoppingFocus || ""
      };

      await push(registrationsRef, payload);
      await postToWebhook({
        type:"lokamania_registration",
        eventId:EVENT_ID,
        tombolaNumber:tambolaNumber,
        data:payload
      });

      showSuccess(tambolaNumber);
    }catch(err){
      console.error(err);
      showStatus("Something went wrong while saving. Please try again.", "negative");
      isSubmitting = false;
      submitBtn.disabled = false;
      submitBtn.textContent = "Get my tombola number";
      return;
    }

    isSubmitting = false;
    submitBtn.disabled = false;
    submitBtn.textContent = "Get my tombola number";
  });

  function showSuccess(tambolaNumber){
    // FIX: use the correct variable name
    successTambola.textContent = "#" + tambolaNumber;
    successPanel.classList.add("visible");
    resetBtn.style.display = "inline";
    showStatus("");
    playConfetti();
  }

  successCloseBtn.addEventListener("click", ()=>{
    successPanel.classList.remove("visible");
  });

  resetBtn.addEventListener("click", ()=>{
    registrationForm.reset();
    clearErrors();
    showStatus("");
  });
</script>
</body>
</html>
