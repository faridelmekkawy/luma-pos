<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Lokamania 5 â€” Tombola Winner</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <style>
    :root{
      /* Match registration / dashboard style */
      --bg:#f3f4f6;
      --panel:#ffffff;
      --panel-soft:#f9fafb;
      --ink:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --accent:#f97316;      /* orange */
      --accent-alt:#0f766e;  /* teal */
      --accent-soft:#ffedd5;
      --shadow-lg:0 18px 40px rgba(15,23,42,0.18);
      --radius-lg:22px;
    }

    *{box-sizing:border-box;margin:0;padding:0;}

    body{
      font-family:"Montserrat",system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
      min-height:100vh;
      background:
        radial-gradient(circle at top left,#ffedd5,#f3f4f6 40%,#e0f2fe);
      color:var(--ink);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }

    .frame{
      width:100%;
      max-width:720px;
      background:var(--panel);
      border-radius:32px;
      box-shadow:var(--shadow-lg);
      border:1px solid rgba(148,163,184,0.35);
      padding:22px 22px 20px;
      position:relative;
      overflow:hidden;
    }

    .frame::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:
        radial-gradient(circle at 0 0,rgba(249,115,22,0.12),transparent 60%),
        radial-gradient(circle at 100% 100%,rgba(56,189,248,0.16),transparent 60%);
      opacity:0.8;
      pointer-events:none;
      z-index:-1;
    }

    .top-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:16px;
    }

    .event-block{
      display:flex;
      align-items:center;
      gap:10px;
    }

    .logo-orb{
      width:70px;
      height:70px;
      border-radius:999px;
      background:#000;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      box-shadow:0 12px 26px rgba(0,0,0,0.45);
      flex-shrink:0;
    }

    .logo-orb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    .event-main{
      font-size:18px;
      font-weight:700;
    }

    .event-sub{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.16em;
      color:var(--muted);
    }

    .status-chip{
      font-size:11px;
      padding:5px 10px;
      border-radius:999px;
      background:rgba(16,185,129,0.08);
      border:1px solid rgba(5,150,105,0.6);
      color:#047857;
      display:flex;
      align-items:center;
      gap:6px;
    }

    .status-dot{
      width:8px;
      height:8px;
      border-radius:999px;
      background:#10b981;
      box-shadow:0 0 10px rgba(16,185,129,0.9);
    }

    .winner-card{
      margin-top:4px;
      border-radius:var(--radius-lg);
      background:linear-gradient(135deg,#ffffff,#fef3c7);
      border:1px solid rgba(254,215,170,0.9);
      padding:18px 18px 16px;
      position:relative;
      overflow:hidden;
    }

    .winner-card::before{
      content:"";
      position:absolute;
      inset:-30%;
      background:
        radial-gradient(circle at 0 0,rgba(249,115,22,0.16),transparent 55%),
        radial-gradient(circle at 100% 100%,rgba(56,189,248,0.18),transparent 55%);
      opacity:0.7;
      pointer-events:none;
      z-index:-1;
    }

    .winner-header-line{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
    }

    .winner-label{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.18em;
      color:var(--muted);
    }

    .winner-chip{
      font-size:10px;
      padding:3px 8px;
      border-radius:999px;
      background:rgba(15,23,42,0.04);
      color:var(--muted);
      border:1px solid rgba(148,163,184,0.5);
    }

    .highlight-number{
      text-align:center;
      margin-top:6px;
      margin-bottom:4px;
    }

    .highlight-number span.label{
      display:block;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.22em;
      color:var(--muted);
      margin-bottom:2px;
    }

    .highlight-number div.value{
      font-size:42px;
      font-weight:800;
      letter-spacing:0.12em;
      color:#92400e;
      text-shadow:0 0 16px rgba(250,204,21,0.9);
    }

    /* While mixing, give a subtle pulse to the number area */
    .mixing .highlight-number div.value{
      animation:pulseWinner 700ms ease-in-out infinite;
    }

    @keyframes pulseWinner{
      0%{ transform:scale(1); text-shadow:0 0 10px rgba(250,204,21,0.55);}
      50%{ transform:scale(1.04); text-shadow:0 0 24px rgba(250,204,21,0.9);}
      100%{ transform:scale(1); text-shadow:0 0 10px rgba(250,204,21,0.55);}
    }

    .winner-name{
      text-align:center;
      font-size:16px;
      font-weight:600;
      margin-bottom:2px;
    }

    .winner-sub{
      text-align:center;
      font-size:12px;
      color:var(--muted);
      margin-bottom:8px;
    }

    .actions-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top:10px;
    }

    .btn-main{
      flex:1;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:9px 14px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-size:13px;
      font-weight:600;
      background:linear-gradient(135deg,#f97316,#fbbf24);
      color:#111827;
      box-shadow:0 12px 24px rgba(249,115,22,0.5);
      transition:transform 0.12s ease,box-shadow 0.12s ease,filter 0.12s ease;
    }
    .btn-main:hover:not(:disabled){
      transform:translateY(-1px);
      filter:brightness(1.03);
      box-shadow:0 16px 32px rgba(249,115,22,0.6);
    }
    .btn-main:disabled{
      opacity:0.7;
      cursor:default;
      transform:none;
      box-shadow:none;
    }

    .btn-secondary{
      font-size:11px;
      padding:7px 11px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.9);
      background:rgba(248,250,252,0.9);
      color:var(--muted);
      cursor:pointer;
    }

    .mix-strip{
      margin-top:12px;
      height:40px;
      border-radius:999px;
      background:linear-gradient(135deg,#f9fafb,#e5e7eb);
      border:1px solid rgba(209,213,219,0.9);
      overflow:hidden;
      display:flex;
      align-items:center;
      padding:0 10px;
      gap:6px;
      position:relative;
    }

    .mix-strip .ticket{
      flex:0 0 80px;
      height:26px;
      border-radius:999px;
      border:1px dashed rgba(148,163,184,0.9);
      background:#fefce8;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      color:#92400e;
      opacity:0.9;
    }

    /* Strong visible shaking / shuffling when .mixing is applied */
    .mixing .mix-strip .ticket{
      animation:mixTickets 0.35s ease-in-out infinite alternate;
    }

    @keyframes mixTickets{
      0%{
        transform:translateX(0) rotate(-2deg);
      }
      50%{
        transform:translateX(-10px) rotate(3deg);
      }
      100%{
        transform:translateX(10px) rotate(-3deg);
      }
    }

    .mix-hint{
      position:absolute;
      right:10px;
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:0.16em;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:4px;
    }

    .mix-dot{
      width:6px;
      height:6px;
      border-radius:999px;
      background:var(--accent);
      box-shadow:0 0 10px rgba(249,115,22,0.8);
    }

    .status-text{
      margin-top:8px;
      font-size:11px;
      color:var(--muted);
      text-align:left;
    }

    @media (max-width:640px){
      .frame{
        padding:18px 16px 16px;
        border-radius:24px;
      }
      .event-main{
        font-size:16px;
      }
      .highlight-number div.value{
        font-size:34px;
      }
    }
  </style>
</head>
<body>
<div class="frame" id="frame">
  <div class="top-row">
    <div class="event-block">
      <div class="logo-orb">
        <img
          src="https://firebasestorage.googleapis.com/v0/b/events-339ce.firebasestorage.app/o/lokamania%205%20logo.png?alt=media&token=49f14bf3-b113-4653-84a6-3857275ad410"
          alt="Lokamania 5 logo"
        />
      </div>
      <div>
        <div class="event-main" id="eventTitle">Lokamania 5</div>
        <div class="event-sub">Tombola live draw</div>
      </div>
    </div>
    <div class="status-chip">
      <span class="status-dot"></span>
      <span id="connectionLabel">Connecting to Firebase...</span>
    </div>
  </div>

  <div class="winner-card" id="winnerCard">
    <div class="winner-header-line">
      <div class="winner-label">Current winner</div>
      <div class="winner-chip" id="winnerChipText">No number selected yet</div>
    </div>

    <div class="highlight-number" id="winnerNumber">
      <span class="label">Tombola number</span>
      <div class="value">â€” â€” â€” â€”</div>
    </div>

    <div class="winner-name" id="winnerName">No winner yet</div>
    <div class="winner-sub" id="winnerSub">
      Press "Pick random winner" to start the tombola draw.
    </div>

    <div class="actions-row">
      <button class="btn-main" id="btnPick">
        ðŸŽŸ Pick random winner
      </button>
      <button class="btn-secondary" id="btnResetView" type="button">
        Reset view
      </button>
    </div>

    <div class="mix-strip">
      <div class="ticket">#1043</div>
      <div class="ticket">#1019</div>
      <div class="ticket">#1120</div>
      <div class="ticket">#1095</div>
      <div class="ticket">#1188</div>
      <div class="mix-hint">
        <span class="mix-dot"></span>
        <span id="mixHintText">Waiting for draw...</span>
      </div>
    </div>

    <div class="status-text" id="statusText">
      Show this screen on your TV/LED and press the button when youâ€™re ready to pick a winner.
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getDatabase,
    ref,
    get,
    update
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
  import {
    getAuth,
    signInAnonymously,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  // --------- EASY EDIT CONSTANTS ----------
  const EVENT_ID   = "lokamania5";
  const EVENT_NAME = "Lokamania 5";

  // OPTIONAL: MANUAL WINNER OVERRIDE
  // Set MANUAL_WINNER_ENABLED = true and put the raffleNumber you want to win.
  // (It must match the "raffleNumber" stored in registration entries in RTDB)
  const MANUAL_WINNER_ENABLED = true;
  const MANUAL_WINNER_RAFFLE = 1191; // e.g. 1234

  const firebaseConfig = {
    apiKey: "AIzaSyA80bAAGPuyscnTVS-zwrxE9Jp3tPiS1gM",
    authDomain: "events-339ce.firebaseapp.com",
    projectId: "events-339ce",
    storageBucket: "events-339ce.firebasestorage.app",
    messagingSenderId: "175601544315",
    appId: "1:175601544315:web:00c94b4affa972b3a286de",
    databaseURL: "https://events-339ce-default-rtdb.europe-west1.firebasedatabase.app"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  const registrationsRef = ref(db, "events/" + EVENT_ID + "/registrations");
  const rootRef = ref(db);

  const frameEl = document.getElementById("frame");
  const connectionLabel = document.getElementById("connectionLabel");
  const winnerNumberEl = document.getElementById("winnerNumber");
  const winnerNameEl = document.getElementById("winnerName");
  const winnerSubEl = document.getElementById("winnerSub");
  const winnerChipTextEl = document.getElementById("winnerChipText");
  const statusTextEl = document.getElementById("statusText");
  const mixHintTextEl = document.getElementById("mixHintText");
  const eventTitleEl = document.getElementById("eventTitle");

  const btnPick = document.getElementById("btnPick");
  const btnResetView = document.getElementById("btnResetView");

  eventTitleEl.textContent = EVENT_NAME;

  let picking = false;

  // --------- AUTH ----------
  signInAnonymously(auth).catch(function(err) {
    console.error("Anon auth error", err);
    connectionLabel.textContent = "Auth error â€“ check Firebase rules.";
  });

  onAuthStateChanged(auth, function(user) {
    if (user) {
      connectionLabel.textContent = "Connected Â· Ready to draw";
    }
  });

  // --------- PICK WINNER WITH 5s SHUFFLE ----------
  btnPick.addEventListener("click", async function() {
    if (picking) return;
    picking = true;
    btnPick.disabled = true;

    statusTextEl.textContent = "Fetching entries and mixing tombola tickets...";
    mixHintTextEl.textContent = "Mixing...";
    frameEl.classList.add("mixing");

    try {
      const snap = await get(registrationsRef);
      const data = snap.val() || {};
      const list = Object.entries(data).map(function(pair) {
        const id = pair[0];
        const val = pair[1];
        return Object.assign({ id: id }, val);
      });

      // Only entries that have not won yet
      const eligible = list.filter(function(r) {
        return !r.winner;
      });

      if (!eligible.length) {
        statusTextEl.textContent = "No available tombola entries. All registrations already have a winner flag.";
        mixHintTextEl.textContent = "No entries";
        frameEl.classList.remove("mixing");
        picking = false;
        btnPick.disabled = false;
        return;
      }

      // Decide winner (manual override or random) â€” USING raffleNumber ONLY
      let winner = null;

      if (MANUAL_WINNER_ENABLED && MANUAL_WINNER_RAFFLE != null) {
        const manualStr = String(MANUAL_WINNER_RAFFLE);
        winner = eligible.find(function(r) {
          const rNum = (typeof r.raffleNumber !== "undefined" && r.raffleNumber !== null) ? r.raffleNumber : null;
          if (rNum === null) return false;
          return String(rNum) === manualStr;
        });

        if (!winner) {
          console.warn("Manual raffleNumber not found among eligible entries, falling back to random.");
        }
      }

      // If no manual winner or not found, pick random
      if (!winner) {
        const idx = Math.floor(Math.random() * eligible.length);
        winner = eligible[idx];
      }

      const now = Date.now();

      // After 5 seconds of visible shake, apply DB update + show result
      setTimeout(async function() {
        try {
          const updates = {};
          updates["events/" + EVENT_ID + "/registrations/" + winner.id + "/winner"] = true;
          updates["events/" + EVENT_ID + "/registrations/" + winner.id + "/winnerPickedAt"] = now;
          updates["events/" + EVENT_ID + "/winners/" + winner.id] = {
            raffleNumber: (typeof winner.raffleNumber !== "undefined" ? winner.raffleNumber : null),
            name: winner.name || "",
            phone: winner.phone || "",
            createdAt: winner.createdAt || null,
            pickedAt: now
          };

          await update(rootRef, updates);

          const raffleNumber = (typeof winner.raffleNumber !== "undefined" && winner.raffleNumber !== null)
            ? winner.raffleNumber
            : "----";

          winnerNumberEl.innerHTML =
            '<span class="label">Tombola number</span>' +
            '<div class="value">#' + raffleNumber + '</div>';

          winnerNameEl.textContent = winner.name || "Unknown guest";
          winnerSubEl.textContent = "Announce this number and invite the guest to the registration desk.";
          winnerChipTextEl.textContent = "Winner: #" + raffleNumber;

          statusTextEl.textContent = "Winner selected. You can keep this on screen while the guest comes to claim the prize.";
          mixHintTextEl.textContent = "Winner locked";
        } catch (errInner) {
          console.error(errInner);
          statusTextEl.textContent = "Error while saving winner to Firebase. Check console / rules.";
          mixHintTextEl.textContent = "Error";
        } finally {
          frameEl.classList.remove("mixing");
          picking = false;
          btnPick.disabled = false;
        }
      }, 5000); // 5 seconds shuffle

    } catch (err) {
      console.error(err);
      statusTextEl.textContent = "Something went wrong while fetching entries. Check console / Firebase rules.";
      mixHintTextEl.textContent = "Error";
      frameEl.classList.remove("mixing");
      picking = false;
      btnPick.disabled = false;
    }
  });

  btnResetView.addEventListener("click", function() {
    winnerNumberEl.innerHTML =
      '<span class="label">Tombola number</span>' +
      '<div class="value">â€” â€” â€” â€”</div>';

    winnerNameEl.textContent = "No winner yet";
    winnerSubEl.textContent = "Press \"Pick random winner\" to start the tombola draw.";
    winnerChipTextEl.textContent = "No number selected yet";
    statusTextEl.textContent = "Show this screen on your TV/LED and press the button when youâ€™re ready to pick a winner.";
    mixHintTextEl.textContent = "Waiting for draw...";
    frameEl.classList.remove("mixing");
  });
</script>
</body>
</html>

