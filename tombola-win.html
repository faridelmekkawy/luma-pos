<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Lokamania 5 ‚Äî Tombola Winner</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#0f172a;
      --bg-soft:#020617;
      --panel:#020617;
      --panel-soft:#0b1220;
      --ink:#e5e7eb;
      --muted:#9ca3af;
      --accent:#f97316;
      --accent-alt:#22c55e;
      --accent-soft:#1f2937;
      --border:#1f2937;
      --radius-lg:22px;
      --shadow-lg:0 26px 60px rgba(0,0,0,0.7);
    }

    *{box-sizing:border-box;margin:0;padding:0;}

    body{
      font-family:"Montserrat",system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
      min-height:100vh;
      background:
        radial-gradient(circle at top left,rgba(249,115,22,0.25),transparent 55%),
        radial-gradient(circle at bottom right,rgba(34,197,94,0.25),transparent 55%),
        linear-gradient(135deg,#020617,#020617 40%,#000000);
      color:var(--ink);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
    }

    .frame{
      width:100%;
      max-width:980px;
      background:radial-gradient(circle at top,rgba(15,23,42,0.9),rgba(2,6,23,0.98));
      border-radius:32px;
      padding:22px 24px 24px;
      box-shadow:var(--shadow-lg);
      border:1px solid rgba(148,163,184,0.35);
      position:relative;
      overflow:hidden;
    }

    .frame::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:
        radial-gradient(circle at 10% 0,rgba(249,115,22,0.15),transparent 55%),
        radial-gradient(circle at 90% 100%,rgba(56,189,248,0.18),transparent 55%);
      opacity:0.8;
      pointer-events:none;
      z-index:-1;
    }

    .top-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:18px;
      gap:12px;
    }

    .badge-stack{
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .event-pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:5px 10px;
      border-radius:999px;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.14em;
      background:rgba(15,23,42,0.9);
      border:1px solid rgba(148,163,184,0.45);
      color:#e5e7eb;
    }

    .event-title{
      font-size:22px;
      font-weight:700;
      display:flex;
      align-items:center;
      gap:10px;
    }

    .event-sub{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.16em;
      color:var(--muted);
    }

    .logo-orb{
      width:42px;
      height:42px;
      border-radius:999px;
      background:
        conic-gradient(from 220deg,#f97316,#22c55e,#38bdf8,#f97316);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      font-size:18px;
      color:white;
      box-shadow:0 0 25px rgba(249,115,22,0.55);
    }

    .status-chip{
      font-size:11px;
      padding:5px 10px;
      border-radius:999px;
      background:rgba(34,197,94,0.12);
      color:#bbf7d0;
      border:1px solid rgba(34,197,94,0.6);
      display:flex;
      align-items:center;
      gap:6px;
    }

    .status-dot{
      width:8px;
      height:8px;
      border-radius:999px;
      background:#22c55e;
      box-shadow:0 0 12px rgba(34,197,94,0.9);
    }

    .layout{
      display:grid;
      grid-template-columns: minmax(0,2.2fr) minmax(0,1.3fr);
      gap:18px;
      align-items:stretch;
    }

    @media (max-width:900px){
      .layout{
        grid-template-columns:1fr;
      }
    }

    .winner-card{
      border-radius:var(--radius-lg);
      background:
        radial-gradient(circle at top,rgba(15,23,42,0.9),rgba(15,23,42,1));
      border:1px solid rgba(148,163,184,0.6);
      padding:18px 18px 20px;
      position:relative;
      overflow:hidden;
    }

    .winner-card::before{
      content:"";
      position:absolute;
      inset:-40px;
      background:
        radial-gradient(circle at 20% 0,rgba(250,250,250,0.08),transparent 55%),
        radial-gradient(circle at 80% 100%,rgba(251,191,36,0.08),transparent 55%);
      opacity:0.7;
      pointer-events:none;
      z-index:-1;
    }

    .winner-header-line{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
    }

    .winner-label{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.16em;
      color:#9ca3af;
    }

    .winner-small-chip{
      font-size:10px;
      padding:3px 7px;
      border-radius:999px;
      background:rgba(15,23,42,0.8);
      border:1px solid rgba(148,163,184,0.5);
      display:flex;
      align-items:center;
      gap:5px;
      color:#e5e7eb;
    }

    .highlight-number{
      font-size:46px;
      font-weight:800;
      letter-spacing:0.06em;
      text-align:center;
      margin-top:4px;
      margin-bottom:6px;
      color:#fef3c7;
      text-shadow:
        0 0 18px rgba(250,204,21,0.75),
        0 0 40px rgba(250,204,21,0.60);
    }

    .highlight-number span{
      font-size:16px;
      font-weight:600;
      letter-spacing:0.2em;
      text-transform:uppercase;
      color:#fed7aa;
      display:block;
      margin-bottom:3px;
    }

    .winner-name{
      text-align:center;
      font-size:16px;
      font-weight:600;
      margin-bottom:4px;
    }

    .winner-detail-sub{
      text-align:center;
      font-size:11px;
      color:var(--muted);
      margin-bottom:10px;
    }

    .grid-meta{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:8px;
      margin-bottom:12px;
      font-size:11px;
    }

    .meta-item{
      padding:7px 9px;
      border-radius:12px;
      background:rgba(15,23,42,0.85);
      border:1px solid rgba(55,65,81,0.9);
      display:flex;
      flex-direction:column;
      gap:3px;
    }

    .meta-label{
      text-transform:uppercase;
      letter-spacing:0.12em;
      color:var(--muted);
      font-size:10px;
    }

    .meta-value{
      font-size:12px;
      font-weight:500;
    }

    .actions-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top:6px;
    }

    .btn-main{
      flex:1;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:9px 12px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-size:12px;
      font-weight:600;
      background:linear-gradient(135deg,#f97316,#facc15);
      color:#0b1120;
      box-shadow:0 12px 26px rgba(249,115,22,0.55);
      transition:transform 0.12s ease,box-shadow 0.12s ease,filter 0.12s ease;
    }

    .btn-main:hover{
      transform:translateY(-1px);
      filter:brightness(1.03);
      box-shadow:0 16px 32px rgba(249,115,22,0.65);
    }

    .btn-main:disabled{
      opacity:0.6;
      cursor:default;
      transform:none;
      box-shadow:none;
    }

    .btn-secondary{
      font-size:11px;
      padding:7px 11px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:rgba(15,23,42,0.9);
      color:#e5e7eb;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    .mix-strip{
      margin-top:10px;
      height:40px;
      border-radius:999px;
      background:radial-gradient(circle at 50% 0,rgba(148,163,184,0.28),rgba(15,23,42,1));
      border:1px solid rgba(148,163,184,0.5);
      overflow:hidden;
      display:flex;
      align-items:center;
      padding:0 10px;
      gap:6px;
      position:relative;
    }

    .mix-strip .ticket{
      flex:0 0 80px;
      height:26px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.6);
      background:rgba(15,23,42,0.92);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:11px;
      color:#e5e7eb;
      opacity:0.7;
    }

    .mixing .mix-strip .ticket{
      animation:mixTickets 600ms linear infinite;
    }

    @keyframes mixTickets{
      0%{ transform:translateX(0); opacity:0.9;}
      50%{ transform:translateX(-18px); opacity:0.5;}
      100%{ transform:translateX(0); opacity:0.9;}
    }

    .mix-hint{
      position:absolute;
      right:10px;
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:0.16em;
      color:#9ca3af;
      display:flex;
      align-items:center;
      gap:4px;
    }

    .mix-dot{
      width:6px;
      height:6px;
      border-radius:999px;
      background:#f97316;
      box-shadow:0 0 10px rgba(249,115,22,0.8);
    }

    /* Right column: winners history + info */
    .side-panel{
      border-radius:var(--radius-lg);
      background:rgba(15,23,42,0.92);
      border:1px solid rgba(55,65,81,0.9);
      padding:14px 14px 13px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .side-title{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.16em;
      color:var(--muted);
      margin-bottom:2px;
    }

    .side-note{
      font-size:11px;
      color:var(--muted);
    }

    .winners-list{
      margin-top:6px;
      max-height:190px;
      overflow:auto;
      border-radius:14px;
      border:1px solid rgba(55,65,81,0.8);
      background:rgba(15,23,42,0.9);
    }

    .winner-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:7px 9px;
      font-size:11px;
      border-bottom:1px solid rgba(31,41,55,0.9);
    }
    .winner-row:last-child{
      border-bottom:none;
    }
    .winner-row-main{
      display:flex;
      flex-direction:column;
      gap:1px;
    }
    .winner-row-title{
      font-weight:500;
      font-size:11px;
    }
    .winner-row-sub{
      font-size:10px;
      color:var(--muted);
    }
    .winner-row-pill{
      font-size:10px;
      padding:3px 7px;
      border-radius:999px;
      background:rgba(30,64,175,0.3);
      border:1px solid rgba(129,140,248,0.6);
      color:#e5e7eb;
    }

    .status-text{
      font-size:11px;
      color:var(--muted);
      margin-top:5px;
    }

    .status-text strong{
      color:#bfdbfe;
    }

    .small-link{
      font-size:10px;
      color:#93c5fd;
      text-decoration:underline;
      cursor:pointer;
    }

    .no-winners{
      padding:8px;
      font-size:11px;
      color:var(--muted);
      text-align:center;
    }

  </style>
</head>
<body>
<div class="frame" id="frame">
  <div class="top-row">
    <div class="badge-stack">
      <div class="event-pill">
        <span>Lokamania 5</span>
        <span style="width:4px;height:4px;border-radius:999px;background:#f97316;"></span>
        <span>Tombola live draw</span>
      </div>
      <div class="event-title">
        <div class="logo-orb">L</div>
        <div>
          <div>Grand Tombola Winner</div>
          <div class="event-sub">Randomly selected from event registrations</div>
        </div>
      </div>
    </div>
    <div class="status-chip" id="connectionChip">
      <span class="status-dot"></span>
      <span id="connectionLabel">Connecting to Firebase‚Ä¶</span>
    </div>
  </div>

  <div class="layout">
    <!-- LEFT: main winner area -->
    <div class="winner-card" id="winnerCard">
      <div class="winner-header-line">
        <div>
          <div class="winner-label">Current winner</div>
        </div>
        <div class="winner-small-chip">
          <span style="width:8px;height:8px;border-radius:999px;background:#f97316;"></span>
          <span id="winnerChipText">No number selected yet</span>
        </div>
      </div>

      <div class="highlight-number" id="winnerNumber">
        <span>TOMBOLA</span>
        ‚Äî ‚Äî ‚Äî ‚Äî
      </div>

      <div class="winner-name" id="winnerName">No winner yet</div>
      <div class="winner-detail-sub" id="winnerSub">
        Press ‚ÄúPick random winner‚Äù to start the live draw.
      </div>

      <div class="grid-meta">
        <div class="meta-item">
          <div class="meta-label">Phone</div>
          <div class="meta-value" id="metaPhone">‚Äî</div>
        </div>
        <div class="meta-item">
          <div class="meta-label">City</div>
          <div class="meta-value" id="metaCity">‚Äî</div>
        </div>
        <div class="meta-item">
          <div class="meta-label">Age group</div>
          <div class="meta-value" id="metaAge">‚Äî</div>
        </div>
        <div class="meta-item">
          <div class="meta-label">First time?</div>
          <div class="meta-value" id="metaFirstTime">‚Äî</div>
        </div>
      </div>

      <div class="actions-row">
        <button class="btn-main" id="btnPick">
          <span>üéü Pick random winner</span>
        </button>
        <button class="btn-secondary" id="btnResetView" type="button">
          Clear view
        </button>
      </div>

      <div class="mix-strip">
        <div class="ticket">#1043</div>
        <div class="ticket">#1019</div>
        <div class="ticket">#1120</div>
        <div class="ticket">#1095</div>
        <div class="ticket">#1188</div>
        <div class="mix-hint">
          <span class="mix-dot"></span>
          <span id="mixHintText">Waiting for draw‚Ä¶</span>
        </div>
      </div>

      <div class="status-text" id="statusText">
        Make sure this page is visible on the LED / TV when you press ‚ÄúPick random winner‚Äù.
      </div>
    </div>

    <!-- RIGHT: winners history + info -->
    <div class="side-panel">
      <div>
        <div class="side-title">Winners history</div>
        <div class="side-note">
          Every time you pick a winner, they are marked in the database to avoid duplicates.
        </div>
      </div>

      <div class="winners-list" id="winnersList">
        <div class="no-winners">No winners yet for this event.</div>
      </div>

      <div class="status-text" id="metaStatus">
        Using registrations from <strong>events/lokamania5/registrations</strong>.
      </div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getDatabase,
    ref,
    get,
    onValue,
    update
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
  import {
    getAuth,
    signInAnonymously,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA80bAAGPuyscnTVS-zwrxE9Jp3tPiS1gM",
    authDomain: "events-339ce.firebaseapp.com",
    projectId: "events-339ce",
    storageBucket: "events-339ce.firebasestorage.app",
    messagingSenderId: "175601544315",
    appId: "1:175601544315:web:00c94b4affa972b3a286de",
    databaseURL: "https://events-339ce-default-rtdb.europe-west1.firebasedatabase.app"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  const EVENT_ID = "lokamania5";
  const registrationsRef = ref(db, `events/${EVENT_ID}/registrations`);
  const winnersRef = ref(db, `events/${EVENT_ID}/winners`);
  const rootRef = ref(db);

  const frameEl = document.getElementById("frame");
  const connectionChip = document.getElementById("connectionChip");
  const connectionLabel = document.getElementById("connectionLabel");

  const winnerNumberEl = document.getElementById("winnerNumber");
  const winnerNameEl = document.getElementById("winnerName");
  const winnerSubEl = document.getElementById("winnerSub");
  const winnerChipTextEl = document.getElementById("winnerChipText");
  const metaPhoneEl = document.getElementById("metaPhone");
  const metaCityEl = document.getElementById("metaCity");
  const metaAgeEl = document.getElementById("metaAge");
  const metaFirstTimeEl = document.getElementById("metaFirstTime");
  const statusTextEl = document.getElementById("statusText");
  const mixHintTextEl = document.getElementById("mixHintText");
  const winnersListEl = document.getElementById("winnersList");
  const metaStatusEl = document.getElementById("metaStatus");

  const btnPick = document.getElementById("btnPick");
  const btnResetView = document.getElementById("btnResetView");

  let registrationsCache = [];
  let picking = false;

  // ------------- AUTH -------------
  signInAnonymously(auth).catch(err => {
    console.error("Anon auth error", err);
    connectionLabel.textContent = "Auth error ‚Äì check Firebase rules.";
    connectionChip.style.background = "rgba(127,29,29,0.5)";
  });

  onAuthStateChanged(auth, (user) => {
    if(user){
      connectionLabel.textContent = "Connected ¬∑ Ready to draw";
      subscribeRegistrations();
      subscribeWinners();
    }
  });

  // ------------- SUBSCRIPTIONS -------------

  function subscribeRegistrations(){
    onValue(registrationsRef, (snap) => {
      const data = snap.val() || {};
      const list = Object.entries(data).map(([id,val]) => ({ id, ...val }));
      registrationsCache = list;
      metaStatusEl.innerHTML = `Loaded <strong>${list.length}</strong> registrations for this event.`;
    }, err => {
      console.error(err);
      metaStatusEl.textContent = "Error reading registrations. Check rules / path.";
    });
  }

  function subscribeWinners(){
    onValue(winnersRef, (snap) => {
      const data = snap.val() || {};
      renderWinnersList(data);
    }, err => {
      console.error(err);
    });
  }

  function renderWinnersList(winnersObj){
    winnersListEl.innerHTML = "";
    const entries = Object.entries(winnersObj).map(([id,val]) => ({ id, ...val }));
    if(!entries.length){
      winnersListEl.innerHTML = `<div class="no-winners">No winners yet for this event.</div>`;
      return;
    }

    // newest first
    entries.sort((a,b) => (b.pickedAt || 0) - (a.pickedAt || 0));

    entries.forEach(w => {
      const row = document.createElement("div");
      row.className = "winner-row";
      const pickedDate = w.pickedAt ? new Date(w.pickedAt).toLocaleTimeString() : "‚Äî";
      row.innerHTML = `
        <div class="winner-row-main">
          <div class="winner-row-title">${w.name || "Unknown guest"}</div>
          <div class="winner-row-sub">
            #${w.tambolaNumber ?? "‚Äì"} ¬∑ ${w.phone || ""} ¬∑ ${pickedDate}
          </div>
        </div>
        <div class="winner-row-pill">Winner</div>
      `;
      winnersListEl.appendChild(row);
    });
  }

  // ------------- PICK WINNER -------------

  btnPick.addEventListener("click", async () => {
    if(picking) return;
    picking = true;
    btnPick.disabled = true;
    frameEl.classList.add("mixing");

    statusTextEl.textContent = "Mixing tombola tickets and choosing a random winner‚Ä¶";
    mixHintTextEl.textContent = "Mixing‚Ä¶";

    try{
      // Always fetch latest from DB in case other devices updated winners
      const snap = await get(registrationsRef);
      const data = snap.val() || {};
      const list = Object.entries(data).map(([id,val]) => ({ id, ...val }));

      // Filter to registrations that are not winners yet
      const eligible = list.filter(r => !r.winner);
      if(!eligible.length){
        statusTextEl.textContent = "No more available tombola entries to pick. All registrations already have winners.";
        mixHintTextEl.textContent = "No entries";
        frameEl.classList.remove("mixing");
        picking = false;
        btnPick.disabled = false;
        return;
      }

      // Random pick
      const idx = Math.floor(Math.random() * eligible.length);
      const winner = eligible[idx];
      const now = Date.now();

      // Multi-path update: mark winner on registration + save in winners list
      const updates = {};
      updates[`events/${EVENT_ID}/registrations/${winner.id}/winner`] = true;
      updates[`events/${EVENT_ID}/registrations/${winner.id}/winnerPickedAt`] = now;
      updates[`events/${EVENT_ID}/winners/${winner.id}`] = {
        tambolaNumber: winner.tambolaNumber ?? null,
        name: winner.name || "",
        phone: winner.phone || "",
        city: winner.city || "",
        ageGroup: winner.ageGroup || "",
        firstTime: typeof winner.firstTime !== "undefined" ? winner.firstTime : (winner.isFirstTime ?? null),
        createdAt: winner.createdAt || null,
        pickedAt: now
      };

      await update(rootRef, updates);

      // Display on screen
      const tombolaNumber = winner.tambolaNumber ?? "‚Äî ‚Äî ‚Äî ‚Äî";

      winnerNumberEl.innerHTML = `
        <span>TOMBOLA</span>
        ${tombolaNumber}
      `;
      winnerNameEl.textContent = winner.name || "Unknown guest";
      const shortPhone = winner.phone ? String(winner.phone) : "";
      winnerSubEl.textContent = shortPhone
        ? `Winner phone: ${shortPhone}`
        : `Winner selected from valid tombola entries.`;

      metaPhoneEl.textContent = shortPhone || "‚Äî";
      metaCityEl.textContent = winner.city || "‚Äî";
      metaAgeEl.textContent = winner.ageGroup || "‚Äî";

      const ft = (typeof winner.firstTime !== "undefined") ? winner.firstTime : winner.isFirstTime;
      if(ft === true) metaFirstTimeEl.textContent = "Yes ¬∑ First time in Lokamania";
      else if(ft === false) metaFirstTimeEl.textContent = "No ¬∑ Returning visitor";
      else metaFirstTimeEl.textContent = "‚Äî";

      winnerChipTextEl.textContent = `Winner: #${tombolaNumber}`;
      statusTextEl.textContent = "Winner selected. Announce the number and invite them to the registration desk.";
      mixHintTextEl.textContent = "Winner locked";

      // stop animation after a short delay
      setTimeout(() => {
        frameEl.classList.remove("mixing");
      }, 600);

    }catch(err){
      console.error(err);
      statusTextEl.textContent = "Something went wrong while picking a winner. Check console / Firebase rules.";
      mixHintTextEl.textContent = "Error";
      frameEl.classList.remove("mixing");
    }

    picking = false;
    btnPick.disabled = false;
  });

  btnResetView.addEventListener("click", () => {
    winnerNumberEl.innerHTML = `<span>TOMBOLA</span>‚Äî ‚Äî ‚Äî ‚Äî`;
    winnerNameEl.textContent = "No winner yet";
    winnerSubEl.textContent = "Press ‚ÄúPick random winner‚Äù to start the live draw.";
    winnerChipTextEl.textContent = "No number selected yet";

    metaPhoneEl.textContent = "‚Äî";
    metaCityEl.textContent = "‚Äî";
    metaAgeEl.textContent = "‚Äî";
    metaFirstTimeEl.textContent = "‚Äî";

    statusTextEl.textContent = "Make sure this page is visible on the LED / TV when you press ‚ÄúPick random winner‚Äù.";
    mixHintTextEl.textContent = "Waiting for draw‚Ä¶";
  });
</script>
</body>
</html>
